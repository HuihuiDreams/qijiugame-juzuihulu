<!--
/**
 * @license
 * Copyright (C) 2026 [å²³æ¸…æºæ²ˆæ¸…ç§‹ç»“å©šæ¨è¿›åä¼š]. All Rights Reserved.
 * * ã€ç‰ˆæƒå£°æ˜ä¸ä½¿ç”¨è®¸å¯ã€‘
 * 1. æœ¬ä½œå“ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºä»£ç æ¶æ„ã€è„šæœ¬é€»è¾‘ã€ç¾æœ¯èµ„æºã€å‰§æœ¬æ–‡å­—ï¼‰ç‰ˆæƒå½’åˆ¶ä½œç»„æ‰€æœ‰ã€‚
 * 2. ä¸¥ç¦ä»»ä½•å½¢å¼çš„æœªç»æˆæƒçš„äºŒæ¬¡åˆ†å‘ã€ä¿®æ”¹ã€åç¼–è¯‘æˆ–æ‹†åŒ…è¡Œä¸ºã€‚
 * 3. æœ¬é¡¹ç›®ä»£ç å…·æœ‰å¼ºçƒˆçš„åŸåˆ›æ€§ä¸ç‰¹å®šè§’è‰²æŒ‡å‘æ€§ï¼ˆå²³æ¸…æºÃ—æ²ˆæ¸…ç§‹ï¼ˆåŸä¸»æ²ˆä¹ï¼Œéæ²ˆå£ï¼‰ï¼‰ï¼Œ
 * ä¸¥ç¦å°†å…¶ç”¨äºå…¶ä»–è§’è‰²é…å¯¹ï¼ˆCPï¼‰æˆ–å•†ä¸šç”¨é€”ã€‚
 * 4. ä»»ä½•æœªç»è®¸å¯çš„ç›—ç”¨è¡Œä¸ºï¼Œåˆ¶ä½œç»„ä¿ç•™è¿½ç©¶å…¶æ³•å¾‹è´£ä»»åŠå…¬å¼€ç»´æƒçš„æƒåˆ©ã€‚
 * * Project: [é”¯å˜´è‘«èŠ¦]
 * Developers: @è®¾å®š(åŸä½œ), @ç°ç°(ç¨‹åº/è„šæœ¬), @æ•°æ®(ç¾æœ¯)
 */
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">

    <!-- Content Security Policy - å®‰å…¨ç­–ç•¥é…ç½® -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://esm.sh;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.loli.net;
        img-src 'self' data: blob:;
        font-src 'self' https://fonts.loli.net https://gstatic.loli.net data:;
        connect-src 'self' https://fonts.loli.net https://gstatic.loli.net;
        media-src 'self' blob:;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
    ">

    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é”¯å˜´è‘«èŠ¦</title>
    <meta name="description" content="é”¯å˜´è‘«èŠ¦ - å²³æ¸…æºÃ—æ²ˆæ¸…ç§‹åŒäººè§†è§‰å°è¯´ã€‚">
    <meta name="keywords" content="è§†è§‰å°è¯´,ä¿®ä»™,å²³æ¸…æº,æ²ˆæ¸…ç§‹,é”¯å˜´è‘«èŠ¦,åŒäºº">
    <meta name="author" content="å²³æ¸…æºæ²ˆæ¸…ç§‹ç»“å©šæ¨è¿›åä¼š">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./start_screen.png">
    <link rel="apple-touch-icon" href="./start_screen.png">

    <!-- Social Media Sharing (WeChat, QQ, Weibo, etc.) -->
    <!-- å›½å†…ä¸»æµç¤¾äº¤å¹³å°é€šç”¨ (åŸºäº Open Graph æ ‡å‡†) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/HuihuiDreams/qijiugame-juzuihulu">
    <meta property="og:title" content="é”¯å˜´è‘«èŠ¦ | å²³æ¸…æºÃ—æ²ˆæ¸…ç§‹åŒäººè§†è§‰å°è¯´">
    <meta property="og:description" content="å²³æ¸…æºÃ—æ²ˆæ¸…ç§‹åŒäººè§†è§‰å°è¯´â€”â€” åŒ…å«å¤šç»“å±€ä¸éšè—å½©è›‹çš„ä¿®ä»™åŒäººAVGã€‚ç‚¹å‡»å³ç©ï¼Œæ— éœ€ä¸‹è½½ã€‚">
    <meta property="og:image" content="./start_screen.png">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:site_name" content="é”¯å˜´è‘«èŠ¦">

    <!-- å¾®åš/é€šç”¨å¤§å›¾å¡ç‰‡æ”¯æŒ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="./start_screen.png">

    <!-- Additional SEO -->
    <meta name="theme-color" content="#0d0d1a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é”¯å˜´è‘«èŠ¦">
    <!-- Tailwind CSS - ç‰ˆæœ¬é”å®šä¸º 3.4.1 -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        /* å­—ä½“å¯¼å…¥ - ä½¿ç”¨ fonts.loli.netï¼ˆGoogle Fonts é•œåƒï¼‰ */
        @import url('https://fonts.loli.net/css2?family=Inter:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #0d0d1a;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-sc {
            font-family: 'Noto Serif SC', 'STSong', 'SimSun', serif;
        }

        .font-calligraphy {
            font-family: 'Ma Shan Zheng', 'KaiTi', 'STKaiti', cursive;
        }

        /* åŠ¨ç”»ä¸ç‰¹æ•ˆ */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 500ms ease-in;
        }

        .fade-exit {
            opacity: 1;
        }

        /* --- New Visual Effects --- */
        /* Silver Energy Stream */
        .energy-stream {
            position: absolute;
            width: 3px;
            background: linear-gradient(to top, transparent, #e0e0e0, transparent);
            opacity: 0;
            bottom: -20%;
            filter: drop-shadow(0 0 5px white);
            pointer-events: none;
        }

        @keyframes energy-flow {
            0% {
                transform: translateY(0) scaleY(0.2);
                opacity: 0;
            }

            20% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-120vh) scaleY(1.2);
                opacity: 0;
            }
        }

        /* White Radial Flash (Blinding Sunlight Effect) */
        .heavenly-beam {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.9) 15%, rgba(255, 255, 255, 0.6) 35%, rgba(255, 255, 255, 0.3) 55%, transparent 80%);
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 15;
            pointer-events: none;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }

        .dialogue-glass {
            background: rgba(13, 13, 26, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid rgba(103, 232, 249, 0.3);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        }

        /* æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(103, 232, 249, 0.3);
            border-radius: 4px;
        }

        /* è§’è‰²ç«‹ç»˜ä½ç½®è°ƒæ•´ */
        .char-sprite {
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3));
        }

        /* Character Entrance Animation */
        @keyframes char-slide-up {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .char-enter-anim {
            animation: char-slide-up 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        /* Button Bloom & Hover Effects */
        .btn-bloom {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background-clip: padding-box;
            z-index: 10;
        }

        .btn-bloom:hover {
            text-shadow: 0 0 8px rgba(103, 232, 249, 0.8);
            transform: translateY(-1px);
        }

        /* Bloom Circle Effect */
        .btn-bloom:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(103, 232, 249, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease-out, height 0.4s ease-out;
            z-index: -1;
            pointer-events: none;
        }

        .btn-bloom:hover:after {
            width: 200%;
            height: 200%;
        }

        .btn-bloom svg {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-bloom:hover svg {
            transform: scale(1.15);
            filter: drop-shadow(0 0 4px rgba(103, 232, 249, 0.6));
        }

        /* å±å¹•éœ‡åŠ¨åŠ¨ç”» */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0) translateY(0);
            }

            10% {
                transform: translateX(-8px) translateY(-2px) rotate(-0.5deg);
            }

            20% {
                transform: translateX(8px) translateY(2px) rotate(0.5deg);
            }

            30% {
                transform: translateX(-6px) translateY(-1px) rotate(-0.3deg);
            }

            40% {
                transform: translateX(6px) translateY(1px) rotate(0.3deg);
            }

            50% {
                transform: translateX(-4px) translateY(-1px) rotate(-0.2deg);
            }

            60% {
                transform: translateX(4px) translateY(1px) rotate(0.2deg);
            }

            70% {
                transform: translateX(-2px) translateY(0) rotate(-0.1deg);
            }

            80% {
                transform: translateX(2px) translateY(0) rotate(0.1deg);
            }

            90% {
                transform: translateX(-1px) translateY(0);
            }
        }

        .screen-shake {
            animation: shake 0.6s ease-in-out;
        }

        /* æœ‰èŠ‚å¥çš„æŒç»­éœ‡åŠ¨åŠ¨ç”» */
        @keyframes rhythm-shake {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(3px);
            }
        }

        .screen-rhythm {
            animation: rhythm-shake 0.5s ease-in-out infinite;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç¡®ä¿å…¨å± */
        #app-root {
            height: 100vh;
            /* fallback */
            height: 100dvh;
        }

        /* æ‰‹æœºæ¨ªå±ä¸“ç”¨æ ·å¼ - å…¨å±€ä½œç”¨åŸŸ */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-landscape-title {
                font-size: 1.8rem !important;
                line-height: 1.2 !important;
            }

            .mobile-landscape-btn {
                padding-top: 0.3rem !important;
                padding-bottom: 0.3rem !important;
                font-size: 1rem !important;
            }

            .mobile-landscape-gap {
                gap: 0.5rem !important;
                margin-top: 0.5rem !important;
            }

            /* Ending Screen ç‰¹å®šæ ·å¼ - ä½¿ç”¨ç»å¯¹å®šä½å¸ƒå±€é¿å…å¼¹æ€§ç›’å¡Œé™· */
            .ending-title-mobile-landscape {
                position: absolute !important;
                top: 0.5rem !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                font-size: 1.2rem !important;
                line-height: 1.1 !important;
                z-index: 10 !important;
            }

            .ending-text-mobile-landscape {
                position: absolute !important;
                top: 3rem !important;
                bottom: 3rem !important;
                left: 5% !important;
                width: 90% !important;
                margin: 0 !important;
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
                line-height: 1.5 !important;
                overflow-y: auto !important;
                max-height: none !important;
                flex-grow: 0 !important;
                height: auto !important;
                background: transparent !important;
                /* é€æ˜èƒŒæ™¯ */
                border: none !important;
                /* å»é™¤è¾¹æ¡† */
                z-index: 10 !important;
                display: flex !important;
                align-items: center !important;
                /* å‚ç›´å±…ä¸­ */
                justify-content: center !important;
                text-align: left !important;
                /* æ°´å¹³å·¦å¯¹é½ */
            }

            .ending-btn-mobile-landscape {
                position: absolute !important;
                bottom: 0.5rem !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                margin: 0 !important;
                font-size: 0.75rem !important;
                padding: 0.25rem 1.5rem !important;
                z-index: 10 !important;
                white-space: nowrap !important;
            }

            .ending-container-mobile-landscape {
                display: block !important;
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                justify-content: unset !important;
                align-items: unset !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå¯¹è¯æ¡†è¿›ä¸€æ­¥å‹ç¼© */
            .dialogue-glass {
                height: 4.8rem !important;
                /* Slightly increased height */
                padding: 0.4rem 0.6rem !important;
                /* Increased padding */
            }

            .dialogue-glass>div:first-child {
                padding-top: 0 !important;
            }

            .dialogue-glass p {
                font-size: 0.8rem !important;
                line-height: 1.3 !important;
                margin-top: -0.1rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šéšè—èœå•æ–‡å­— */
            .menu-label {
                display: none !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šéŸ³é‡æŒ‰é’®ä½ç½®è°ƒæ•´ */
            .volume-btn-mobile {
                top: 0.2rem !important;
                right: 0.2rem !important;
                padding: 0.25rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå¿«æ·èœå•ä½ç½®è°ƒæ•´ */
            .mobile-landscape-bottom-adjust {
                bottom: 5rem !important;
                right: 0.5rem !important;
                gap: 0.5rem !important;
            }

            /* æ‰‹æœºæ¨ªå±ï¼šå­˜æ¡£ç•Œé¢å¼ºåˆ¶2åˆ— */
            .mobile-landscape-grid-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }

        /* ğŸš« é˜²ç›—å¢å¼ºï¼šç¦æ­¢å›¾ç‰‡æ‹–æ‹½å’Œé•¿æŒ‰ */
        img {
            pointer-events: none;
            /* è®©ç‚¹å‡»ç©¿é€è‡³çˆ¶å®¹å™¨ï¼Œé˜²æ­¢é•¿æŒ‰å•ç‹¬é€‰ä¸­å›¾ç‰‡ */
            -webkit-user-drag: none;
            /* ç¦æ­¢æ‹–æ‹½ */
            user-select: none;
            -webkit-touch-callout: none;
            /* ç¦æ­¢iOSé•¿æŒ‰èœå• */
        }

        /* å…¨å±€ç¦æ­¢ç§»åŠ¨ç«¯é•¿æŒ‰ç³»ç»Ÿèœå• */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            /* å…¨å±€ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œå¢å¼ºä¿æŠ¤ï¼‰ */
            user-select: none;
        }
    </style>
    <style>
        /* --- IMMERSIVE CHOICE MODAL STYLES --- */
        .choice-btn-container {
            perspective: 1000px;
        }

        .choice-btn {
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Ink Stroke Hover Effect */
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuArNkqeFjTVpNHRfJCcrJYo-JRQ6Dq01apUkXTRglFkDzYo6lglc0MlIvZeYTlvpUMAjdlOjUTrdJTszx1fjxbYRxjal4fteOox3-ujO744cWGht7Cz4MssVwCo7F1kjgjqS7Aeb_JRkGecwppamXRIokQvvGis5wEyAQji4rmI1wj7zd-2r5dE1R-HtBAlyv5uuxLkjjgCe_P0O3tfl49hZrtp50hrU5Dmy6dDpSVbM1xQdMt0Hjeu21b8-cHEVdCnGT0pitlXon4');
            background-size: cover;
            background-position: center;
            opacity: 0;
            transform: translate(-50%, -50%) scaleX(0);
            transition: all 0.4s ease-out;
            pointer-events: none;
            mix-blend-mode: multiply;
            filter: contrast(1.2) sepia(0.5) hue-rotate(-10deg);
            z-index: -1;
        }

        .choice-btn:hover::before {
            opacity: 0.15;
            transform: translate(-50%, -50%) scaleX(1);
        }

        .choice-btn:hover {
            transform: translateX(10px);
            padding-left: 2rem;
        }

        /* Staggered Fade In Animation */
        @keyframes fadeInUpStagger {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Choice Modal Mobile Landscape Fixes --- */
        @media (max-height: 500px) and (orientation: landscape) {

            /* Wrapper: Flex column starting from top with scroll */
            #screen-choice {
                display: flex !important;
                flex-direction: column !important;
                justify-content: flex-start !important;
                align-items: center !important;
                overflow-y: auto !important;
                padding-top: 1.5rem !important;
                /* Top spacing */
                padding-bottom: 2rem !important;
            }

            /* Container: Let it grow naturally */
            #screen-choice .choice-btn-container {
                height: auto !important;
                min-height: 0 !important;
                padding: 1rem 3rem !important;
                /* Horizontal padding */
                justify-content: flex-start !important;
                overflow: visible !important;
                /* parent handles scroll */
                gap: 0.8rem !important;
            }

            #screen-choice h2 {
                /* Prompt */
                font-size: 1.1rem !important;
                line-height: 1.3 !important;
                margin-bottom: 0.5rem !important;
                margin-top: 0 !important;
            }

            #screen-choice .choice-btn {
                padding: 0.4rem 1rem !important;
                min-height: 2.8rem;
            }

            #screen-choice .choice-btn span {
                font-size: 0.8rem !important;
            }

            /* Hide decorative elements */
            #screen-choice .w-px,
            #screen-choice .w-12,
            #screen-choice .material-symbols-outlined {
                display: none !important;
            }
        }
    </style>
</head>

<body class="text-slate-100 overflow-hidden">
    <div id="app-root"></div>



    <!-- Code Protection & Copyright Warnings -->
    <script>
        (function () {
            // ä»…åœ¨éæœ¬åœ°ç¯å¢ƒå¯ç”¨ä¿æŠ¤ï¼Œä»¥å…å½±å“å¼€å‘è°ƒè¯•
            // If you want to test this locally, comment out the check below
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            // Console Warning (Always show copyright)
            const K = ' [å²³æ¸…æºæ²ˆæ¸…ç§‹ç»“å©šæ¨è¿›åä¼š] ';
            const styleTitle = 'color: #ef4444; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-family: "Noto Serif SC", serif;';
            const styleBody = 'color: #94a3b8; font-size: 14px; line-height: 1.5; font-family: sans-serif;';
            const styleCopy = 'color: #67e8f9; font-size: 12px; font-style: italic;';

            console.log(`%cğŸ›‘ è­¦å‘Šï¼STOP!`, styleTitle);
            console.log(`%cæ­¤åŒºåŸŸä¸“ä¸ºå¼€å‘è€…è°ƒè¯•ä½¿ç”¨ã€‚å¦‚æœæ‚¨è¢«å‘ŠçŸ¥åœ¨æ­¤å¤„ç²˜è´´ä»»ä½•ä»£ç ä»¥â€œè§£é”éšè—ç»“å±€â€æˆ–â€œè·å¾—ç‰¹æ®Šé“å…·â€ï¼Œé‚£æ˜¯ä¸€ä¸ªéª—å±€ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„å­˜æ¡£ä¸¢å¤±æˆ–æ•°æ®æ³„éœ²ã€‚`, styleBody);
            console.log(`%c\næœ¬ä½œå“ä»£ç åŠå‰§æœ¬ç‰ˆæƒå½’${K}æ‰€æœ‰ã€‚\nä¸¥ç¦ä»»ä½•å½¢å¼çš„æœªç»æˆæƒçš„æ¬è¿ã€ä¿®æ”¹æˆ–å•†ä¸šä½¿ç”¨ã€‚\n\nCopyright (C) 2026${K}. All Rights Reserved.`, styleCopy);

            // UX Deterrents (Skip on localhost)
            if (isLocal) {
                console.log('%cğŸ›¡ï¸ å¼€å‘æ¨¡å¼ï¼šå·²è‡ªåŠ¨ç¦ç”¨é˜²å¤åˆ¶/é˜²è°ƒè¯•ä¿æŠ¤', 'color: #4ade80; font-weight: bold;');
                return;
            }

            // 1. Disable Context Menu (Right Click)
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                return false;
            });

            // 2. Disable Keyboard Shortcuts
            document.addEventListener('keydown', e => {
                // F12
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+Shift+C (DevTools)
                if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+S (Save Page)
                if (e.ctrlKey && (e.key === 'S' || e.key === 's')) {
                    e.preventDefault();
                    return false;
                }
            });

            // 3. Disable Drag/Select (Optional, enforced by CSS user-select: none usually)
            document.addEventListener('dragstart', e => e.preventDefault());
        })();
    </script>

    <!-- ä½¿ç”¨ ES Modules ç›´æ¥åŠ è½½ Preact å’Œ htm -->
    <script type="module">


        // ä½¿ç”¨ esm.sh ç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§å’Œæ­£ç¡®çš„ ESM å¯¼å‡º
        import { h, render, createContext } from 'https://esm.sh/preact@10.19.3';
        import { useState, useEffect, useRef, useMemo, useContext } from 'https://esm.sh/preact@10.19.3/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';

        const html = htm.bind(h);

        // --- å…¨å±€é”™è¯¯å¤„ç† ---
        // æ•è·åŒæ­¥JavaScripté”™è¯¯
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ å…¨å±€é”™è¯¯æ•è·:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });

            // é˜²æ­¢é»˜è®¤çš„æ§åˆ¶å°é”™è¯¯è¾“å‡ºï¼ˆå¯é€‰ï¼‰
            // event.preventDefault();

            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
            // showAlert('æŠ±æ­‰ï¼Œæ¸¸æˆé‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        });

        // æ•è·æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', {
                reason: event.reason,
                promise: event.promise
            });

            // é˜²æ­¢é»˜è®¤çš„æ§åˆ¶å°è­¦å‘Š
            // event.preventDefault();

            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
            // showAlert('æŠ±æ­‰ï¼ŒåŠ è½½èµ„æºæ—¶å‡ºç°é—®é¢˜ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢ã€‚');
        });


        // --- Storage å·¥å…·æ¨¡å— (å®‰å…¨çš„ localStorage å°è£…) ---
        const Storage = {
            set: (key, value, retryCount = 0) => {
                // é˜²æ­¢æ— é™é€’å½’ï¼Œæœ€å¤šé‡è¯•3æ¬¡
                const MAX_RETRY = 3;

                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return { success: true };
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æœ€æ—§çš„å­˜æ¡£
                        if (retryCount >= MAX_RETRY) {
                            console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²å°è¯•æ¸…ç†ä½†ä»æœ‰é—®é¢˜');
                            return { success: false, error: 'QuotaExceededError' };
                        }

                        try {
                            const keys = Object.keys(localStorage)
                                .filter(k => k.startsWith('hulu_save_slot_'))
                                .map(k => {
                                    try {
                                        const itemData = JSON.parse(localStorage.getItem(k));
                                        return {
                                            key: k,
                                            data: itemData,
                                            timestamp: itemData?.timestamp || 0
                                        };
                                    } catch {
                                        return { key: k, data: null, timestamp: 0 };
                                    }
                                })
                                .filter(item => item.data !== null)
                                .sort((a, b) => a.timestamp - b.timestamp);

                            if (keys.length > 0) {
                                localStorage.removeItem(keys[0].key);
                                // é‡è¯•ä¿å­˜ï¼Œå¢åŠ é‡è¯•è®¡æ•°
                                return Storage.set(key, value, retryCount + 1);
                            }
                        } catch (cleanupError) {
                            console.error('æ¸…ç†å­˜æ¡£æ—¶å‡ºé”™:', cleanupError);
                        }
                        console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œä¸”æ— æ³•æ¸…ç†æ—§æ•°æ®');
                        return { success: false, error: 'QuotaExceededError' };
                    } else if (e.name === 'SecurityError') {
                        console.warn('éšç§æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨ localStorage');
                        return { success: false, error: 'SecurityError' };
                    } else {
                        console.error('Storage error:', e);
                        return { success: false, error: e.name || 'UnknownError' };
                    }
                }
            },
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error('Storage read error:', e);
                    return defaultValue;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Storage remove error:', e);
                    return false;
                }
            }
        };

        // --- å¸¸é‡é…ç½® ---
        const CONSTANTS = {
            // æ‰“å­—æœºæ•ˆæœé€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
            TYPING_SPEED: {
                MIN: 10,        // æœ€å¿«é€Ÿåº¦
                MAX: 80,        // æœ€æ…¢é€Ÿåº¦
                DEFAULT: 30     // é»˜è®¤é€Ÿåº¦
            },

            // è‡ªåŠ¨æ¨¡å¼å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            AUTO_MODE_DELAY: {
                BASE: 500,      // åŸºç¡€å»¶è¿Ÿ
                PER_CHAR: 80    // æ¯ä¸ªå­—ç¬¦å¢åŠ çš„å»¶è¿Ÿ
            },

            // localStorage å­˜å‚¨é”®å (ä½¿ç”¨æ¸¸æˆå”¯ä¸€æ ‡è¯†ç¬¦å‰ç¼€ï¼Œé¿å…ä¸å…¶ä»–æ¸¸æˆå†²çª)
            STORAGE_KEYS: {
                AUTO_SAVE: 'hulu_auto_save',
                SAVE_SLOT_PREFIX: 'hulu_save_slot_',
                READ_TEXT: 'hulu_read_text',
                UNLOCKED_ENDINGS: 'hulu_unlocked_endings',
                UNLOCKED_CHAPTERS: 'hulu_unlocked_chapters',
                SETTINGS: 'hulu_settings'
            },

            // åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            ANIMATION: {
                FADE_DURATION: 500,         // æ·¡å…¥æ·¡å‡º
                SHAKE_DURATION: 600,        // éœ‡åŠ¨æ•ˆæœ
                RHYTHM_DURATION: 500,       // èŠ‚å¥éœ‡åŠ¨
                PRELOADER_DELAY: 500        // é¢„åŠ è½½å®Œæˆåçš„å»¶è¿Ÿ
            },

            // ä¿å­˜æ§½ä½é…ç½®
            SAVE_SLOTS: {
                MAX_SLOTS: 10               // æœ€å¤§å­˜æ¡£æ§½ä½æ•°
            }
        };

        // --- èµ„æºé…ç½® (ä¿æŒåŸèµ„æº) ---
        const ASSETS = {
            bg: {
                qingjing_night: './qingjingpeaknight.png',
                system_space: './black.png', // Pure black background image
                start: './start_screen.png', // Original start screen
                kiss: './ending_b.png',
                lingxicave: './lingxicave.jpg',
                bedroom: './bedroom.jpg',
                bedroom_day: './bedroom_day.png',
                ruin: './ruin.jpg',
                nuanhongge: './nuanhongge.jpg',
                bamboo_night: './bamboonight.jpg',
                clinic: './clinic.png',
                hold_hands: './ending_b.png', // Placeholder for HE CG
                banquet: './banquethall.png',
                qingjing_houshan: './qingjing_houshan.png',
                jinshuge: './jinshuge.png',
                bamboo_day: './bamboohut_day.png',
                qiongding_hall: './qiongding_hall.png'

            },
            char: {
                sqq: {
                    v1: './sqq_1.png',        // Normal
                    v2: './sqq_2.png',        // Eyes closed
                    v3: './sqq_3.png',        // Flush
                    v4: './sqq_4.png',        // Shocked
                    v5: './sqq_5.png'         // Shame
                },
                yqy: './yueqingyuan.png',
                system: './xitong.PNG'
            },
            audio: { // Keep existing audio for now
                bgm: './baheng.mp3',
                boom: './boom.mp3',
                fan: './fan.mp3',
                splash: './splash.mp3',
                cloth: './cloth.mp3',
                sword: './sword.mp3',
                magic: './magic.mp3',
                pipa: './pipa.mp3'
            }
        };

        // --- å‰§æœ¬æ•°æ®  ---
        const SCENES = {
            // --- ç¬¬ä¸€ç« ï¼šä¸´é—¨ä¸€è„š ---
            'chapter1': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬ä¸€ç« ï¼šä¸´é—¨ä¸€è„šã€‘", mood: 'narrative', bg: ASSETS.bg.bamboo_night },
                    { speaker: 'æ—ç™½', text: "ç«¹å½±æ–‘é©³æŠ•åœ¨åœ°ä¸Šï¼Œæ²ˆæ¸…ç§‹ç›˜è†è€Œåï¼Œçœ‰å¤´ç´§é”ï¼Œé¢è§’æ¸—å‡ºå†·æ±—ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¿®ä»™è€…è‹¥å¿ƒé•œæœ‰æŸï¼Œæå…¶ä¸åˆ©äºä¿®è¡Œã€‚è½»è€…ä¿®ä¸ºå€’é€€ï¼Œå¯¸æ­¥éš¾è¡Œï¼›é‡è€…èµ°ç«å…¥é­”ï¼Œç»è„‰å¯¸æ–­è€Œæ­»ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰åäºŒå³°ç»§ä»»å¤§å…¸åœ¨å³ï¼Œæˆ‘çš„ä¿®ä¸ºå´è¿Ÿè¿Ÿè·Ÿä¸ä¸Šï¼Œå¡åœ¨é‚£ä¸´é—¨ä¸€è„šä¸Šã€‚", mood: 'worried' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰çƒ¦èºâ€¦â€¦è¶Šæ˜¯çƒ¦èºï¼Œè¶Šæ˜¯ä¸å¾—è¦é¢†ï¼Œè¶Šæ˜¯ä¸å¾—çªç ´ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "çµæ°”åœ¨å‘¨èº«æ¿€è¡ï¼Œè§†é‡è¾¹ç¼˜æ³›èµ·ä»£è¡¨å±é™©çš„çº¢å…‰ã€‚æ²ˆæ¸…ç§‹çŒ›åœ°ççœ¼ï¼Œå‘¼å¸æ€¥ä¿ƒã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰è‹¥ä¸èƒ½åœ¨å¤§å…¸å‰çªç ´ï¼Œä¸ä»…ä¿®ä¸ºåœæ»ï¼Œæ›´ä¼šä¸¢äº†æ¸…é™å³°çš„è„¸é¢ã€‚æ”¾çœ¼æ•´ä¸ªè‹ç©¹å±±æ´¾ï¼Œé—­å…³ä¿®ç‚¼æœ€å¥½çš„åœ°æ–¹ï¼Œè‡ªç„¶æ˜¯çµçŠ€æ´ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰â€¦â€¦åªæ˜¯è¿›å…¥çµçŠ€æ´ï¼Œéœ€è¦æŒé—¨çš„é¦–è‚¯å’Œç‰¹åˆ¶çš„è…°ç‰Œã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçš±çœ‰ï¼Œèµ·èº«ï¼‰è™½ä¸æ„¿è§ä»–ï¼Œä½†ä¹Ÿåˆ«æ— ä»–æ³•äº†ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "å¦‚ä»Šç»§ä»»å¤§å…¸åœ¨å³ï¼Œå²³æ¸…æºå‡ ä¹å¿™åˆ°è„šä¸æ²¾åœ°äº†ã€‚åŸæœ¬åœ¨ä¹¦æˆ¿åŸ‹å¤´å¤„ç†é—¨ä¸­äº‹åŠ¡çš„å²³æ¸…æºï¼Œçœ‹åˆ°æ¨é—¨è€Œè¿›çš„æ²ˆæ¸…ç§‹ï¼Œçœ¼åº•è¿¸å‘å‡ºçš„å–œè‰²ï¼Œè—éƒ½è—ä¸ä½ã€‚", mood: 'narrative', bg: ASSETS.bg.bedroom },
                    { speaker: 'æ—ç™½', text: "å¯¹æ–¹å€’æ˜¯è¢«ä»–çœ‹çš„æœ‰äº›ä¸è‡ªåœ¨ï¼Œçœ¼ç¥ç›¸å¯¹çš„ç¬é—´å°±é£˜å‘äº†åˆ«å¤„ï¼Œè½»å’³äº†ä¸€ä¸‹æ¸…äº†æ¸…å—“å­ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºè¿™æ—¶æ‰æ„è¯†åˆ°è‡ªå·±ä»å¯¹æ–¹è¿›é—¨åˆ°ç°åœ¨ä¸€ç›´ç›¯ç€ï¼Œå°´å°¬çš„æ”¶å›äº†è§†çº¿ï¼Œçœ‹ç€å¯¹æ–¹ä¸å†ç›´å‹¾å‹¾çš„ç›¯ç€è‡ªå·±ï¼Œæ²ˆæ¸…ç§‹å€’ä¸å‰è¿›å°±ç«™åœ¨ç¦»é—¨ä¸€æ­¥è¿œçš„åœ°æ–¹è¯´æ˜äº†æ¥æ„ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†·æ¼ ï¼‰æˆ‘è¦è¿›çµçŠ€æ´ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "å¾—åˆ°äº†è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ï¼Œæ²ˆæ¸…ç§‹å¤´ä¹Ÿä¸å›ï¼Œè½¬èº«å°±èµ°ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çµçŠ€æ´å†…ï¼Œæ²ˆæ¸…ç§‹æ¥åˆ°äº†ä¸€å¤„çµæ°”æµ“éƒçš„æ´åºœï¼Œåœ¨çŸ³çƒ›å°ä¸Šç‚¹èµ·å¹½å¹½çš„çƒ›ç«ï¼Œç«å…‰æ˜æ˜ç­ç­ï¼Œéšçº¦ç…§äº®æ´åºœã€‚", mood: 'narrative', bg: ASSETS.bg.lingxicave },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçš±çœ‰è§‚å¯Ÿï¼‰è¿™äº›ç—•è¿¹â€¦â€¦", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "çƒ›å…‰äº®èµ·æ²ˆæ¸…ç§‹æ‰å‘ç°æ´å£ä¸Šçš†æ˜¯åˆ€åŠˆæ–§ç çš„ç—•è¿¹ï¼Œä»¿ä½›äººè„¸ä¸Šå±‚å±‚å å çš„ä¼¤ç–¤ï¼Œç‹°ç‹éª‡äººã€‚é™¤äº†å‰‘ç—•ï¼Œè¿˜æœ‰å¤§ç‰‡å¤§ç‰‡çš„æš—çº¢è‰²è¡€è¿¹ã€‚", mood: 'narrative' }
                ],
                next: 'chapter2'
            },


            // --- ç¬¬äºŒç« ï¼šå¾€äº‹æš—æ¶Œ ---
            'chapter2': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬äºŒç« ï¼šå¾€äº‹æš—æ¶Œã€‘", mood: 'narrative', bg: ASSETS.bg.lingxicave },
                    { speaker: 'æ—ç™½', text: "æ‰‹ä¸­å‡èµ·ä¸€å›¢å…‰æ™•ç…§æ˜ï¼Œæ²ˆæ¸…ç§‹å‡‘è¿‘çœ‹ï¼Œè¿™äº›æš—çº¢è‰²çš„è¡€è¿¹ï¼Œæœ‰çš„åƒæ˜¯ç”¨åˆ©åˆƒç©¿åˆºèº«ä½“ï¼Œå–·æº…ä¸Šå»çš„ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æœ‰çš„åˆ™ä»¿ä½›æœ‰äººæ›¾ç»ç”¨é¢å¤´å¯¹ç€å²©å£å©é¦–ï¼Œå“€æ±‚ç€ä»€ä¹ˆï¼Œä¸€ä¸‹åˆä¸€ä¸‹ç£•ä¸Šå»çš„ç—•è¿¹ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è¡€è¿¹æ˜æš—ä¸ä¸€æ˜æ˜¾æ˜¯ä¸åŒæ—¶é—´å–·æº…ä¸Šå»çš„ï¼Œä½†è‰²å·®åˆä¸æ˜¯ç‰¹åˆ«æ˜æ˜¾ï¼Œæƒ³å¿…é—´éš”æ—¶é—´ä¹Ÿä¸æ˜¯ç‰¹åˆ«é•¿ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰è¿™äº›è¡€ï¼Œè‹¥æ˜¯åŒä¸€ä¸ªäººæµçš„ï¼Œä¸æ­»ä¹Ÿè¦å»åŠæ¡å‘½äº†ã€‚è‡³äºè¿™äººåˆ°åº•æ˜¯è°ï¼Œæˆ‘å€’ä¹Ÿæ²¡å¿ƒæ€æƒ³è¿™äº›äº†ã€‚", mood: 'worried' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æ­¤æ¬¡é—­å…³ï¼Œè‹¥è¿˜ä¸èƒ½çªç ´â€¦â€¦", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹åœ¨çŸ³å°ä¸Šå¼ºè¿«è‡ªå·±é™å¿ƒæ‰“åï¼Œä¹Ÿè®¸æ˜¯è¿‘æ—¥å¿§æ€è¿‡åº¦ï¼Œçµå°åƒæ˜¯è¢«é›¾è’™ä½ä¸€æ ·ï¼Œä¹…ä¹…ä¸èƒ½é™ä¸‹å¿ƒæ¥ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çªæ„Ÿæœ‰ä¸€è‚¡çµåŠ›å†è„‰ç»œä¸­æ¨ªå†²ç›´æ’ï¼Œé¡¿æ—¶å¿ƒä¸­ä¸€æ…Œï¼ŒåŸæœ¬åœ¨è„‰ç»œä¸­è¿è¡Œçš„å¥½å¥½çš„çµåŠ›æ›´åŠ ä¸å—æ§åˆ¶ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å››å‘¨çš„çµåŠ›è¿˜åœ¨æºæºä¸æ–­çš„ï¼Œå‘ä»–æ±‡é›†ï¼Œä½†ä½“å†…è„‰ç»œæ— æ³•ç–é€šï¼ŒçµåŠ›æ’çš„ç»è„‰ç”Ÿç–¼ï¼Œçµæ°”çš„å¸æ”¶ï¼Œä¸€æ—¶åŠä¼šå´åœä¸ä¸‹æ¥ã€‚", mood: 'narrative' },
                    { speaker: 'å¥‡æ€ªçš„å£°éŸ³', text: "â€œå¸ˆå°Šï¼Œå¼Ÿå­æ±‚æ‚¨æ”¾æˆ‘å‡ºå»ã€‚æ±‚æ±‚æ‚¨äº†ï¼Œæ”¾æˆ‘å‡ºå»ï¼Œæ”¾æˆ‘å‡ºå»ã€‚â€", mood: 'system', shake: true },
                    { speaker: 'æ—ç™½', text: "è„‘ä¸­ç‚¸å“èµ·ä¸€ä¸ªåˆºè€³çš„è¿‘ä¹æ˜¯åšå«å‡ºæ¥çš„å£°éŸ³ã€‚çµå°è¢«è¿™åˆºè€³çš„å£°éŸ³ï¼Œåˆºçš„ä¸€ç¬æ¸…æ˜ï¼Œç»ç»œä¸­ä¹±çªœçš„çµåŠ›ä¹Ÿç¨ç¨å¹³æ¯ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¿½è§‰æœ‰ä¸€äººåœ¨èƒŒåã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ¯›éª¨æ‚šç„¶ï¼Œè¿…é€Ÿå–å‡ºæ‰‹è…•é—´è´´ç€çš„åŒ•é¦–ï¼Œå®Œå…¨å‡ºäºæœ¬èƒ½ï¼Œæ‰‹è…•ç¿»è½¬æœèº«åçŒ›æ‰è¿‡å»ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ—ç™½', text: "ä¸è¿‡èº«åçš„äººæ—¶åˆ»å…³æ³¨ç€ä»–ï¼Œæ¯”ä»–ååº”æ›´å¿«ç¨³ç¨³çš„æ¡ä½äº†ä»–çš„æ‰‹è…•ï¼Œé˜»æ­¢äº†ä»–è¦åˆºå‡ºå»çš„åŒ•é¦–ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æ˜¯æˆ‘ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "â€¦â€¦", mood: 'shocked' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºç»§ç»­ç»™ä»–è¾“é€çµåŠ›ï¼Œå¼•å¯¼å¯¹æ–¹ä½“å†…èºåŠ¨çš„çµæµå¹³æ¯ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘çš„é”™ï¼Œå“åˆ°å¸ˆå¼Ÿäº†ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "ä»–ä¸è¯´è¿˜å¥½è¯´äº†æ²ˆæ¸…ç§‹åƒæ˜¯ä¸€åªè¢«è¸©äº†å°¾å·´çš„çŒ«å¿½çš„ç‚¸èµ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å“è°ï¼Ÿï¼", mood: 'angry', shake: true },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºæœ‰æ—¶å€™çœŸçš„æƒ³æŠŠè‡ªå·±çš„å˜´ç¼ä¸Šï¼Œæ˜çŸ¥é“å¯¹æ–¹ä¸å–œè‡ªå·±å¤šè¯´æ§åˆ¶ä¸ä½ä¹Ÿå°±ç®—äº†ï¼Œè¿˜æ¯æ¬¡å°±å¤šé‚£ä¸€å˜´æŠŠäººæƒ¹ç‚¸æ¯›äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹çœŸè¢«ä»–å“åˆ°ï¼Œè‡ªè§‰ä¸¢äº†é¢å­ï¼Œåˆå¼€å§‹æŒ–è‹¦ä»–ï¼Œé˜´é˜³æ€ªæ°”é“ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æŒé—¨ä¸æ˜¯ä»æ¥ä¸å…¥çµçŠ€æ´é—­å…³ï¼Ÿä½•è‡³äºæˆ‘æ¥äº†ï¼Œä½ ä¹Ÿæ¥äº†ã€‚", mood: 'disdain' },
                    { speaker: 'å²³æ¸…æº', text: "â€¦æˆ‘ä»¥å‰ä¹Ÿæ˜¯è¿›æ¥è¿‡çš„ã€‚", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "è°å…³å¿ƒæ‚¨æ¥æ²¡æ¥è¿‡ï¼Ÿ", mood: 'disdain' },
                    { speaker: 'å²³æ¸…æº', text: "æ¸…ç§‹ï¼Œä¸“å¿ƒè°ƒæ°”å¹³æ¯ã€‚", mood: 'gentle' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ€ä¹ˆå¯èƒ½ä¼šå¬ä»–çš„è¯ï¼Ÿç›´æ¥å”±åè°ƒï¼Œç´¢æ€§è‡ªå·±ä¹Ÿä¸è°ƒæ¯ï¼Œå®Œå…¨ä»»å¯¹æ–¹çš„çµåŠ›åœ¨è‡ªå·±ä½“å†…æµçªœï¼Œä¸ºè‡ªå·±è°ƒæ¯ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "é™ä¸‹å¿ƒæ¥ï¼Œæƒ³èµ·ä¹‹å‰è‡ªå·±è„‘æµ·ä¸­è«åå…¶å¦™å“èµ·çš„å£°éŸ³ï¼ŒçµçŠ€æ´å†…ä¸å…è®¸å†…æ–—ï¼Œæ´å£ä¸Šçš„è¡€è¿¹ï¼Œæƒ³å¿…ä¸æ˜¯æ‰“æ–—æ—¶å¼„ä¸Šå»ï¼Œå¯èƒ½æ˜¯æœ‰äººèµ°ç«å…¥é­”å¼„ä¸Šå»çš„ï¼Œå¿ƒä¸‹ä¸å…å¥½å¥‡ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æœ‰äººèµ°ç«å…¥é­”ï¼Œå›°æ­»åœ¨è¿™å¤„æ´åºœäº†å—ï¼Ÿ", mood: 'curious' },
                    { speaker: 'æ—ç™½', text: "å¯ä»–è¿™ä¸€é—®ï¼Œæ¢æ¥çš„å´æ˜¯è‰¯ä¹…çš„æ²‰é»˜ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–ä»¬ä¸¤ä¸ªäººç›¸å¤„æ—¶ï¼Œé€šå¸¸éƒ½æ˜¯å²³æ¸…æºä¸åŒå…¶çƒ¦çš„ä¸»åŠ¨æ‰¾è¯é¢˜ï¼Œä»æ¥æ²¡æœ‰åƒè¿™èˆ¬å¯¹æ–¹ä¸å‘ä¸€è¨€çš„æƒ…å†µã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å®Œå…¨å—ä¸äº†è¿™æ ·çš„è½å·®å¿ƒä¸­é™¡ç„¶å‡èµ·ä¸€ç‚¹å¼‚æ ·æ„Ÿã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "â€¦â€¦", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "â€¦â€¦å²³æ¸…æºï¼Ÿ", mood: 'perplexed' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘åœ¨ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "åœ¨ä½ ä¸ºä»€ä¹ˆä¸å­å£°ï¼Ÿ", mood: 'angry' },
                    { speaker: 'å²³æ¸…æº', text: "â€¦â€¦æœ‰äººèµ°ç«å…¥é­”ï¼Œä½†æ²¡æ­»åœ¨è¿™ã€‚", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "è‹¥ä¸æ˜¯æ‰§å¿µæœªæ¶ˆï¼Œçµæ™ºåœç•™åœ¨è¿™é‡Œï¼Œä¿®å£«åˆæ€ä¹ˆä¼šæ„ŸçŸ¥çš„åˆ°ï¼Ÿ", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ¯çœ¼ç›¯äº†ä¸€é˜µå¢™å£ï¼Œå¿ƒä¸­çš„å¥½å¥‡ä¸å‡åå¢ï¼‰æ–¹æ‰æˆ‘å¬åˆ°å“€æ±‚çš„å£°éŸ³äº†ã€‚ä½ å¯çŸ¥ä»–æ˜¯è°ï¼Ÿ", mood: 'curious' },
                    { speaker: 'æ—ç™½', text: "å¿½ç„¶ï¼Œè´´åœ¨åèƒŒçš„æ‰‹å‰§çƒˆé¢¤æŠ–èµ·æ¥ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ä»–åœ¨æŠ–ï¼Ÿæ€ä¹ˆå›äº‹â€¦â€¦", mood: 'perplexed' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å›å¤´ï¼Œåªè§å²³æ¸…æºè„¸è‰²æƒ¨ç™½ï¼Œå˜´å”‡ä¹Ÿä¸è‡ªè§‰åœ°é¢¤æŠ–ç€ï¼Œçœ¼ä¸­æ»¡æ˜¯æƒŠéª‡ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è§ä»–è½¬å¤´ï¼Œå²³æ¸…æºå‹‰å¼ºæ‰¯å‡ºä¸€ä¸ªæ¯”å“­è¿˜éš¾çœ‹çš„ç¬‘å®¹ï¼Œæ…Œå¿™æ”¶å›äº†è´´åœ¨ä»–åèƒŒçš„æ‰‹ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–åŒ†åŒ†èµ°ä¸‹çŸ³å°ï¼Œç”šè‡³ä¸æ•¢ç›´è§†æ²ˆæ¸…ç§‹çš„çœ¼ç›ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "å°â€¦æ¸…ç§‹ï¼Œä¿®ä¸ºä¹‹äº‹ä¸å¯å¿ƒæ€¥ã€‚å…¥é—¨æ—¶é—´å°šçŸ­ä¾¿å·²ç­‘åŸºå·…å³°ï¼Œä¿®ä¸ºä¸Šæ¶¨æå¿«ï¼Œå¯¹ç»è„‰å¹¶æ— å¥½å¤„ã€‚", mood: 'worried' },
                    { speaker: 'å²³æ¸…æº', text: "ç°å¦‚ä»Šæœ€å¥½è¿˜æ˜¯å·©å›ºä¿®ä¸ºï¼Œè«è¦å¯¹è‡ªå·±å¤ªè¿‡ä¸¥è‹›äº†ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "æ­£æƒ³å›æ€¼ä¸€å¥ï¼Œç»“æœå¯¹æ–¹åƒæ˜¯å—åˆ°ä»€ä¹ˆæƒŠå“ä¸€èˆ¬è„¸è‰²æ›´ç™½äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºæ­¥ä¼è¿ˆçš„æå¿«ï¼Œé€ƒä¹Ÿä¼¼çš„ç¦»å¼€äº†ï¼Œèº«å½¢è¿˜é€ç€å‡ åˆ†ç‹¼ç‹ˆï¼Œç”šè‡³è¿˜è¢«æ´åºœä¸­çš„çŸ³å¤´ç»Šäº†ä¸€ä¸‹ï¼Œå·®ç‚¹æ‘”å€’ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰è·‘ä»€ä¹ˆï¼Ÿæˆ‘æœ‰é‚£ä¹ˆå¯æ€•å—ï¼Ÿ", mood: 'angry' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆç›¯ç€èƒŒå½±ï¼Œå¿ƒä¸­æ— åç«èµ·ï¼‰è«åå…¶å¦™ï¼", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å°†è¢–ä¸­çš„åŒ•é¦–ç‹ ç‹ åœ°æ·åœ¨åœ°ä¸Šï¼Œç °çš„ä¸€å£°ï¼ŒçµåŠ›è£¹æŒŸç€åŒ•é¦–æ‰å…¥åœ°é¢ï¼Œä¹±çŸ³é£æº…ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ—ç™½', text: "å‰©ä¸‹çš„æ—¥å­ï¼Œæ²ˆæ¸…ç§‹å¬åŠäº†ã€‚ä»–æ²¡æœ‰ç›²ç›®å†²åˆºé—¨æ§›ï¼Œè€Œæ˜¯å¼€å§‹ä¸€ééå†²åˆ·ç»è„‰ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ä»–è¯´å¾—æ²¡é”™â€¦â€¦æ˜¯æˆ‘å¤ªæ€¥äº†ã€‚çµåŠ›è¿è¡Œé—´å·²æœ‰æ˜æ˜¾çš„é˜»å¡æ„Ÿï¼Œç”šè‡³å¸¦ç€ç»†å¾®çš„é’ç—›ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰è¿™æ„Ÿè§‰â€¦â€¦å€’åƒæ˜¯è¢«äººå¼ºè¡Œæ‹”è‹—åŠ©é•¿äº†ä¸€æ ·ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "ä¸€ä¸ªæœˆåï¼Œç»è„‰çš„é’ç—›ç»ˆäºæ¶ˆå¤±ï¼Œä¿®ä¸ºè™½æœªçªç ´ï¼Œå´æ¯”ä¹‹å‰ç¨³å›ºäº†æ•°å€ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å°±åœ¨å‡†å¤‡ç¦»å¼€çµçŠ€æ´æ—¶ï¼Œæ²ˆæ¸…ç§‹åœ¨å…ˆå‰æ·åŒ•é¦–çš„ä½ç½®å‘ç°äº†ä¸€æ ·ä¸œè¥¿ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¸€å›¢æŒ‡ç”²ç›–å¤§å°çš„é‡‘è‰²æµå…‰ï¼Œæ­£å¸é™„åœ¨åŒ•é¦–ä¸Šï¼Œç¼“æ…¢åœ°å¸é£Ÿç€æ®‹å­˜çš„çµæ°”ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå‡‘è¿‘è§‚å¯Ÿï¼‰è¿™æ˜¯ä»€ä¹ˆï¼Ÿ", mood: 'curious' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆç¥è¯†æ‰«è¿‡ï¼‰ç«Ÿæœ‰ä¸€ä¸äººçš„ç”Ÿæ¯â€¦â€¦å¯æ„ŸçŸ¥å´åˆæ–­æ–­ç»­ç»­çš„ï¼Œä»€ä¹ˆä¹Ÿæ•æ‰ä¸åˆ°ã€‚", mood: 'curious' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å²³æ¸…æºä¹‹å‰çš„å›é¿ï¼Œè¿˜æœ‰é‚£æ…Œå¼ çš„èƒŒå½±â€¦â€¦æƒ³å¿…ä¸æ­¤ç‰©æœ‰å…³ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "ä»–å°†é‡‘å…‰å°å…¥ç¬¦çº¸ï¼Œå¸¦å‡ºäº†çµçŠ€æ´ã€‚åˆšä¸€è¸å‡ºæ´å£ï¼Œä¾¿è§åˆ°äº†ç­‰å€™å¤šæ—¶çš„å²³æ¸…æºã€‚", mood: 'narrative', bg: ASSETS.bg.qingjing_night },//è¦æ¢ä¸€ä¸ªèƒŒæ™¯
                    { speaker: 'æ—ç™½', text: "çœ‹åˆ°æ¥äººï¼Œä¹‹å‰çƒ¦èºçš„æƒ…ç»ªä¼¼ä¹è¢«å®‰æŠšäº†ä¸€ä¸‹ï¼Œä½†é¢ä¸Šè¿˜æ˜¯æ²¡ä¸ªå¥½è„¸ï¼Œä¸€å¼ å£ä¾æ—§é˜´é˜³æ€ªæ°”çš„ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å‘¦ï¼ä»€ä¹ˆé£æŠŠæŒé—¨åˆ®è¿‡æ¥äº†ï¼Œä¹‹å‰ä¸æ˜¯ä¸æ€ä¹ˆæ¥å—ï¼Ÿç°åœ¨å€’æ˜¯è·‘çš„å‹¤ã€‚", mood: 'disdain' },
                    { speaker: 'å²³æ¸…æº', text: "è¿˜æœ‰ä¸‰æ—¥ä¾¿æ˜¯ç»§ä»»å¤§å…¸ï¼Œä½ çš„æœé¥°åšå¥½äº†ï¼Œæƒ³è®©ä½ å»è¯•è¯•ï¼Œä¸åˆé€‚ï¼Œè¿˜å¯ä»¥å†æ”¹ã€‚", mood: 'gentle' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºä¸ç”±åˆ†è¯´åœ°ç‰µèµ·ä»–çš„æ‰‹ï¼Œå¼•å¯¼çµåŠ›å…¥ä½“æ¢æŸ¥ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ç®—äº†ï¼Œå¤šä¸€äº‹ä¸å¦‚å°‘ä¸€äº‹ã€‚è‹¥ä¸è®©ä»–æŸ¥å®Œè¿™ä¸€é­ï¼Œæ€•æ˜¯è¿˜è¦æ‰¾åˆ«çš„å€Ÿå£çº ç¼ ä¸ªæ²¡å®Œã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "ä»¥ä»–å¯¹å²³æ¸…æºçš„äº†è§£ï¼Œæ­¤æ—¶ä¸æ¢æŸ¥ä»–æ˜ç™½ï¼Œè¿˜ä¼šæ‰¾å…¶ä»–ç†ç”±å†æ¢æŸ¥çš„ã€‚å¤šä¸€äº‹ä¸å¦‚å°‘ä¸€äº‹ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çµåŠ›æ”¶å›è‡ªèº«ï¼Œå²³æ¸…æºä¾æ—§æ²¡æ¾æ‰‹ï¼Œåè€Œæ˜¯æ¡çš„æ›´ç´§äº†ï¼Œç‰µç€å¯¹æ–¹ï¼Œä¸€å‰ä¸€åçš„èµ°ç€ï¼Œåƒå°æ—¶å€™ç›¸ä¼´çš„æ— æ•°ä¸ªæ—¥å¤œä¸€æ ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹çœŸæ˜¯è¢«è¿™ä¸€ä¸¾åŠ¨æ•´æ„£äº†ï¼Œç«ŸçŸ¥ä¸è§‰è·Ÿç€èµ°äº†ä¸¤æ­¥ï¼Œåæ˜ è¿‡æ¥æå¿«çš„æŠ½å›è‡ªå·±çš„æ‰‹ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "è¡£æœé€åˆ°æ¸…é™å³°å³å¯ï¼Œæˆ‘è‡ªå·±ä¼šè¯•ï¼Œä¸å¿…åŠ³çƒ¦æŒé—¨ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "éšåå¸ä¸‹è…°é—´è¿›å‡ºçµçŠ€è·¯çš„è…°ç‰Œï¼Œæ‰”ç»™å²³æ¸…æºï¼Œå¤´ä¹Ÿä¸å›çš„èµ°äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ç‹¬ç•™å²³æ¸…æºä¸€äººå‘†å‘†åœ°ç«™åœ¨åŸåœ°ï¼Œçœ‹ç€é‚£æ¸è¡Œæ¸è¿œçš„é’è¡£èº«å½±ï¼Œæ¡ç€è…°ç‰Œçš„æ‰‹ï¼Œå·²ç»æ¡åˆ°å‘ç™½ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å›åˆ°ç©¹é¡¶æ®¿ç»§ç»­å¤„ç†é—¨ä¸­å®åŠ¡ï¼Œå·å®—æ²¡çœ‹å‡ å·ï¼Œä»–çš„å¤§å¼Ÿå­ä¹¦ç šåœ¨å¤–æ•²é—¨ã€‚", mood: 'narrative', bg: ASSETS.bg.bedroom },
                    { speaker: 'ä¹¦ç š', text: "å¸ˆå°Šï¼Œæˆ‘èƒ½è¿›æ¥å—ï¼Ÿ", mood: 'neutral' },
                    { speaker: 'å²³æ¸…æº', text: "è¿›å§ï¼", mood: 'neutral' },
                    { speaker: 'ä¹¦ç š', text: "ï¼ˆè§„è§„çŸ©çŸ©è¡Œäº†ä¸€ä¸ªå¼Ÿå­ç¤¼ï¼‰å¤§å…¸çš„æœé¥°å·²ç»ç»™æ²ˆå¸ˆå”é€è¿‡å»äº†ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºç‚¹å¤´ç¤ºæ„è‡ªå·±çŸ¥é“äº†ï¼Œéšååˆä½å¤´ç»§ç»­çœ‹è‡ªå·±æ‰‹é‡Œçš„å·å®—ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æ²¡ä»€ä¹ˆäº‹å°±å›å»ä¼‘æ¯æœ€è¿‘è¿˜æœ‰çš„å¿™ã€‚", mood: 'neutral' },
                    { speaker: 'ä¹¦ç š', text: "å¸ˆå°Šï¼Œä½ å¤‡ç€çš„é‚£äº›é¥­èœï¼Œå†ä¸åƒå°±è¦å‡‰äº†ã€‚", mood: 'worried' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆè¿å¤´ä¹Ÿæ²¡æŠ¬ï¼‰ä½ è‡ªè¡Œå¤„ç†äº†å§ï¼", mood: 'sorrow' },
                    { speaker: 'ä¹¦ç š', text: "æ˜¯ï¼Œå¸ˆå°Šï¼Œå¼Ÿå­å‘Šé€€ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "é—¨å…³ä¸Šåï¼Œä¹¦æˆ¿ä¸­ä¾¿åªå‰©ä¸‹ç¿»åŠ¨å·ç»¼ä¹¦å†™æ¯›ç¬”çš„åˆ·åˆ·å£°ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "â€”â€”â€”â€”â€”â€”â€”â€”ä¸‰æ—¥åâ€”â€”â€”â€”â€”â€”â€”â€”â€”", mood: 'narrative' }
                ],
                next: 'chapter3'
            },
            // --- ç¬¬ä¸‰ç« ï¼šç»§ä»»å¤§å…¸ ---
            'chapter3': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬ä¸‰ç« ï¼šç»§ä»»å¤§å…¸ã€‘", mood: 'narrative', bg: ASSETS.bg.qiongding_hall },
                    { speaker: 'æ—ç™½', text: "ç»§ä»»å¤§å…¸åœ¨ç©¹é¡¶å³°å¤§æ®¿ä¹‹ä¸­ä¸¾è¡Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ç°å¦‚ä»Šï¼Œç©¹é¡¶å¤§æ®¿ç©ºç©ºè¡è¡çš„ï¼Œåªç«™ç€12ä½æ–°ç»§ä»»çš„å³°ä¸»ï¼Œå²³æ¸…æºä¸€äººç«™åœ¨é«˜åº§ä¹‹ä¸Šï¼Œå…¶ä»–å³°ä¸»æŒ‰ç…§æ’åé¡ºåºå‘ˆä¸‰è§’å½¢ä¾æ¬¡ç«™åœ¨æ–°ä»»æŒé—¨ä¸‹é¦–ï¼Œä¸ºæ–°ä»»æŒé—¨æŠ¤æ³•ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æŠ¤å±±å¤§é˜µçš„é˜µæ³•çµç¯†æµ®ç°åœ¨æ•´ä¸ªç©¹é¡¶æ®¿ä¸­ï¼ŒåäºŒå³°ä¸»æ‰€ç«™ç€çš„ä½ç½®ï¼Œä¸ºé˜µæ³•çš„åäºŒé˜µçœ¼ï¼Œæºæºä¸æ–­çš„ç»™é˜µçœ¼æ±‡èšçµåŠ›ï¼Œä¸€æ—¶ä¹‹é—´æ•´ä¸ªè‹ç©¹å±±æ´¾çµæ°”éœ‡è¡ã€‚", mood: 'narrative', shake: true, energy: true },
                    { speaker: 'æ—ç™½', text: "ç»§ä»»å¤§å…¸å…¶å®å°±æ˜¯ç¥­å¤©å¤§å…¸ã€‚", mood: 'narrative', energy: true },
                    { speaker: 'æ—ç™½', text: "æœ€å¼ºä¿®å£«ä»¥è‡ªèº«çµåŠ›èå…¥å±±çµï¼Œèšæ°”æˆé˜µï¼Œè‡ªåŠ¨åº‡æŠ¤è¿™ä¸€æ–¹å¤©åœ°ã€‚èå…¥çš„çµåŠ›è¶Šå¤šï¼ŒæŠ¤å±±å¤§çµä¾¿è¶Šå¼ºã€‚", mood: 'narrative', energy: true },
                    { speaker: 'æ—ç™½', text: "ç„è‚ƒå‰‘å…‰èŠ’å¤§ç››ï¼Œå²³æ¸…æºå‘¨èº«çµåŠ›æš´æ¶¨ï¼Œäº”å½©çš„è™šå½±å†²å¤©è€Œèµ·ï¼Œåœ¨ç©ºä¸­æ±‡æˆæ–‘æ–“çš„é‡‘å…‰ã€‚", mood: 'narrative', energy: true, climax: true },
                    { speaker: 'æ—ç™½', text: "å¾…é‡‘å…‰å®Œå…¨è½äºé˜µä¸­ï¼Œå¤§å…¸ä¹Ÿå°±ç®—æˆäº†ã€‚", mood: 'narrative', climax: true },
                    { speaker: 'æ—ç™½', text: "å±…äºä¸‹é¦–çš„æ²ˆæ¸…ç§‹ï¼Œæ€€ä¸­é‚£å¸¦å‡ºçš„ç¬¦çº¸æ­¤åˆ»å´ç¼çƒ­èµ·æ¥ï¼Œç¼å¾—ä»–èƒ¸è…”ç”Ÿç–¼ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆä¸å¯ç½®ä¿¡åœ°ç›¯ç€å²³æ¸…æºï¼‰ï¼ˆå†…å¿ƒï¼‰è¿™éœ‡é¢¤â€¦â€¦ç¬¦çº¸é‡Œå°ç€çš„ï¼Œç«Ÿç„¶æ˜¯å²³æ¸…æºçš„çµè„‰ï¼Ÿï¼", mood: 'shocked' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆæŒ‰ä½èƒ¸å£ï¼‰ï¼ˆç¼çƒ­æ„Ÿä¼¼ä¹è¦å°†ä»–çƒ§ç©¿ï¼‰ä»–ç«Ÿå°†çµè„‰ä¸ä½©å‰‘ç›¸ç»‘â€¦â€¦éš¾æ€ªå²³æ¸…æºä»ä¸è½»æ˜“æ‹”å‰‘ã€‚", mood: 'shocked' },
                    { speaker: 'æ—ç™½', text: "æ­¤åˆ»ï¼Œæ²ˆæ¸…ç§‹å¿ƒä¸­æ»¡æ€€éœ‡æƒŠï¼Œé¢ä¸Šæœ‰å‡ ä¸æ…Œä¹±ä¹‹è‰²ï¼Œå¯æ®¿ä¸­çš„äººçš†å¿™äºç¥­å¤©ï¼ŒåŠ ä¹‹æ²ˆæ¸…ç§‹åˆç«™çš„æ¯”è¾ƒé å‰ï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰äººæ³¨æ„åˆ°ä»–é¢ä¸Šçš„æ…Œä¹±ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå›å¿†ï¼‰â€œæˆ‘ä»¥å‰ä¹Ÿæ˜¯è¿›æ¥è¿‡çš„ã€‚â€", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå›å¿†ï¼‰â€œæœ‰äººèµ°ç«å…¥é­”ï¼Œå›°æ­»åœ¨è¿™å¤„æ´åºœäº†å—ï¼Ÿâ€", mood: 'neutral' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå›å¿†ï¼‰â€œâ€¦â€¦æœ‰äººèµ°ç«å…¥é­”ï¼Œä½†æ²¡æ­»åœ¨è¿™ã€‚â€", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "ä¸€åˆ‡å¥‡æ€ªçš„çº¿ç´¢ï¼Œä¼¼ä¹åœ¨æ­¤åˆ»è¯¡å¼‚åœ°ä¸²è”åœ¨äº†ä¸€èµ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ç„è‚ƒå‰‘æ”¶å›é˜ä¸­ï¼Œç¥­å¤©ç»“æŸã€‚å±±ä¸­çµæ°”å¾å¾æ²‰é™ï¼Œåº†ç¥çš„å–§åš£å£°éšä¹‹å“èµ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¹¦ç šå¸¦ç€ä¸€ç¾¤å¼Ÿå­å°†çé¦ä½³é…¿æ‘†å…¥å¤§æ®¿ï¼Œè™½ç„¶æ’¤å»äº†å†—é•¿çš„å‘è¨€ï¼Œä½†æ°”æ°›ä¾æ—§çƒ­çƒˆã€‚", mood: 'narrative', bg: ASSETS.bg.banquet },
                    { speaker: 'æ—ç™½', text: "åäºŒå³°ä¸»å„è‡ªå…¥åï¼Œä¹å¸ˆå¥ä¹ï¼Œèˆå§¬å…¥æ®¿ï¼Œæ•´ä¸ªç©¹é¡¶å³°æ²‰æµ¸åœ¨ç¥¥å’Œä¹‹ä¸­ã€‚", mood: 'narrative' },

                    // Banquet scene
                    { speaker: 'æ—ç™½', text: "ååœ¨æŒé—¨ä¸‹æ‰‹æ²ˆæ¸…ç§‹å…¨ç„¶ä¸åœ¨çŠ¶æ€åƒæ˜¯è¢«æŠ½èµ°äº†é­‚ä¼¼çš„ï¼Œä¹Ÿä¸çŸ¥é“åœ¨æƒ³äº›ä»€ä¹ˆï¼Œåªæ˜¯ä¸€æ¯æ¥ç€ä¸€æ¯å–é—·é…’ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çœ¼ç¥é£˜å¿½è¿™æ˜æ˜¾ä¸åœ¨çŠ¶æ€çš„æ ·å­ï¼Œå±å®ç½•è§æ¯•ç«Ÿæ²ˆæ¸…ç§‹è‡ªå·±ä»å½“ä¸Šäº†é¦–å¸­ä¹‹åå°±è¡¨é¢å›å­å°±å·²ç»è®©ä»–ç»ƒå¾—ç‚‰ç«çº¯é’ï¼Œé²œå°‘ä¼šå‡ºç°è¿™ç§å®Œå…¨èµ°ç¥çš„ä¸¾åŠ¨ï¼Œæ›´ä½•å†µè¿˜è¿™ä¹ˆæ˜æ˜¾ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æ¸…ç§‹ï¼Œè«è¦è´ªæ¯äº†ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æƒŠå¾—é…’æ°´æ´’å‡ºï¼Œæ‰‹é‡Œçš„æ¯å­å·®ç‚¹è„±æ‰‹é£å»ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "é«˜åº§ä¸Šçš„äº’åŠ¨ç¬é—´å¼•èµ·äº†å››é¢å…«æ–¹çš„ç›®å…‰ã€‚è‹ç©¹å±±æ´¾çš„äººçš†çŸ¥è¿™ä¸¤äººç›¸å¤„æ€ªå¼‚ï¼Œå¥½å¥‡ä¸å…«å¦åœ¨å¸­é—´æ‚„ç„¶æµè½¬ã€‚", mood: 'narrative' },
                    { speaker: 'é½æ¸…è‹', text: "ï¼ˆéš”ç©ºæ‰“é‡ï¼Œæ¯«ä¸é®æ©åœ°å¯¹èº«æ—äººä½è¯­ï¼‰â€¦â€¦çœŸæ˜¯åœ¨æ„å¾—å¾ˆå‘ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†·ç€è„¸æ‰«è§†ä¸€åœˆï¼Œç›®å…‰å¦‚åˆ€ï¼Œå“é€€äº†ä¸å°‘çª¥è§†è€…ï¼‰â€¦â€¦ï¼", mood: 'disdain' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆæ”¾ä¸‹é…’æ¯ï¼Œè½»å£°å›é“ï¼‰â€¦â€¦å—¯ã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å²³æ¸…æºè¿™ç§äººçš„æ€§å­ï¼Œä¼šå› ä¸ºä»€ä¹ˆäº‹æƒ…èµ°ç«å…¥é­”ï¼Ÿè¿˜æ˜¯ä»¥å‰‘å…¥å‘½ï¼Œè¿™ç§æç«¯çš„æ–¹å¼ã€‚ä»€ä¹ˆèƒ½è®©é‚£ä¸ªæ¸©æ–‡å¦‚ç‰ï¼Œè°¦å’Œæœ‰ç¤¼ï¼Œæ°¸è¿œä¸€å‰¯å¤§å®¶é£èŒƒçš„å²³æ¸…æºæŸäº†å¿ƒå¢ƒï¼Ÿ", mood: 'perplexed' },
                    { speaker: 'æ—ç™½', text: "è¶Šæƒ³å¿ƒä¸­è¶Šæœ‰ä¸€è‚¡æ— åç«åœ¨çƒ§ï¼Œéšåœ¨è¡£è¢–ä¸­çš„æ‰‹æ¡å¾—å‘ç™½ï¼Œå®åœ¨å¿ä¸ä½æŠ¬å¤´çœ‹å‘å²³æ¸…æºçš„æ–¹å‘ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¸çœ‹ä¸è¦ç´§ï¼Œä¸€çœ‹äºŒäººå››ç›®ç›¸å¯¹ï¼Œå²³æ¸…æºæœ‰äº›è®¸æ³›ç™½çš„è„¸ä¸Šï¼Œé£å‡ºç¬‘æ„åƒæŸ”å’Œçš„é˜³å…‰åœ¨è¡æ¼¾ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è¢«è¿™ä¸€ç¬‘æ™ƒäº†çœ¼çš„æ²ˆæ¸…ç§‹ï¼Œè™½ç„¶ä¸æƒ³æ‰¿è®¤ï¼Œä½†ä»–çš„ç¡®å¾ˆå–œæ¬¢å²³æ¸…æºè¿™æ ·å†²ç€ä»–ç¬‘ï¼Œç”šè‡³ä¸¤äººåˆ†åˆ«å¤šå¹´ï¼Œè¿˜æ˜¯ä¼šè¢«è¿™æ ·çš„å²³æ¸…æºåˆ†äº†å¿ƒç¥ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å±…ç„¶åˆè¢«ä»–è¿™æ ·ä¸€ç¬‘æ™ƒäº†çœ¼â€¦â€¦æˆ‘å¯çœŸæ˜¯ä¸ªè´±éª¨å¤´ã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "å®´ä¼šæ²¡è¿‡åŠæ²ˆæ¸…ç§‹å°±è‡ªè¯·ç¦»å¼€äº†ï¼Œä»–æƒ³çŸ¥é“çš„å¤ªå¤šäº†ï¼Œä»–è¦è‡ªå·±å»æŸ¥æŸ¥ã€‚", mood: 'narrative' }
                ],
                next: 'chapter4'
            },



            // --- ç¬¬å››ç« ï¼šç¦é˜å¯»è¸ª ---
            'chapter4': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬å››ç« ï¼šç¦é˜å¯»è¸ªã€‘", mood: 'narrative', bg: ASSETS.bg.jinshuge },
                    { speaker: 'æ—ç™½', text: "æ¸…é™å³°çš„ç¦ä¹¦é˜ï¼Œè®°è½½ç€å¤§å¤§å°å°å„å¤„ç¦ä¹¦ï¼Œè¿˜æœ‰ç€æ•´ä¸ªè‹ç©¹å±±æ´¾çš„å²å†Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»ç¬¬äº”å±‚ä¸€è·¯å¾€ä¸Šæ‰¾ï¼Œå¿«è¦å°†ç¬¬å…«å±‚ä¹Ÿå¯»å°½ä¹‹æ—¶ï¼Œæ²ˆæ¸…ç§‹æ‰æ‰¾åˆ°å²³æ¸…æºçš„ä¸€éƒ¨å²å†Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºçš„å²å†Œè¢«ç§˜æ³•å¯†å°ä½äº†ï¼Œä¸Šé¢å…±ä¸¤å±‚ç¦åˆ¶ï¼Œç¬¬ä¸€å±‚å°±æ˜¯å‰æ¸…é™å³°ä¸»å¸¸ç”¨çš„ç¦åˆ¶ï¼Œç„¶è€Œè¿™ç¬¬äºŒå±‚æ˜¯ä¸€å±‚ç§åˆ¶ï¼Œç¦åˆ¶ä¸Šé¢æ•£å‘ç€å²³æ¸…æºçš„æ°”æ¯ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰è¿™æ”¾åœ¨ç¬¬å…«å±‚çš„å²å†Œï¼Œæ˜¯ä¸æ˜¯ç‰¹åœ°ç’ç€ï¼Œæœªæ›¾ç»§ä½çš„ä»–â€¦â€¦", mood: 'perplexed' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä»æ€€ä¸­æå‡ºé‚£å°æœ‰å²³æ¸…æºçµè„‰çš„ç¬¦çº¸ï¼Œå°†ç¬¦çº¸è´´åœ¨ä¸Šé¢ï¼Œå’¬ç ´æŒ‡å°–åœ¨ç¬¦çº¸ä¸Šç”»äº†ä¸€ä¸ªç®€æ˜“çš„é˜µæ³•ï¼Œéšåæ³¨å…¥è‡ªå·±çš„çµåŠ›ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰åæ­£ä¸å¯èƒ½å»æ‰¾å²³æ¸…æºæ¥è§£é™¤ç¦åˆ¶ï¼Œä¸å¦‚æ­»é©¬å½“ä½œæ´»é©¬åŒ»ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "é‡‘å…‰é—ªè¿‡ç¦åˆ¶ç ´ï¼Œç¬¦çº¸æ”¶å›æ€€ä¸­åï¼Œæ²ˆæ¸…ç§‹å°†å²å†Œæ§åœ¨æ‰‹å¿ƒï¼Œæµ‘èº«é¢¤æŠ–ä¹…ä¹…ä¸æ•¢æ‰“å¼€ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¦‚æœè¿™ä¸Šé¢è®°è½½ç€ï¼Œå²³æ¸…æºåœ¨çµæºªæ´èµ°ç«å…¥é­”çš„åŸå› ï¼Œç­”æ¡ˆä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»–æ—¢æƒ³çŸ¥é“ç­”æ¡ˆï¼Œåˆä¸æ•¢çŸ¥é“ç­”æ¡ˆï¼Œå¿ƒä¸­æ³›èµ·ä¸€é˜µå¿ƒæ…Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹åƒä¸€åº§é›•å¡‘ä¸€æ ·ï¼Œæ§ç€é‚£å²å†Œä¹…ä¹…çš„ç«™ç«‹åœ¨é‚£ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å°±åœ¨æ²ˆæ¸…ç§‹èƒ¡æ€ä¹±æƒ³ä¹‹é™…ï¼Œæœ‰ä¸€ä¸ªâ€œäººâ€ä»åèƒŒç¯æŠ±ä½ä»–ï¼Œååˆ†ç†Ÿæ‚‰çš„å—“éŸ³å“èµ·ã€‚", mood: 'narrative' },
                    { speaker: 'å¿ƒé­”å²³æ¸…æº', text: "â€œå°ä¹ï¼Œä¸æ‰“å¼€æ˜¯ä¸æƒ³çŸ¥é“å—ï¼Ÿéœ€è¦æˆ‘å¸®å¿™å—ï¼Ÿæˆ–è€…æ˜¯æˆ‘ç›´æ¥å‘Šè¯‰å°ä¹ï¼Ÿâ€", mood: 'gentle' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æµ‘èº«åƒµç›´ä¸å¾—åŠ¨å¼¹ï¼ŒåŸæœ¬ç¯æŠ±ä½ä»–çš„äººå•æ‰‹æ‚ç€æ²ˆæ¸…ç§‹çš„è…°è½¬åˆ°æ­£é¢æ¥ï¼Œé¡ºç€ä»–çš„æ‰‹æ¥è¿‡ä»–æ‰‹ä¸Šçš„å²å†Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¿ƒé­”æ‰€å¹»åŒ–çš„å²³æ¸…æºï¼Œç›´ç›´æ³¨è§†ç€æ²ˆæ¸…ç§‹çœ¼é‡Œå€’æ˜ çš„éƒ½æ˜¯å¯¹æ–¹çš„èº«å½±ï¼Œçœ¼åº•æ‰ç€ç»†ç¢çš„æ¸©æŸ”ï¼Œé¢ä¸Šå¸¦ç€æµ…æµ…çš„ç¬‘æ„ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æˆ‘æœ¬æ˜¯å–œæ¬¢å²³æ¸…æºå¯¹æˆ‘ç¬‘çš„ï¼Œè¿™æ ·ä¼šè®©æˆ‘æœ‰ä¸€ç§ç‹¬å çš„é”™è§‰ã€‚å¯æ˜¯çœ¼å‰è¿™ä¸ªå¿ƒé­”æ‰€åŒ–çš„å²³æ¸…æºçš„ç¬‘å®¹ï¼Œåªè®©æˆ‘è§‰å¾—æ¶å¿ƒã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "å¿ƒé­”å°±æ˜¯å¿ƒä¹‹æ‰€åŒ–ï¼Œè¶Šå¾—ä¸åˆ°ä»€ä¹ˆï¼Œè¶Šæƒ³å¾—åˆ°ä»€ä¹ˆï¼Œå¿ƒé­”ä¾¿ä¼šå¹»åŒ–å‡ºæ¥ï¼Œæ¥è›Šæƒ‘æœ¬å°Šã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ ¹æœ¬æ— æ³•ç›´è§†è‡ªå·±çš„å¿ƒé­”ï¼Œæˆ–è€…è¯´æ˜¯ä»–æ ¹æœ¬æ— æ³•ç›´è§†è¿™æ ·çš„å²³æ¸…æºã€‚ä¸€ä¸¾ä¸€åŠ¨éƒ½å¸¦ç€åˆ»æ„çš„è®¨å¥½ï¼Œåƒæäº†å¸¸å»ç•™è¿é£æœˆåœºæ‰€ä¹‹åœ°çš„å¥³å­ï¼Œå¸¦ç€è®¨å¥½å’Œå‹¾å¼•â€¦â€¦", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹è¢«è‡ªå·±çš„æƒ³æ³•æ¶å¿ƒçš„å¤Ÿå‘›ï¼Œå¦‚æœä¸æ˜¯å¿ƒå¢ƒä¸ç¨³è¢«å¿ƒé­”æ‰€å›°æ— æ³•åŠ¨å¼¹ï¼Œä»–ä¸€å®šä¸€æ‹³å°±ç…§å‘¼åˆ°å¯¹æ–¹è„¸ä¸Šã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¿ƒé­”æ€ä¹ˆä¼šä¸çŸ¥é“ä»–å¿ƒä¸­æ‰€æƒ³ï¼Ÿå°†æ‰‹ä¸­çš„å²å†Œéšæ„ä¸€ä¸¢ï¼ŒåŒæ‰‹é½ä¸Šï¼Œä¸€æ‰‹æ½ç€è…°æ²ˆæ¸…ç§‹ï¼Œä¸€æ‰‹é¡ºç€å¯¹æ–¹è¡£è¥Ÿå‘é‡Œæ‘¸ç´¢ã€‚", mood: 'narrative' }, //è¿™é‡Œæœ€å¥½æœ‰CG
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å±…ç„¶è¢«é¡¶ç€å²³æ¸…æºçš„è„¸çš„çš„å¿ƒé­”éç¤¼äº†ï¼ç®€ç›´è’å”ï¼", mood: 'shocked' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å¼ºè¡Œå†²å¼€ç©´é“ä¸Šçš„æ¡æ¢ï¼Œä¸€æ‹³ç›´æœå¿ƒé­”é¢é—¨ä¸Šå»ï¼Œä¸è¿‡å¾ˆå¯æƒœï¼Œåœ¨å¼ºè¡Œå†²ç ´æ¡æ¢çš„æ—¶å€™ï¼Œå¿ƒé­”ä¾¿æ¶ˆæ•£äº†ï¼Œè¿™ä¸€æ‹³åªæ‰“äº†ä¸ªç©ºã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "èƒ¸è…”è¡€æ°”ç¿»æ¶Œç»ˆå½’æ˜¯è¢«å¼ºè¡Œå‹ä¸‹ï¼Œæ²ˆæ¸…ç§‹æ‚ç€èƒ¸å£é¢è‰²ç…ç™½ï¼Œå¼¯è…°æ¡èµ·å²å†Œç¿»å¼€æ¥çœ‹ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¯æ˜¯è¿™ä¸Šé¢è®°è½½çš„å†…å®¹å´è®©äººå¤§å¤±æ‰€æœ›ï¼Œåªæ¨¡ç³Šåœ°è®²è¿°äº†æ‰€æœ‰äººéƒ½çŸ¥é“çš„å²³æ¸…æºå½“æŒé—¨å‰çš„ç»å†ï¼Œå¯è¶Šçœ‹è¶Šè§‰å¾—ä¸å¯¹åŠ²ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å‰é¢å‡ é¡µå­—è¿¹èµ°é£æ˜¯ä»–å¸ˆå°Šçš„æ²¡é”™ï¼Œå¯æ˜¯ååŠæœ¬å®Œå…¨ä¸å¯¹ï¼Œè™½ç„¶è¿™å­—è¿¹æœ‰æœ‰ä¸ƒå…«åˆ†ç›¸ä¼¼ï¼Œä½†è¿˜æ˜¯è®©æ²ˆæ¸…ç§‹çœ‹å‡ºäº†äº›ç«¯å€ªã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "é™¤äº†å‰å‡ é¡µæ¯”è¾ƒè¿è´¯ï¼Œå®Œå®Œå…¨å…¨æ²¡æœ‰åŠ¨è¿‡ï¼Œåé¢å‡ ä¹éƒ½æ˜¯ä»¿çš„ã€‚è‹¥éæ²ˆæ¸…ç§‹ååˆ†ç†Ÿæ‚‰ä»–å¸ˆå°Šçš„ç¬”è®°ï¼Œé™©äº›ä¹Ÿçœ‹ä¸å‡ºæ¥ï¼Œå²³æ¸…æºçš„è¿™éƒ¨å²å†Œï¼Œè¢«ç¯¡æ”¹è¿‡ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ç¯¡æ”¹å†…å®¹çš„äººï¼Œæ¯«æ— ç–‘é—®å°±æ˜¯å²³æ¸…æºæœ¬äººã€‚è‡³äºè¿™ç¯¡æ”¹çš„æ—¶é—´ï¼Œåªæœ‰è¿™å‡†å¤‡ç»§ä»»çš„è¿™ä¸€ä¸ªæœˆã€‚", mood: 'perplexed' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰åœ¨çµçŠ€æ´æ—¶ï¼Œå²³æ¸…æºé‚£ä¸€å¹…åšè´¼å¿ƒè™šæ…Œå¿™é€ƒçªœçš„æ ·å­â€¦â€¦ä»–åœ¨åˆ»æ„éšç’ï¼Œè€Œä¸”æ˜¯åœ¨åˆ»æ„éšç’ç€æˆ‘ï¼", mood: 'perplexed' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æˆ‘ä»¬ä¹‹é—´è¿˜æœ‰ä»€ä¹ˆå€¼å¾—ä»–å¦‚æ­¤åˆ»æ„éšç’ï¼Ÿé™¤äº†å¹´å¹¼æ—¶çš„çº¦å®šä¾¿å†æ— å…¶ä»–ã€‚", mood: 'perplexed' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ä»–ä»æ¥éƒ½æ²¡æœ‰æ‰“ç®—å°†çœŸç›¸å‘Šè¯‰è¯´å‡ºæ¥ï¼Œä»–å°±æ˜¯æƒ³è¿™æ ·ä¸€è¾ˆå­ç’ä¸‹å»ï¼è€Œæˆ‘ä¹Ÿæ°¸è¿œéƒ½ç­‰ä¸åˆ°é‚£ä¸ªç­”æ¡ˆï¼Œå“ªæ€•æ˜¯å‡çš„ï¼", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "æƒ³åŠæ­¤å¤„æ²ˆæ¸…ç§‹å†ä¹Ÿå‹åˆ¶ä¸ä½ç¿»æ¶Œçš„æ°”è¡€ï¼Œä¸€å£é²œè¡€ç”Ÿç”Ÿçš„å‘•äº†å‡ºæ¥ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ—ç™½', text: "ä»–çœŸçš„æ°”æ€¥äº†ï¼Œç”¨æ‰‹ç”Ÿç”Ÿçš„å°†è¿™ç”¨ç»¢å¸ƒåŒ…è£¹çš„å²å†Œæ’•æˆäº†ç¢ç‰‡ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ¼çº¢ï¼‰è¿™ä¸€å®šå’Œå²³æ¸…æºä»¥å‰‘å…¥å‘½æœ‰å…³ï¼", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æŠ¹äº†ä¸€æŠŠå˜´è§’æ¸—å‡ºçš„é²œè¡€ï¼Œå°±ç›´æ¥å¾¡å‰‘æ€åˆ°äº†ç©¹é¡¶å³°ã€‚", mood: 'narrative' }
                ],
                next: 'chapter5'
            },


            // --- ç¬¬äº”ç« ï¼šå†³è£‚ä¸çœŸç›¸---
            'chapter5': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬äº”ç« ï¼šå†³è£‚ä¸çœŸç›¸ã€‘", mood: 'narrative', bg: ASSETS.bg.bedroom },
                    { speaker: 'æ—ç™½', text: "ç°åœ¨å·²ç»å…¥å¤œï¼Œå¤§å…¸æ—©å·²ç»“æŸã€‚æ²ˆæ¸…ç§‹ä¸€èº«æˆ¾æ°”ï¼Œä¸€è·¯ä¸Šæ— äººæ•¢æ‹¦ï¼Œè°è§äº†éƒ½æ˜¯é€€é¿ä¸‰èˆï¼Œå“ªæ€•æ˜¯å²³æ¸…æºçš„å¤§å¼Ÿå­ä¹¦ç šéƒ½æ²¡æ•¢é˜»æ‹¦ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¹¦ç šçœ‹ç€ä¸€èº«æˆ¾æ°”é¢è‰²æå…¶é˜´æ²‰çš„æ²ˆå¸ˆå”ï¼ŒåŒ†å¿™èµ¶æ¥è¿å¸¸æœéƒ½æ²¡æ¢ï¼Œæ‰‹ä¸Šæç€é…å‰‘ï¼Œç›´å¥”è‡ªå®¶å¸ˆå°Šå¯æ®¿ï¼Œä»–æœ‰ä¸€ç§æ²ˆå¸ˆå”æ˜¯æ¥å–å¸ˆå°Šå‘ä¸Šäººå¤´çš„é”™è§‰ã€‚", mood: 'narrative' },
                    { speaker: 'ä¹¦ç š', text: "ï¼ˆé»˜é»˜æå‡ºä¼ è®¯ç‰ç‰ŒæŠ¥ä¿¡ï¼‰å¸ˆå°Šï¼Œæ²ˆå¸ˆå”æ·±å¤œæ¥è®¿ï¼", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºå¯æ®¿çš„ç¯ç«è¿˜äº®ç€ï¼Œæ­£ååœ¨èŒ¶å‡ æ—çœ‹ä¹¦ï¼Œåˆšæ”¶åˆ°ä¹¦ç šç»™ä»–å‘çš„ä¼ è®¯è¿˜æ²¡æ¥å¾—åŠçœ‹ï¼Œå¯æ®¿çš„é—¨ç °ï¼ä¸€å£°å·¨å“å°±è¢«äººä¸€è„šè¸¹å¼€ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ—ç™½', text: "æ”¾çœ¼æ•´ä¸ªè‹ç©¹å±±æ´¾èƒ½è¿™ä¹ˆæ¥æ‰¾å²³æ¸…æºçš„é™¤äº†æ²ˆæ¸…ç§‹ï¼Œæ²¡æœ‰ç¬¬äºŒäººäº†ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰ï¼ˆæƒŠå–œï¼‰å°ä¹æ¥æ‰¾æˆ‘äº†ï¼åªæ˜¯ä»–æ­¤åˆ»ä¸€èº«æˆ¾æ°”ï¼Œæç€å‰‘ä¸€å‰¯è¦å–æˆ‘é¡¹ä¸Šäººå¤´çš„æ ·å­â€¦â€¦ä½†åªè¦ä»–è‚¯æ¥æ€»æ˜¯å¥½çš„ã€‚", mood: 'gentle' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰æ¯”èµ·ä»–å¯¹æˆ‘å‡æ„ä½œæ€ï¼Œè¿˜æ˜¯è¿™å‰¯æ ·å­æ›´é²œæ´»äº›â€¦â€¦", mood: 'gentle' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºå°†æ‰‹ä¸Šçš„ä¹¦æœ¬æ”¾åˆ°ä¸€æ—ï¼Œèµ·èº«å»è¿ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä¹Ÿä¸åƒä¸Šæ¬¡ä¸€æ ·ï¼Œåªç«™åœ¨åœ¨é—¨å£ï¼Œè€Œæ˜¯å¤§æ­¥æµæ˜Ÿè¿›äº†æˆ¿é—¨ï¼Œç”šè‡³ç”¨ç»“ç•Œå°†æˆ¿é—¨å°ä¸Šã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è¿™æ˜¯ä»–ä¸å²³æ¸…æºä¹‹é—´çš„ç§äº‹ï¼Œä¸å–œæœ‰å¤–äººæ‰“æ‰°ï¼Œä¹Ÿä¸å–œæœ‰å¤–äººå¬ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çœ‹ç€è¿é¢å‘ä»–èµ°æ¥çš„å²³æ¸…æºï¼Œæ²ˆæ¸…ç§‹æ²¡æœ‰ä¸æ¯«çŠ¹è±«çš„ä¸€æŠŠæ‹½è¿‡ä»–è¡£é¢†å°†äººé‡é‡æŠµåˆ°é—¨ä¸Šï¼Œè¯­æ°”æ¶ç‹ ç‹ ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å²³æ¸…æºï¼Œä½ å½“åˆä¸ºä»€ä¹ˆæ²¡æ¥æ¥æˆ‘ï¼Ÿ", mood: 'angry' },
                    { speaker: 'å²³æ¸…æº', text: "â€¦â€¦", mood: 'guilty' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºåŸæœ¬æå¸¦ç€ç‚¹å–œè‰²çš„ç¥æƒ…ä¸€ä¸‹å˜å¾—å¤±è½èµ·æ¥ï¼Œå¿ƒä¸­æœ‰åƒè¨€ä¸‡è¯­ï¼Œè¯åˆ°å˜´è¾¹ä¾æ—§æ˜¯é‚£å‡ ä¸ªå­—ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "â€¦â€¦å¯¹ä¸èµ·ï¼Œå°ä¹â€¦â€¦æ˜¯æˆ‘å¯¹ä¸èµ·ä½ â€¦â€¦", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "å›ç­”ä»–çš„ä¾æ—§æ˜¯å²³æ¸…æºé‚£æ— ç”¨çš„é“æ­‰ï¼Œæ²ˆæ¸…ç§‹ç¡®ä¿¡äº†ï¼Œå²³æ¸…æºä»–æ°¸è¿œä¸ä¼šå‘Šè¯‰è‡ªå·±ç­”æ¡ˆï¼Œè¿˜ä¸å¦‚è‡ªå·±å»æŸ¥ã€‚å¯æ­¤åˆ»çš„æ²ˆæ¸…ç§‹ç®€ç›´è¦è¢«æ°”ç–¯äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰æœ€è®¨åŒä½ çš„å¯¹ä¸èµ·ã€‚æˆ‘è¦ç­”æ¡ˆï¼Œè¦è§£é‡Šï¼Œä¸ºä»€ä¹ˆå›ç­”æˆ‘çš„åªæœ‰å¯¹ä¸èµ·ï¼Ÿä½ åˆ°åº•æœ‰å¤šå¯¹ä¸èµ·æˆ‘ï¼Ÿèƒ½æŠŠå¯¹ä¸èµ·è¯´äº†æ•´æ•´å››å¹´ï¼Œç”šè‡³å°†çœŸç›¸æ©ç›–ï¼Œæ€ä¹ˆæˆ‘æ²ˆæ¸…ç§‹å°±ä¸é…çŸ¥é“ç­”æ¡ˆï¼Ÿå°±æ´»è¯¥è¢«ç’ä¸€è¾ˆå­ï¼Ÿ", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å•æ‰‹æŠ½å‡ºä¿®é›…ï¼Œå°†å‰‘æ¨ªåœ¨å²³æ¸…æºå–‰é—´ï¼Œå°†å–‰å‰‘çš„çš®è‚¤è´´çš„å¾ˆè¿‘ï¼ŒåŸæœ¬æç€å¯¹æ–¹è¡£è¥Ÿçš„æ‰‹æ­¤åˆ»ï¼Œæç€å²³æ¸…æºä¸‹å·´å¼ºè¿«å²³æ¸…æºä¸è‡ªå·±å¯¹è§†ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å²³æ¸…æºé™¤äº†å¯¹ä¸èµ·ï¼Œä½ å°±æ²¡æœ‰åˆ«çš„è¯è¦å¯¹æˆ‘è¯´äº†ï¼Œè¿˜æ˜¯è¯´ä½ æˆ‘ä¹‹é—´åªé…è¯´è¿™ä¸‰ä¸ªå­—ã€‚", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºçœ¼å«æš—å…‰ï¼Œå£°éŸ³æœ‰äº›æš—å“‘ï¼Œç»ˆäºå°†å¿ƒä¸­åŸ‹è—å¤šå¹´çš„è¯è¯´å‡ºäº†å†°å±±ä¸€è§’ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘ä¼šè¡¥å¿å°ä¹ï¼Œå°ä¹æƒ³è¦ä»€ä¹ˆéƒ½å¯ä»¥ã€‚", mood: 'guilty' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "è¡¥å¿ï¼Ÿå‘µã€‚ä½ å°±æƒ³è¿™ä¹ˆæŠŠæˆ‘æ‰“å‘äº†ï¼Œä¸€ä¸ªç ´è¡¥å¿ã€‚", mood: 'disdain' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆè®¤çœŸï¼‰ä¸æ˜¯ä¸€ä¸ªè¡¥å¿ï¼Œæ˜¯æƒ³è¦ä»€ä¹ˆéƒ½å¯ä»¥â€¦æ²¡æœ‰æœŸé™ï¼Œæ²¡æœ‰æ•°é‡ï¼Œä¹Ÿæ²¡æœ‰é™åˆ¶ã€‚", mood: 'guilty' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºè¯´ç½¢ç”¨æ‰‹æ¡ä½æ²ˆæ¸…ç§‹æŒå‰‘çš„æ‰‹ï¼Œå‘è‡ªå·±å–‰é—´æŒ‰äº†æŒ‰ï¼Œåˆè¡¥å……äº†ä¸€å¥ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "åŒ…æ‹¬æˆ‘çš„å‘½ã€‚", mood: 'guilty' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å“ˆï¼è¦ä½ çš„å‘½ï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Ÿæˆ‘è¿˜ä¸å¦‚è¦è‹ç©¹å±±æ´¾çš„æŒæƒï¼ŒæŒé—¨èƒ½ç»™æˆ‘å—ï¼Ÿä¸è¿‡æ˜¯æ‹¿æˆ‘åœ¨å–ä¹è¯´çš„è·ŸçœŸçš„ä¸€æ ·ã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "ç›´åˆ°å²³æ¸…æºå°†æŒé—¨ä»¤ï¼Œäº²æ‰‹äº¤åˆ°æ²ˆæ¸…ç§‹æ‰‹ä¸Šï¼Œæ²ˆæ¸…ç§‹é‚£æ»¡è„¸ä¸å±‘çš„è¡¨æƒ…ç»ˆäºæ˜¯å´©äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å²³æ¸…æºçœŸçš„æœ‰ç—…ï¼ŒæŒé—¨ä»¤éƒ½èƒ½ç»™ï¼ŒçœŸç›¸è¯´ä¸å¾—ã€‚", mood: 'shocked' },
                    {
                        mood: 'narrative',
                        text: "æ²ˆæ¸…ç§‹ä¼šæ€ä¹ˆåšï¼Ÿ",
                        choice: [
                            { label: "æ„¤æ€’çš„å°†ä»¤ç‰Œæ‰”å›å»", target: "chapter5_duel" },
                            { label: "å†·æ¼ çš„æ”¶ä¸‹ä»¤ç‰Œ", target: "chapter5_be1" }
                        ]
                    }
                ]
            },

            // --- Branch A: Duel (Original Path) ---
            'chapter5_duel': {
                lines: [
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å°†ä»¤ç‰Œé‡æ–°å¡å›å²³æ¸…æºçš„æ‰‹ä¸­ï¼Œå°†å¯¹æ–¹ä»é—¨è¾¹æ¨å¼€ï¼Œæ’¤äº†ç»“ç•Œï¼Œæ„¤æ€’çš„è¸¹å¼€é—¨åˆèµ°äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "çœŸæ˜¯æ¥ä¹ŸåŒ†åŒ†ï¼Œå»ä¹ŸåŒ†åŒ†ã€‚å¯¹äºæ²ˆæ¸…ç§‹æ¥è¯´ï¼Œè¿™ä¸€æ‹³çœŸæ˜¯æ‰“åˆ°æ£‰èŠ±ä¸Šäº†ã€‚", mood: 'narrative' },

                    // Next morning and Duel
                    { speaker: 'æ—ç™½', text: "ç¬¬äºŒæ—¥æ¸…æ™¨ï¼Œæ²ˆæ¸…ç§‹ååœ¨ç«¹èˆçš„è´µå¦ƒæ¦»ä¸Šã€‚", mood: 'narrative', bg: ASSETS.bg.bamboo_day },
                    { speaker: 'æ—ç™½', text: "ä»–æ²¡å»æ™¨ä¼šï¼ŒåŸå› å¾ˆç®€å•ï¼Œä»–ç°åœ¨æ ¹æœ¬ä¸æƒ³è§åˆ°å²³æ¸…æºï¼Œè‡³äºå…¶ä»–å³°ä¸»ä¼šæ€ä¹ˆç¼–æ’ï¼Œå·²ç»æ— æ‰€è°“äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–åœ¨æ€è€ƒæ‰¾ä¸€ä¸ªä»€ä¹ˆæ ·çš„ç†ç”±è¿›å…¥çµçŠ€æ´ï¼Œä¸è¢«å²³æ¸…æºå¯Ÿè§‰åˆ°å¼‚æ ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¸€ä¸ªæ—¶è¾°åï¼Œå²³æ¸…æºçš„å¤§å¼Ÿå­ä¹¦ç šæ¥äº†ï¼Œä»–è·ªåœ¨åœ¨æ²ˆæ¸…ç§‹é¢å‰ï¼Œå°†æŒé—¨ä»¤åŒæ‰‹ä¸¾è¿‡å¤´é¡¶å‘ˆç»™æ²ˆæ¸…ç§‹ã€‚", mood: 'narrative' },
                    { speaker: 'ä¹¦ç š', text: "ä»¤ç‰Œæ˜¯ä»Šæ—©æ™¨ä¼šå†³å®šçš„ï¼Œå¸ˆå°Šäº²è‡ªè®©å¼Ÿå­ç»™æ²ˆå¸ˆå”é€æ¥ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "è¨€å¤–ä¹‹æ„ä¾¿æ˜¯ï¼Œå²³æ¸…æºå·²åŠ›æ’ä¼—è®®ï¼Œè¿™ä»¤ç‰Œæ²ˆæ¸…ç§‹æ‹¿çš„å…‰æ˜æ­£å¤§ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†·ç¬‘ï¼Œåå¸¸çš„æ”¶äº†ä»¤ç‰Œï¼‰é€€ä¸‹å§ï¼å›å»è®°å¾—å‘Šè¯‰ä½ å¸ˆå°Šï¼Œè¿™è¡¥å¿æˆ‘å¾ˆå–œæ¬¢ã€‚", mood: 'disdain' },
                    { speaker: 'ä¹¦ç š', text: "æ˜¯ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "ä¹¦ç šå¬çš„ä¸€æŠ–ï¼Œè¿…é€Ÿèµ·èº«ï¼Œæ’’ä¸«å­å°±è·‘ã€‚å†…å¿ƒä¸ç”±è¯‰è‹¦æ°´ï¼Œå¸ˆå°Šä¸æ²ˆå¸ˆå”ä¸¤äººç”Ÿæ°”ï¼Œè€æ‹¿ä»–åœ¨ä¸­é—´ç£¨ç®—ä»€ä¹ˆï¼Ÿ", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ˜¯æ—¥åˆæ—¶ï¼ŒæŸ³æ¸…æ­Œæ”¶åˆ°äº†æ²ˆæ¸…ç§‹çš„æ‹œå¸–ã€‚", mood: 'narrative', bg: ASSETS.bg.qingjing_houshan },
                    { speaker: 'æŸ³æ¸…æ­Œ', text: "ï¼ˆå†…å¿ƒï¼‰è‹¥æ¢ä½œå¾€å¸¸æˆ‘æ˜¯ç»å¯¹ä¸ä¼šå»çš„ï¼Œå¯ä»Šæ—¥ä¸åŒã€‚ä»Šæ—©æ™¨ä¼šæŒé—¨å¸ˆå…„ç«Ÿä¸ºäº†æ²ˆæ¸…ç§‹è¿™å‘é„™å°äººå°†ä¼—äººå µå¾—å“‘å£æ— è¨€ï¼Œç”šè‡³è¿æŒé—¨ä»¤éƒ½äº¤äº†å‡ºå»ã€‚", mood: 'angry' },
                    { speaker: 'æ—ç™½', text: "è§é¢åæŸ³æ¸…æ­Œå’Œæ²ˆæ¸…ç§‹ä¸€è¨€ä¸åˆæ‰“èµ·æ¥äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¸¤äººäº¤æ‰‹ï¼Œå‰‘å…‰é—ªçƒã€‚æŸ³æ¸…æ­Œä¸€ä¸ªå›æ—‹ï¼Œå‰‘å°–ç”»å‡ºä¸€é“ä¼¶ä¿çš„å¼§çº¿ï¼ŒçŒ›ç„¶åˆºå‘æ²ˆæ¸…ç§‹ã€‚æ²ˆæ¸…ç§‹ååº”è¿…é€Ÿï¼Œä¸€è®°åæŒ¡ï¼Œå‰‘ä¸å‰‘ä¹‹é—´ç¢°æ’å‡ºç«èŠ±ã€‚é‡‘å±ç¢°æ’çš„å°–é”å£°éŸ³åœ¨ç©ºæ°”ä¸­å›è¡ï¼Œå‰‘ä¸å‰‘çš„äº¤é”‹ï¼Œç¬é—´ç‚¹ç‡ƒäº†ç´§å¼ çš„æ°”æ°›ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æœ‰é“æ˜¯åŸé—¨å¤±ç«ï¼Œæ®ƒåŠæ± é±¼ã€‚çœ‹ç€å¸ˆå°Šå’ŒæŸ³å¸ˆå”æ‰“èµ·æ¥çš„æ˜å¸†ï¼Œé€Ÿé€Ÿé€šçŸ¥äº†å²³æ¸…æºã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºèµ¶æ¥çš„å¾ˆå¿«ï¼Œä½†ä¹Ÿå¿«ä¸è¿‡ä»–ä»¬ä¸¤ä¸ªäººæ­¤æ—¶å·²ç»å¿…ç°çš„æ€æ‹›ï¼Œä¸¤äººèº«å½¢å¿«é€Ÿç§»åŠ¨ï¼Œå˜åŒ–æ”»åŠ¿ï¼Œå‰‘æ³•ä¸€æ°”å‘µæˆã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºç¬èº«æ¥åˆ°ä¸¤äººä¸­é—´ï¼Œæ‰“ç®—ä»¥ä¿®ä¸ºå¼ºå‹ä¸‹äºŒäººçš„å‰‘æ„ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä¸æŸ³æ¸…æ­ŒäºŒäººçœ‹åˆ°å¼ºè¡Œæ¨ªåœ¨ä¸­é—´çš„å²³æ¸…æºï¼ŒæŸ³æ¸…æ­Œå·²ç»æ¥ä¸åŠæ”¶æ‰‹äº†ï¼Œå¸¦ç€çµåŠ›å’Œå‰‘æ„ç›´ç›´çš„åˆºäº†è¿‡å»ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä¸è¿‡è¿˜å¥½ï¼Œå²³æ¸…æºä¿®ä¸ºé«˜è¿˜æ˜¯å¼ºå‹ä¸‹äº†å¾ˆå¤šå‰‘æ„å’Œè£¹æ‚è¿‡æ¥çš„çµåŠ›è¿™ä¸‹è™½ç„¶ä¼šè®©ä»–å—ä¼¤ï¼Œä½†ä¹Ÿä¸è‡³äºä¼¤é‡ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è€Œæ²ˆæ¸…ç§‹åˆ™æ˜¯ä¸åŒï¼Œç¡¬ç”Ÿç”Ÿçš„æ‹äº†ä¸ªå¼¯å‰‘æ°”å›æµï¼ŒåŠˆå‘å³°é¡¶å³°é¡¶ç•™ä¸‹äº†æ·±æ·±çš„æ²Ÿå£‘ï¼Œè¢«å‰‘æ°”é€†æµå†²å‡»çš„ç»è„‰å¯ä¼¤çš„ä¸è½»ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹åƒæ˜¯è„±äº†åŠ›ï¼Œä»åŠç©ºå¾„ç›´å‘ä¸‹å å»ã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆçœ‹åˆ°å²³æ¸…æºæ»¡è„¸æ‹…å¿§å‘ä»–é£é€Ÿé£æ¥çš„èº«å½±ï¼‰ï¼ˆæ„è¯†æ¨¡ç³Šï¼‰è®¡åˆ’æˆäº†ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "ä¸¤å³°å³°ä¸»å…¬ç„¶æ–—æ®´ï¼Œè¿™ä¸€æˆ˜æŸ³æ¸…æ­Œè¢«ç½šç¦é—­ï¼Œæ²ˆæ¸…ç§‹åˆ™æ˜¯å†…ä¼¤è¿‡é‡ï¼Œå…¥çµçŠ€åŒé—­å…³ä¿®å…»ã€‚", mood: 'narrative' },

                    // Truth revealed in Lingxi Cave
                    { speaker: 'æ—ç™½', text: "ä¸€æ—¶ä¹‹é—´ï¼Œè‹ç©¹å±±æ´¾å†…éƒ¨çš„å…«å¦çœŸæ˜¯è¢«è¿™ä¸‰ä½ç‚¹ç‡ƒäº†ã€‚", mood: 'narrative', bg: ASSETS.bg.lingxicave },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰è¿™ä¸¤å¤©ï¼Œæ¸…ç§‹çš„ä¸¾åŠ¨å®åœ¨æ˜¯å¤ªå¼‚å¸¸äº†ã€‚å·¦æ€å³æƒ³ï¼Œå§‹ç»ˆä¸å¾—å…¶è§£ã€‚", mood: 'worried' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰éš¾é“ä»æ”¶ä¸‹æŒé—¨ä»¤å¼€å§‹ï¼Œä»–å°±æ˜¯ä¸ºäº†é‡ä¼¤ä¿®å…»ï¼Ÿæˆ–è€…è¯´â€¦â€¦ä»…ä»…æ˜¯ä¸ºäº†é¿å¼€æˆ‘ï¼Ÿ", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "çµçŠ€æ´æ˜¯å²³æ¸…æºæœ€ä¸æ„¿æ„æ¥çš„åœ°æ–¹ï¼Œæ¯•ç«Ÿæ›¾ç»è‹¦ç¦åœ¨è¿™é‡Œï¼Œåªè¦é è¿‘è¿™é‡Œåƒæ˜¯é£é¸Ÿå…¥äº†ç‰¢ç¬¼ï¼Œå†ä¹Ÿæ— æ³•é€ƒè„±çš„ä¸€æ ·ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²‰é—·çš„å‹æŠ‘æ„Ÿç¬¼ç½©åœ¨å²³æ¸…æºå¿ƒå¤´ï¼Œå¯ä»–è¿˜æ˜¯ä¸€ç›´å¾€é‡Œèµ°ï¼Œå¯»æ‰¾ç€é‚£ä¸ªé’è¡£èº«å½±ï¼Œå¼€æ”¾æ´åºœä»–éƒ½æ‰¾äº†ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°ä»–æƒ³è§çš„äººï¼Œé™¤äº†å‰ä¸ä¹…è¢«ä»–å°ç¦çš„åœ°æ–¹ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å¿ƒä¸­é™¡ç„¶å‡èµ·ä¸€è‚¡å¿ƒæ…Œï¼Œæ‰‹æŒ‡æå†³ç¼©åœ°æˆå½±ä¸€ç¬å°±æ¥åˆ°äº†è¢«ä»–å°ç¦çš„æ´åºœå‰ï¼Œå°ç¦ç»“ç•Œæœªç ´ï¼Œå¯ä»–åˆ†æ˜æ„Ÿå—åˆ°äº†ç»“ç•Œä¸­æœ‰äººã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è¿…é€Ÿå…¥äº†ç»“ç•Œå†…ï¼Œä¸€è‚¡å­è¡€è…¥å‘³ç¬é—´å¼¥æ¼«ä¸Šæ¥ï¼Œæ´åºœä¸­åˆ»æ»¡äº†æŸ“è¡€çš„çµç¯†ï¼Œæ²ˆæ¸…ç§‹ä¸€èº«é’è¡£æŸ“ä¸Šå¤§ç‰‡å¤§ç‰‡è¤è‰²çš„æ–‘é©³ç›˜è…¿ååœ¨çŸ³é˜¶ä¸Šï¼Œè€³ç›®å£ä¸‰çªçš†å¾€å‡ºæ¸—è¡€ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ååœ¨çŸ³é˜¶ä¸Šçš„äººä¼¼ä¹è¿˜æœ‰äº›æ„è¯†ï¼Œè½»çœ¨äº†ä¸€ä¸‹æ»¡æ˜¯è¡€æ³ªçš„çœ¼ï¼Œçœ‹å‘å²³æ¸…æºçš„æ–¹å‘ï¼Œæ‰¯å‡ºäº†ä¸€ä¸ªè‹¦æ¶©æ— æ¯”çš„ç¬‘å®¹ï¼Œæ··ç€è„¸ä¸Šçš„è¡€ä¸æ³ªçœ‹èµ·æ¥å¯è„†å¼±æäº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºä¸Šå‰æƒ³ä¸ºæ²ˆæ¸…ç§‹ç–—ä¼¤ï¼Œå¯åªæ˜¯åˆšé è¿‘å°±è¢«å¯¹æ–¹ä»¥æŒé—¨ä»¤æ‰€æ§æ— æ³•åŠ¨å¼¹ï¼Œå‹åœ¨äº†çŸ³é˜¶ä¹‹ä¸Šã€‚", mood: 'narrative', shake: true },
                    { speaker: 'æ—ç™½', text: "è§†è§’æ™ƒåŠ¨æ²ˆæ¸…ç§‹ååœ¨å²³æ¸…æºè…°èº«ä¸Šï¼Œæ­»æ­»çš„å‹ç€å¯¹æ–¹ï¼Œæ°å¼€å¯¹æ–¹çš„å˜´ï¼Œå°†ä¸€å¼ ä»™å“åçœŸç¬¦ä¸€ä¸‹å­å¡äº†è¿›å»ï¼Œè½¬è€Œåˆç”¨æ†çº¿ç´¢å°†äººç»™æ†äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å®Œæˆè¿™äº›åªæ˜¯ä¸€æ¯çš„åŠŸå¤«ï¼ŒæŒé—¨ä»¤ä¹Ÿåªèƒ½å‹åˆ¶å²³æ¸…æºè¿™ä¸€æ¯çš„æ—¶é—´ï¼Œä¸è¿‡ï¼Œå¯¹äºæ²ˆæ¸…ç§‹æ¥è¯´ï¼Œè¶³å¤Ÿäº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ä»–å†…ä¼¤å¾ˆé‡ï¼Œæ€¥éœ€æ²»ç–—ï¼Œå¯ä»Šæ—¥å°±ç®—æ˜¯æ­»ï¼Œä»–ä¹Ÿè¦æŠŠå²³æ¸…æºçš„å˜´æ’¬å¼€ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å²³æ¸…æºï¼Œä½ å‡­ä»€ä¹ˆä¸å‘Šè¯‰æˆ‘ï¼Œä½ æ¥æ¥è¿‡æˆ‘ï¼", mood: 'angry', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ä½ å‡­ä»€ä¹ˆä¸å‘Šè¯‰æˆ‘ï¼Œä½ åœ¨çµçŠ€æ´èµ°ç«å…¥é­”ï¼Œä»¥å‰‘å…¥å‘½ï¼ŒåºŸåŠŸé‡æ¥ï¼", mood: 'angry', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ä½ å‡­ä»€ä¹ˆä¸å‘Šè¯‰æˆ‘ï¼Œä½ åœ¨çµçŠ€æ´å·®ç‚¹å»äº†ä¸€æ¡å‘½ï¼", mood: 'angry', shake: true },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å²³æ¸…æºä½ å‡­ä»€ä¹ˆç’ç€æˆ‘ï¼è¯´å•Šï¼å‡­ä»€ä¹ˆï¼Ÿ", mood: 'angry', shake: true },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä¼¤çš„å¤ªé‡ï¼Œæƒ…ç»ªè¿‡æ¿€æ°”è¡€ç¿»æ¶Œï¼Œæ¯è¯´ä¸€å¥è¯éƒ½å¸¦ç€æµ“é‡çš„è¡€è…¥å‘³ï¼Œæœ€åä¸€å¥è¯å‡ ä¹æ˜¯å¼å‡ºæ¥çš„ï¼Œè¡€çº¢ç€çœ¼ï¼Œç¥æ€åŠé¢ åˆç‹‚ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºç´§å’¬ç‰™å…³ä¸è‚¯å¼€å£ã€‚æ²ˆæ¸…ç§‹æ­¤åˆ»å“ªä¼šç»™ä»–è¿™ç§æœºä¼šï¼Ÿå¼ºç¡¬çš„æ°å¼€èº«ä¸‹äººçš„ç‰™å…³ï¼Œå°†å³æ‰‹æ‹‡æŒ‡æ­åœ¨å¯¹æ–¹ç‰™å…³å¤„ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å¿«è¯´ï¼Œå²³æ¸…æºä½ å¹³æ—¶ä¸æ˜¯å¾ˆçˆ±è¯´å—ï¼Ÿç°åœ¨æ€ä¹ˆæ²‰é»˜äº†ï¼Ÿä½ è¦æ˜¯éè¦ç¡¬å¿ï¼Œé‚£å°±æŠŠæˆ‘çš„æ‰‹æŒ‡å’¬æ–­ã€‚", mood: 'angry' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ— æ‰€è°“çš„ï¼Œè¿™ç‚¹ç–¼æˆ‘è¿˜æ˜¯å—å¾—äº†ï¼Œä½ ä¸è¯´æˆ‘å°±è€—æ­»åœ¨è¿™ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "æˆ–è®¸æ˜¯æ²ˆæ¸…ç§‹è€—æ­»åœ¨è¿™å¤ªåˆºæ¿€å²³æ¸…æºäº†ï¼Œæˆ–è®¸æ˜¯ç¬¦çº¸èµ·äº†ä½œç”¨ï¼Œå²³æ¸…æºç»ˆäºå¼€å£äº†ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘æœ‰ä»€ä¹ˆèµ„æ ¼å‘Šè¯‰ä½ è¿™äº›ï¼Œæ˜¯æˆ‘å®³å°ä¹å…¥äº†ç§‹åºœï¼Œæ˜¯æˆ‘æ²¡èƒ½æ¥åˆ°å°ä¹ï¼Œè®©å°ä¹æ‹œäº†æ— åŒå­ä¸ºå¸ˆã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "æ˜¯æˆ‘æ¨ç€ä½ ä¸€æ­¥ä¸€æ­¥å…¥äº†æ­§é€”ã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘å‘Šè¯‰å°ä¹è¿™äº›åšä»€ä¹ˆï¼Ÿåšå–åŒæƒ…å—ï¼Ÿ", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆä¸å¯ç½®ä¿¡ï¼‰ä½ æœ‰ç—…å§ï¼Ÿå®³æˆ‘å…¥ç§‹åºœçš„æ˜æ˜æ˜¯åäº”ï¼Œæˆ‘ä»¬æ•‘äº†ä»–ï¼Œä»–å´å¿˜æ©è´Ÿä¹‰å‡ºå–æˆ‘ã€‚", mood: 'shocked' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ²¡æ¥åˆ°æˆ‘ï¼Œæ˜¯ä½ æ²¡æ¥åˆ°æˆ‘çš„äº‹ã€‚", mood: 'angry' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ‹œæ— åŒå­ä¸ºå¸ˆï¼Œæ˜¯æˆ‘å½“åˆçœ¼çå’Œä½ æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ", mood: 'angry' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰ä»–ä¸¥é‡æ€€ç–‘ä»–æ²ˆæ¸…ç§‹ä»Šå¤©å“ªæ€•æ˜¯éšä¾¿æ…æ­»ä¸€ä¸ªäººï¼Œå²³æ¸…æºéƒ½èƒ½ä»¥è‡ªå·±æ•™å¯¼æ— æ–¹æŠŠè´£ä»»æ½åˆ°è‡ªå·±èº«ä¸Šã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆæ¿€åŠ¨ï¼‰å¦‚æœä¸æ˜¯æˆ‘æ‰§æ„è¦æ•‘åäº”ï¼Œä½ åˆæ€ä¹ˆä¼šå…¥ç§‹åºœï¼Ÿæ€ä¹ˆä¼šæ‹œæ— åŒå­ä¸ºå¸ˆï¼Ÿ", mood: 'angry' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å²³æ¸…æºè¿™ä¸ªäººæŠŠåœ¨ä»–èº«ä¸Šå‘ç”Ÿçš„æ‰€æœ‰çš„äº‹éƒ½æ½åˆ°äº†è‡ªå·±èº«ä¸Šï¼Œé‚£äº›æœ‰å…³ä»–çš„æ— å…³ä»–çš„è¿˜æ˜¯å’Œä»–é—´æ¥ç›¸å…³çš„ï¼Œä»–ç»Ÿç»Ÿéƒ½æ½åˆ°è‡ªå·±èº«ä¸Šã€‚", mood: 'neutral' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ‰€ä»¥ä½ å°±ä»€ä¹ˆéƒ½ä¸å‘Šè¯‰æˆ‘ï¼Œéšç’æˆ‘ï¼Œè®©æˆ‘ä¸€ç›´è¿™ä¹ˆä¸æ˜ä¸ç™½çš„æ¨ç€ä½ ã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå¹³é™ï¼‰å°ä¹ï¼Œè¯¥æ¨æˆ‘çš„ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "æ˜æ˜ä¿ƒæˆè¿™äº›çš„äººé‚£ä¹ˆå¤šï¼Œç”šè‡³ä¸€ç¯æ‰£ä¸€ç¯ï¼Œå°‘ä¸€ä¸ªäººéƒ½é€ æˆä¸äº†ä»Šå¤©è¿™ä¸ªå±€é¢ã€‚å²³æ¸…æºè¿™äº›é”™è¯¯é€šé€šæ½åˆ°äº†è‡ªå·±èº«ä¸Šã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æˆ–è®¸ä»ä»–å¤±çº¦çš„æ—¶å€™å¼€å§‹ï¼Œå²³æ¸…æºå°±å°†è‡ªå·±ç‹ ç‹ åœ°é’‰åˆ°äº†è€»è¾±æŸ±ä¸Šï¼Œå¦ç„¶çš„æ¥å—äº†æ²ˆæ¸…ç§‹å¯¹ä»–çš„ä¸€åˆ‡æ¶æ„ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹é¢è‰²è‹ç™½ï¼Œè§£å¼€äº†å²³æ¸…æºèº«ä¸Šçš„æ†çº¿ç´¢ï¼Œå²³æ¸…æºèµ·èº«å°†äººæŠ±åœ¨æ€€é‡Œï¼Œæºæºä¸æ–­åœ°è¾“é€ç€çµåŠ›ï¼Œç¨³ä½å¯¹æ–¹çš„ä¼¤åŠ¿ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ä¼¤çš„é‡ï¼Œåˆšåˆšæƒ…ç»ªæ¿€åŠ¨çœŸæ°”ä¹±è¡Œï¼Œåˆæ˜¯ä¼¤ä¸ŠåŠ ä¼¤ï¼Œçœ¼å‰é˜µé˜µå‘é»‘ï¼Œå‡ ä¹åˆè¦æ˜è¿‡å»ï¼Œå¯å´æ­»æ­»æªç€çš„è¡£è§’å²³æ¸…æºä¸æ’’æ‰‹ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆè™šå¼±ï¼‰å²³æ¸…æºæˆ‘æ¨çš„åªæœ‰ä½ ä¸ºäº†è£åå¯Œè´µå¼ƒäº†æˆ‘ï¼Œå¯ä½ æ²¡æœ‰â€¦â€¦è¿˜æœ‰æ•‘ä½ æ˜¯æˆ‘è‡ªå·±é€‰çš„ï¼Œæˆ‘ä¸ä¼šæ”¹çš„ã€‚", mood: 'sorrow' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ï¼ˆå†…å¿ƒï¼‰å“ªæ€•å†å²é‡æ¼”ï¼Œå“ªæ€•æ—¶é—´é‡æ¥ï¼Œå“ªæ€•çŸ¥é“ä»£ä»·æ˜¯ä»€ä¹ˆï¼Œé‚£æ—¶çš„æ²ˆä¹éƒ½ä¼šä¹‰æ— åé¡¾çš„æ•‘å²³ä¸ƒçš„ã€‚", mood: 'neutral' }
                ],
                next: 'chapter6'
            },

            // --- Branch B: Estranged (Bad Ending 1) ---
            'chapter5_be1': {
                lines: [
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å¥½ï¼Œæ—¢ç„¶ä½ ç»™ï¼Œé‚£æˆ‘å°±æ”¶ç€ã€‚", mood: 'disdain' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹ç´§ç´§æ¡ä½é‚£æšæŒé—¨ä»¤ï¼ŒæŒ‡èŠ‚æ³›ç™½ã€‚ä»–çœ‹ç€é¢å‰è¿™ä¸ªæ„¿æ„ä»˜å‡ºä¸€åˆ‡çš„ç”·äººï¼Œå¿ƒä¸­é‚£å›¢ç«å´æ¸æ¸åŒ–ä½œäº†å†°å†·çš„ç°çƒ¬ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ—¢ç„¶æˆ‘ä»¬ä¹‹é—´åªå‰©ä¸‹è¿™äº›ï¼Œé‚£ä¾¿å¦‚æ­¤å§ã€‚ä»ä»Šå¾€åï¼Œæˆ‘ä»¬æ˜¯æŒé—¨å’Œå³°ä¸»ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå†æ— ç“œè‘›ã€‚", mood: 'neutral' },
                    { speaker: 'å²³æ¸…æº', text: "å°ä¹â€¦â€¦", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºä¼¸å‡ºçš„æ‰‹åƒµåœ¨åŠç©ºï¼Œæœ€ç»ˆæ— åŠ›åœ°å‚ä¸‹ã€‚ä»–çœ‹åˆ°äº†å¯¹æ–¹çœ¼ä¸­çš„å†³ç»ï¼Œé‚£æ¯”æ¨æ„æ›´è®©ä»–ç»æœ›çš„ï¼Œæ˜¯æ— è¾¹æ— é™…çš„å†·æ¼ ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹è½¬èº«ç¦»å»ï¼Œè¿™ä¸€æ¬¡ï¼Œä»–æ²¡æœ‰å›å¤´ï¼Œä¹Ÿæ²¡æœ‰æ„¤æ€’çš„è¸¹é—¨ï¼Œåªæ˜¯å¹³é™åœ°èµ°å‡ºäº†å²³æ¸…æºçš„ä¸–ç•Œã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "è‡ªæ­¤ä¹‹åï¼Œè‹ç©¹å±±æ´¾å¤šäº†ä¸€åŒå…¬äº‹å…¬åŠçš„å¸ˆå…„å¼Ÿã€‚", mood: 'narrative' }
                ],
                next: 'ending_be1'
            },

            // --- ç¬¬å…­ç« ï¼šè¿Ÿæ¥çš„é—®å€™ ---
            'chapter6': {
                lines: [
                    { speaker: 'æ—ç™½', text: "ã€ç¬¬å…­ç« ï¼šå®ˆå¾—äº‘å¼€ã€‘", mood: 'narrative', bg: ASSETS.bg.clinic },
                    { speaker: 'æ—ç™½', text: "ä¸€æœˆåã€‚åƒè‰å³°ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "ç—…åºŠä¸Šèººç€çš„æ²ˆæ¸…ç§‹é¢æ— è¡€è‰²ï¼Œå˜´å”‡å‘ç™½ï¼Œæ¯«æ— ç”Ÿæœºï¼Œå¦‚æœä¸æ˜¯è¿˜æœ‰æ¸…æµ…çš„å‘¼å¸ï¼Œå¾ˆéš¾ç›¸ä¿¡è¿™ä¸Šé¢èººç€çš„äººè¿˜æ´»ç€ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰æˆ‘æ€ä¹ˆéƒ½æ²¡æœ‰æƒ³åˆ°äº‹æƒ…ä¼šå‘ç”Ÿåˆ°è¿™ç§åœ°æ­¥ï¼Œæ˜æ˜åªæ˜¯åŠæ—¥æœªè§ï¼Œä½ ç«Ÿä¼¤å¾—è¿™ä¹ˆé‡ï¼Œè¿˜é™©äº›ä¸§å‘½ã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰æ´å£ä¸Šåˆ»æ»¡çš„é—®çµç¬¦ç¯†ï¼Œç¦ä¹¦é˜è¢«æ’•æ¯çš„å²å†Œï¼Œè¿˜æœ‰é‚£æ—¥çš„è´¨é—®â€¦â€¦æˆ‘ç°åœ¨æ˜ç™½ä½ ä¸ºä½•è¦è¿™ä¹ˆåšäº†ã€‚", mood: 'sorrow' },
                    { speaker: 'å²³æ¸…æº', text: "ï¼ˆå†…å¿ƒï¼‰ä¸ºäº†ä¸€ä¸ªç­”æ¡ˆï¼Œä¸€ä¸ªæˆ‘æ€ä¹ˆéƒ½ä¸ä¼šè¯´çš„ç­”æ¡ˆã€‚æˆ‘è¿™ä¸€ç”Ÿï¼Œä¼¼ä¹éƒ½åœ¨åšä»¤è‡ªå·±åæ‚”çš„é€‰æ‹©ã€‚", mood: 'sorrow' },
                    { speaker: 'æ—ç™½', text: "æˆ¿é—¨è¢«æ¨å¼€æœ¨æ¸…èŠ³æ¥å¤è¯Šï¼Œå²³æ¸…æºå°±ååœ¨æ²ˆæ¸…ç§‹åºŠè¾¹ç‰µç€åºŠä¸Šäººçš„æ‰‹ï¼Œæœ¨æ¸…èŠ³ä¸Šå‰ä¸ºæ²ˆæ¸…ç§‹æŠŠè„‰ã€‚ä¸ä¸€ä¼šå„¿ï¼Œæœ¨æ¸…èŠ³ä¾¿æ”¶å›æ‰‹ã€‚", mood: 'narrative' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "ç”¨å¦–ä¸¹æ²»æ„ˆå†…ä¼¤çš„æ³•å­å¾ˆå¥½ï¼Œæ²ˆå¸ˆå…„çš„å†…ä¼¤å·²ç»å¥½è½¬å¾ˆå¤šäº†ï¼Œè¦ä¸äº†å¤šä¹…å°±ä¼šé†’ã€‚", mood: 'neutral' },
                    { speaker: 'æœ¨æ¸…èŠ³', text: "æŒé—¨å¸ˆå…„ä¹Ÿè¦å¥½å¥½ä¼‘æ¯ï¼Œä¸ç„¶åˆ°æ—¶å€™æ²ˆå¸ˆå…„é†’äº†ï¼Œä½ å®äº†å¯å°±ä¸å¥½äº†ã€‚", mood: 'worried' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºåƒµç¡¬çš„ç‚¹äº†ç‚¹å¤´ï¼Œä½†è¿˜æ˜¯å®ˆåœ¨è¿™ã€‚æœ¨æ¸…èŠ³æ— å¥ˆçš„å¹äº†å£æ°”ï¼Œé€€ä¸‹äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹æ˜è¿·ä¸­é†’æ¥å·²æ˜¯ç¬¬äºŒæ—¥æ¸…æ™¨æ˜¯æ¸…æ™¨ï¼Œççœ¼ä¾¿çœ‹åˆ°äº†å²³æ¸…æºååœ¨è‡ªå·±åºŠè¾¹ï¼Œè„¸ä¸Šæ˜ ç…§ç€æ¸…æ™¨æŸ”å’Œçœ¼ä¸­æ˜ ç…§çš„éƒ½æ˜¯è‡ªå·±çš„èº«å½±ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "èººäº†ä¸€ä¸ªæœˆï¼Œå—“å­å¹²å“‘çš„å¯ä»¥ï¼Œæƒ³è¦å¼€å£è¯´è¯ï¼Œä»€ä¹ˆéƒ½æ²¡è¯´å‡ºæ¥ï¼Œä¾¿æ˜¯ä¸€ä¸²å’³å—½ã€‚å²³æ¸…æºå°†æ²ˆæ¸…ç§‹æ‰¶èµ·æ¥é¡ºç€æ°”ï¼Œæ‹¿èµ·ä¸€æ¯æ¸©æ°´ï¼Œå¾€ä»–å”‡è¾¹å–‚ã€‚", mood: 'narrative' },
                    { speaker: 'æ—ç™½', text: "å–äº†æ°´ï¼Œå—“å­æ²¡é‚£ä¹ˆéš¾å—äº†ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "â€¦â€¦å¸ˆå…„ï¼Œæˆ‘è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æƒ³é—®ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "å²³æ¸…æºä¸€åŒæ¸©æš–çš„æ‰‹æ§ä½æ²ˆæ¸…ç§‹çš„æ‰‹ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "å°ä¹é—®å§ï¼è¿™ä¸€æ¬¡ï¼Œæˆ‘å®šçŸ¥æ— ä¸è¨€ï¼Œè¨€æ— ä¸å°½ã€‚", mood: 'gentle' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "è‹¥æˆ‘ä»€ä¹ˆéƒ½ä¸çŸ¥é“ä¸€ç›´æ€¨æ¨ä½ ï¼Œä¸€ç›´ä¸ä½ ç–è¿œã€‚ä½ å½“å¦‚ä½•ï¼Ÿ", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "è¿™ä¸ªç­”æ¡ˆå²³æ¸…æºæ—©å°±æœ‰äº†ï¼Œä»ä»–éšç’å¼€å§‹å°±æƒ³å¥½äº†ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "æˆ‘ä¼šä¸€ç›´èµç½ªï¼Œç›´åˆ°ä½ æ¨æ„æ¶ˆå‡ï¼Œå³ä½¿å°ä¹ä¸€è¾ˆå­éƒ½æ¨æˆ‘ä¹Ÿæ²¡å…³ç³»ã€‚æˆ‘ä¼šå¸¸ä¼´å·¦å³ã€‚", mood: 'gentle' },
                    {
                        mood: 'narrative',
                        text: "æ²ˆæ¸…ç§‹ä¼šæ€ä¹ˆåšï¼Ÿ",
                        choice: [
                            { label: "å›æ¡ä½ä»–çš„æ‰‹", target: "chapter6_he" },
                            { label: "æŠ½å‡ºè‡ªå·±çš„æ‰‹", target: "chapter6_be2" }
                        ]
                    }
                ]
            },

            // --- Branch A: Happy Ending (Original) ---
            'chapter6_he': {
                lines: [
                    { speaker: 'å²³æ¸…æº', text: "ä¿®ä»™ä¹‹äººå¯¿å‘½æé•¿ï¼Œè‹¥å¸¸ä¼´å·¦å³æ¨ä¾¿æ¨å§ï¼", mood: 'gentle', bg: ASSETS.bg.hold_hands }, //åŒæ‰‹ç´§æ¡çš„CGå›¾
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å›æ¡ä½å²³æ¸…æºçš„æ‰‹ï¼Œå£°éŸ³ä½æ²‰ã€‚é¢å¤´è´´ç€å¯¹æ–¹é¢å¤´ï¼Œé‡‘è‰²çš„æµå…‰é—ªè¿‡çµè„‰å½’ä¸»ã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "ä¸ƒå“¥ï¼Œä½ è¯´çš„å¸¸ä¼´æˆ‘å·¦å³ï¼Œåˆ«åæ‚”ã€‚", mood: 'flush' },
                    { speaker: 'å²³æ¸…æº', text: "ä¸åæ‚”çš„ã€‚", mood: 'happy' },
                    { speaker: 'æ—ç™½', text: "ã€å®Œã€‘", mood: 'narrative' }
                ],
                next: 'ending_he'
            },

            // --- Branch B: Bad Ending 2 (Unhealable) ---
            'chapter6_be2': {
                lines: [
                    { speaker: 'æ—ç™½', text: "æ²ˆæ¸…ç§‹å¹¶æ²¡æœ‰è¯´è¯ï¼Œè€Œæ˜¯ç¼“ç¼“åœ°ï¼Œåšå®šåœ°å°†è‡ªå·±çš„æ‰‹ä»å²³æ¸…æºæŒå¿ƒä¸­æŠ½äº†å‡ºæ¥ã€‚", mood: 'narrative' },
                    { speaker: 'å²³æ¸…æº', text: "å°ä¹â€¦â€¦ï¼Ÿ", mood: 'shocked' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "æ™šäº†ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "ç®€å•çš„ä¸¤ä¸ªå­—ï¼Œå´å¦‚åƒé’§ä¹‹é‡ã€‚æ²ˆæ¸…ç§‹é—­ä¸Šäº†çœ¼ï¼Œä¸å†çœ‹é‚£ä¸ªæ»¡è„¸é”™æ„•ä¸ç—›è‹¦çš„ç”·äººã€‚", mood: 'narrative' },
                    { speaker: 'æ²ˆæ¸…ç§‹', text: "å²³æ¸…æºï¼Œæœ‰äº›äº‹é”™äº†å°±æ˜¯é”™äº†ï¼Œé”™è¿‡äº†å°±æ˜¯é”™è¿‡äº†ã€‚ä¸æ˜¯æ‰€æœ‰çš„ä¼¤å£ï¼Œéƒ½èƒ½éšç€æ—¶é—´æ„ˆåˆçš„ã€‚", mood: 'neutral' },
                    { speaker: 'æ—ç™½', text: "æ—¢ç„¶é€‰æ‹©äº†éšç’ï¼Œé‚£å°±è¦æ‰¿æ‹…éšç’çš„ä»£ä»·ã€‚è¿™ä»£ä»·ï¼Œå°±æ˜¯æ°¸è¿œçš„éš”é˜‚ï¼Œå†æ— ä¿®å¤çš„å¯èƒ½ã€‚", mood: 'narrative' }
                ],
                next: 'ending_be2'
            },

            // --- Ending Transitions ---
            'ending_he': {
                type: 'ending',
                title: 'ã€HEï¼šå¸¸ä¼´å·¦å³ã€‘',
                text: "å¸¸ä¼´å·¦å³ï¼Œå†³ä¸åæ‚”ã€‚",
                bg: ASSETS.bg.hold_hands
            },
            'ending_be1': {
                type: 'ending',
                title: 'ã€BEï¼šé™Œè·¯ã€‘',
                text: "ä»Šåé‚£ä¾¿åªè°ˆåˆ©ç›Šï¼Œä¸è°ˆæ„Ÿæƒ…ã€‚",
                bg: ASSETS.bg.qingjing_night
            },
            'ending_be2': {
                type: 'ending',
                title: 'ã€BEï¼šéš¾æ„ˆã€‘',
                text: "æœ‰äº›ä¼¤å£ï¼Œå³ä½¿çŸ¥é“äº†çœŸç›¸ï¼Œä¹Ÿæ— æ³•æ„ˆåˆã€‚",
                bg: ASSETS.bg.bamboo_night
            }
        };

        // --- ç»“å±€å…ƒæ•°æ® (Updated) ---
        const ENDINGS_META = {
            'ending_be1': {
                id: 'ending_be1',
                title: 'é™Œè·¯',
                description: 'ä»Šåé‚£ä¾¿åªè°ˆåˆ©ç›Šï¼Œä¸è°ˆæ„Ÿæƒ…ã€‚',
                color: 'text-slate-400'
            },
            'ending_be2': {
                id: 'ending_be2',
                title: 'éš¾æ„ˆ',
                description: 'æœ‰äº›ä¼¤å£ï¼Œå³ä½¿çŸ¥é“äº†çœŸç›¸ï¼Œä¹Ÿæ— æ³•æ„ˆåˆã€‚',
                color: 'text-slate-400'
            },
            'ending_he': {
                id: 'ending_he',
                title: 'å¸¸ä¼´å·¦å³',
                description: 'å¸¸ä¼´å·¦å³ï¼Œå†³ä¸åæ‚”ã€‚',
                color: 'text-amber-400'
            }
        };

        const TOTAL_ENDINGS = Object.keys(ENDINGS_META).length;

        // --- ç« èŠ‚å…ƒæ•°æ® (Updated) ---
        const CHAPTERS_META = {
            'chapter1': { id: 'chapter1', order: 1, title: 'ç¬¬ä¸€ç«  ä¸´é—¨ä¸€è„š' },
            'chapter2': { id: 'chapter2', order: 2, title: 'ç¬¬äºŒç«  å¾€äº‹æš—æ¶Œ' },
            'chapter3': { id: 'chapter3', order: 3, title: 'ç¬¬ä¸‰ç«  ç»§ä»»å¤§å…¸' },
            'chapter4': { id: 'chapter4', order: 4, title: 'ç¬¬å››ç«  ç¦é˜å¯»è¸ª' },
            'chapter5': { id: 'chapter5', order: 5, title: 'ç¬¬äº”ç«  å†³è£‚ä¸çœŸç›¸' },
            'chapter6': { id: 'chapter6', order: 6, title: 'ç¬¬å…­ç«  å®ˆå¾—äº‘å¼€' }
        };
        const TOTAL_CHAPTERS = Object.keys(CHAPTERS_META).length;

        // --- ç»„ä»¶ ---

        // 1. å›¾æ ‡åº“ (Lucide like)
        const Icon = ({ path, size = 24, className = "" }) => html`
            <svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=${className}>
                ${path}
            </svg>
        `;
        const Icons = {
            Menu: (p) => html`<${Icon} ...${p} path=${html`<line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" />`} />`,
            Volume2: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" />`} />`,
            VolumeX: (p) => html`<${Icon} ...${p} path=${html`<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" />`} />`,
            Save: (p) => html`<${Icon} ...${p} path=${html`<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" />`} />`,
            Upload: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" />`} />`,
            RefreshCcw: (p) => html`<${Icon} ...${p} path=${html`<path d="M21 12A9 9 0 0 0 6.19 6.19l-.78-.78" /><path d="M3 12a9 9 0 0 0 14.81 5.81l.78.78" /><path d="M2 17H6v4" /><path d="M22 7H18V3" />`} />`,
            FileText: (p) => html`<${Icon} ...${p} path=${html`<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" />`} />`,
            Play: (p) => html`<${Icon} ...${p} path=${html`<polygon points="5 3 19 12 5 21 5 3" />`} />`,
            Pause: (p) => html`<${Icon} ...${p} path=${html`<rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" />`} />`,
            FastForward: (p) => html`<${Icon} ...${p} path=${html`<polygon points="13 19 22 12 13 5 13 19" /><polygon points="2 19 11 12 2 5 2 19" />`} />`,
            X: (p) => html`<${Icon} ...${p} path=${html`<line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />`} />`,
            Trash: (p) => html`<${Icon} ...${p} path=${html`<polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />`} />`,
            ChevronLeft: (p) => html`<${Icon} ...${p} path=${html`<polyline points="15 18 9 12 15 6" />`} />`,
        };

        // 2. è‡ªå®šä¹‰å¯¹è¯æ¡†ç»„ä»¶
        const AlertDialog = ({ message, onClose }) => html`
            <div 
                class="fixed inset-0 z-[100] bg-black/80 backdrop-blur flex items-center justify-center animate-in fade-in duration-300" 
                onClick=${onClose}
            >
                <div 
                    class="bg-slate-900 border border-slate-700 p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-[90%] animate-in zoom-in duration-300" 
                    onClick=${e => e.stopPropagation()}
                >
                    <p class="text-slate-200 mb-6 font-serif-sc text-base md:text-lg leading-relaxed whitespace-pre-wrap">${message}</p>
                    <div class="flex justify-end">
                        <button 
                            onClick=${onClose} 
                            class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded transition-colors font-bold text-white"
                        >
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            </div>
        `;

        const ConfirmDialog = ({ message, onConfirm, onCancel }) => {
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') onCancel();
                    if (e.key === 'Enter') onConfirm();
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, []);

            return html`
                <div 
                    class="fixed inset-0 z-[100] bg-black/80 backdrop-blur flex items-center justify-center animate-in fade-in duration-300" 
                    onClick=${onCancel}
                >
                    <div 
                        class="bg-slate-900 border border-slate-700 p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-[90%] animate-in zoom-in duration-300" 
                        onClick=${e => e.stopPropagation()}
                    >
                        <p class="text-slate-200 mb-6 font-serif-sc text-base md:text-lg leading-relaxed whitespace-pre-wrap">${message}</p>
                        <div class="flex gap-4 justify-end">
                            <button 
                                onClick=${onCancel} 
                                class="px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded transition-colors font-bold text-slate-300"
                            >
                                å–æ¶ˆ
                            </button>
                            <button 
                                onClick=${onConfirm} 
                                class="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 rounded transition-colors font-bold text-white"
                            >
                                ç¡®è®¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // 3. åŠ è½½é¡µé¢
        const Preloader = ({ onLoadComplete }) => {
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                let loaded = 0;

                const isColor = (str) => str && (str.startsWith('#') || str.startsWith('rgb') || ['black', 'white'].includes(str));

                // æ”¶é›†æ‰€æœ‰å›¾ç‰‡èµ„æºï¼ˆæ­£ç¡®å¤„ç†åµŒå¥—å¯¹è±¡ï¼‰
                const bgImages = Object.values(ASSETS.bg).filter(src => !isColor(src));
                const charImages = [];
                Object.values(ASSETS.char).forEach(value => {
                    if (typeof value === 'string') {
                        if (!isColor(value)) charImages.push(value);
                    } else if (typeof value === 'object') {
                        charImages.push(...Object.values(value).filter(src => !isColor(src)));
                    }
                });

                const images = [...bgImages, ...charImages];
                const total = images.length;

                if (images.length === 0) {
                    onLoadComplete();
                    return;
                }

                images.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = img.onerror = () => {
                        loaded++;
                        setProgress(Math.floor((loaded / total) * 100));
                        if (loaded === total) {
                            setTimeout(onLoadComplete, CONSTANTS.ANIMATION.PRELOADER_DELAY);
                        }
                    };
                });
            }, []);

            return html`
                <div class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center">
                    <div class="w-64 h-1 bg-slate-800 rounded-full overflow-hidden mb-4">
                        <div class="h-full bg-cyan-500 transition-all duration-300" style=${{ width: `${progress}%` }}></div>
                    </div>
                    <div class="text-slate-500 font-serif-sc tracking-widest text-sm animate-pulse">æ­£åœ¨è½½å…¥èµ„æº ${progress}%</div>
                </div>
            `;
        };

        // 3. å¯¹è¯æ¡†ç»„ä»¶
        const DialogueBox = ({ speaker, text, onNext, isTyping, typingText, isNarrative, onLog, onAuto, onSkip, isAuto, isSkip, onBack, canGoBack }) => {
            // é¢œè‰²æ˜ å°„
            // é¢œè‰²æ˜ å°„
            const getColors = (name) => {
                if (name === 'æ²ˆæ¸…ç§‹') return { text: 'text-emerald-300', border: 'border-emerald-600/50' };
                if (name === 'å²³æ¸…æº') return { text: 'text-indigo-300', border: 'border-indigo-600/50' };
                if (name === 'å¿ƒé­”å²³æ¸…æº') return { text: 'text-purple-400', border: 'border-purple-600/50' };
                if (name === 'ä¹¦ç š') return { text: 'text-cyan-300', border: 'border-cyan-600/50' };
                if (name === 'æœ¨æ¸…èŠ³') return { text: 'text-amber-500', border: 'border-amber-600/50' };
                if (name === 'é½æ¸…è‹') return { text: 'text-rose-300', border: 'border-rose-600/50' };
                if (name === 'æŸ³æ¸…æ­Œ') return { text: 'text-blue-300', border: 'border-blue-600/50' };
                if (name === 'å¥‡æ€ªçš„å£°éŸ³') return { text: 'text-red-400', border: 'border-red-600/50' };
                if (name === 'ç³»ç»Ÿ') return { text: 'text-sky-300', border: 'border-sky-600/50' };
                if (name === 'æ—ç™½') return { text: 'text-amber-200/80', border: 'border-amber-600/30' };
                return { text: 'text-slate-300', border: 'border-cyan-600/50' };
            };

            const colors = getColors(speaker);

            return html`
                <div class="w-full max-w-4xl mx-auto mb-1 px-4 z-30 select-none pb-1" onClick=${onNext}>
                    <div class="relative">
                        ${!isNarrative && html`
                            <div class="absolute bottom-full left-0 mb-0 px-3 py-1 bg-slate-900/90 border border-b-0 ${colors.border} rounded-t text-xs md:text-sm lg:text-lg font-bold ${colors.text} shadow-lg backdrop-blur-sm">
                                ${speaker}
                            </div>
                        `}
                        <div class="dialogue-glass rounded-lg md:rounded-xl p-1.5 md:p-4 lg:p-8 h-20 md:h-32 lg:h-52 hover:bg-slate-900/40 transition-colors cursor-pointer border ${colors.border} overflow-hidden flex flex-col relative group/box">
                            <div class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent pr-1">
                                <p class="font-serif-sc text-xs md:text-lg lg:text-2xl leading-relaxed whitespace-pre-wrap ${isNarrative ? 'italic text-slate-300' : 'text-slate-100 font-bold'}">
                                    ${typingText}
                                    ${isTyping && html`<span class="inline-block w-1.5 h-4 md:w-2 md:h-5 bg-cyan-400 align-middle ml-1 animate-pulse"></span>`}
                                </p>
                            </div>
                            
                            <!-- æŒ‰é’®ç»„ (æ•´åˆè¿›å¯¹è¯æ¡†å³ä¸‹è§’) -->
                            <div class="absolute bottom-1 right-1 md:bottom-2 md:right-2 flex gap-1 md:gap-2 z-50 opacity-100 md:opacity-0 md:group-hover/box:opacity-100 transition-opacity duration-300" onClick=${e => e.stopPropagation()}>
                                 <button onClick=${onBack} class="btn-bloom p-1 md:p-1.5 ${canGoBack ? 'bg-slate-800/80 text-cyan-200/80 hover:bg-cyan-900/80 border border-transparent hover:border-cyan-500/30' : 'bg-slate-800/40 text-slate-600 cursor-not-allowed'} rounded transition-colors" title="ä¸Šä¸€å¥" disabled=${!canGoBack}>
                                    <${Icons.ChevronLeft} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                 <button onClick=${onLog} class="btn-bloom p-1 md:p-1.5 bg-slate-800/80 hover:bg-cyan-900/80 rounded text-cyan-200/80 hover:text-cyan-100 transition-colors border border-transparent hover:border-cyan-500/30" title="å›æ”¾">
                                    <${Icons.FileText} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                <button onClick=${onAuto} class="btn-bloom p-1 md:p-1.5 ${isAuto ? 'bg-cyan-600 text-white shadow-[0_0_10px_rgba(8,145,178,0.5)]' : 'bg-slate-800/80 text-cyan-200/80'} hover:bg-cyan-700 rounded transition-colors border border-transparent hover:border-cyan-500/30" title="è‡ªåŠ¨">
                                    <${isAuto ? Icons.Pause : Icons.Play} size=${14} class="md:w-5 md:h-5" />
                                </button>
                                <button onClick=${onSkip} class="btn-bloom p-1 md:p-1.5 ${isSkip ? 'bg-amber-600 text-white shadow-[0_0_10px_rgba(217,119,6,0.5)]' : 'bg-slate-800/80 text-cyan-200/80'} hover:bg-amber-700 rounded transition-colors border border-transparent hover:border-amber-500/30" title="å¿«è¿›">
                                    <${Icons.FastForward} size=${14} class="md:w-5 md:h-5" />
                                </button>
                            </div>

                            ${!isTyping && !isAuto && !isSkip && html`
                                <div class="absolute bottom-1 right-1 md:bottom-4 md:right-4 animate-bounce text-cyan-500/50 pointer-events-none">
                                    <svg width="12" height="12" class="md:w-4 md:h-4 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-6-6h12z"/></svg>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        // 4. å¼€å§‹ç”»é¢
        const StartScreen = ({ onStart, onLoad, hasAutoSave, onEndings, onChapters, unlockedEndingsCount, unlockedChaptersCount, totalChapters }) => html`
            <div class="absolute inset-0 z-40 bg-black flex flex-col items-center justify-center overflow-hidden">
                <div class="absolute inset-0 animate-in zoom-in duration-[10s]">
                    <img src=${ASSETS.bg.start} class="w-full h-full object-cover opacity-60" />
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/20 to-transparent"></div>
                
                <div class="relative z-50 text-center p-2 md:p-4 flex flex-col items-center gap-1 mobile-landscape-gap md:gap-4 lg:gap-8 animate-in fade-in slide-in-from-bottom-10 duration-1000">
                    <h1 class="font-calligraphy text-2xl mobile-landscape-title sm:text-3xl md:text-7xl text-slate-100 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] tracking-widest leading-relaxed">
                        é”¯å˜´è‘«èŠ¦
                    </h1>
                    
                    <div class="flex flex-col gap-2 mt-2 mobile-landscape-gap md:mt-4 lg:mt-8 w-full max-w-xs scale-90 md:scale-100">
                        <button onClick=${() => onStart()} class="btn-bloom px-4 py-1.5 mobile-landscape-btn md:px-8 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-lg md:text-2xl font-calligraphy rounded transition-all tracking-[0.2em] backdrop-blur-sm">
                            å¼€å§‹æ–°æ¸¸æˆ
                        </button>
                        
                        <div class="flex gap-2 w-full">
                            ${hasAutoSave && html`
                            <button onClick=${() => onLoad('auto')} class="btn-bloom flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç»§ç»­æ¸¸æˆ
                            </button>
                            `}
                            <button onClick=${() => onLoad('manual')} class="btn-bloom flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-sm md:text-lg font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                è¯»å–å­˜æ¡£
                            </button>
                        </div>
                        
                        <!-- æ–°å¢ï¼šç»“å±€å›æ”¶å’Œç« èŠ‚é€‰æ‹© -->
                        <div class="flex gap-2 w-full mt-1">
                            <button onClick=${onChapters} class="btn-bloom flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-xs md:text-base font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç« èŠ‚é€‰æ‹© <span class="text-cyan-400">${unlockedChaptersCount}/${totalChapters}</span>
                            </button>
                            <button onClick=${onEndings} class="btn-bloom flex-1 px-2 py-1.5 mobile-landscape-btn md:px-4 md:py-3 bg-slate-800/50 hover:bg-slate-700/60 border border-slate-500/40 text-slate-100 text-xs md:text-base font-calligraphy rounded transition-all tracking-[0.1em] backdrop-blur-sm">
                                ç»“å±€å›æ”¶ <span class="text-amber-400">${unlockedEndingsCount}/${TOTAL_ENDINGS}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 5. é€‰é¡¹ç»„ä»¶ (Immersive "Ink & Fate" Redesign)
        const ChoiceScreen = ({ question, options, onChoice }) => html`
            <div id="screen-choice" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/40 backdrop-blur-md animate-fade-in text-slate-900 font-serif-sc">
                <!-- Floating Ink Background Elements -->
                <div class="absolute inset-0 overflow-hidden pointer-events-none">
                    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-gradient-to-b from-black/5 to-transparent rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                    <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-gradient-to-t from-red-900/5 to-transparent rounded-full blur-3xl transform -translate-x-1/3 translate-y-1/3"></div>
                </div>

                <div class="relative w-full max-w-4xl flex flex-col items-center justify-center p-8 lg:p-12 gap-8 md:gap-12 choice-btn-container">
                    <!-- Question / Prompt -->
                    <div class="relative z-10 text-center space-y-4 animate-in zoom-in duration-700">
                        <div class="w-px h-12 md:h-16 bg-gradient-to-b from-transparent via-slate-900/20 to-transparent mx-auto mb-4"></div>
                        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-slate-100 tracking-[0.2em] drop-shadow-sm leading-relaxed" style="text-shadow: 0 0 20px rgba(255,255,255,0.4);">
                            ${question}
                        </h2>
                        <div class="w-12 h-1 bg-red-900/30 mx-auto rounded-full mt-6"></div>
                    </div>

                    <!-- Options Container -->
                    <div class="w-full max-w-xl flex flex-col gap-4 relative z-20">
                        ${options.map((opt, index) => html`
                            <button 
                                onClick=${() => onChoice(opt)}
                                class="choice-btn group w-full text-left relative overflow-hidden py-4 px-6 md:px-8 border-l-2 border-transparent hover:border-red-800 transition-all duration-300 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-r-md shadow-sm"
                                style="opacity: 0; animation: fadeInUpStagger 0.6s ease-out forwards; animation-delay: ${index * 0.15}s;"
                            >
                                <div class="relative z-10 flex items-center justify-between">
                                    <div class="flex flex-col">
                                        <span class="font-serif-sc text-lg md:text-xl font-medium tracking-[0.15em] text-slate-200 group-hover:text-red-300 transition-colors">
                                            ${opt.text}
                                        </span>
                                        ${opt.subtext && html`<span class="text-xs text-slate-400 group-hover:text-slate-300 mt-1">${opt.subtext}</span>`}
                                    </div>
                                    <span class="material-symbols-outlined text-stone-400 group-hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all -translate-x-4 group-hover:translate-x-0">
                                        â†’
                                    </span>
                                </div>
                            </button>
                        `)}
                    </div>
                </div>
            </div>
        `;

        // 9. å­˜æ¡£/è¯»æ¡£ç•Œé¢ (Mobile Friendly Grid)
        const SaveLoadScreen = ({ mode, onClose, onSave, onLoad, saves, onDelete }) => {
            const isSave = mode === 'save';
            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ${isSave ? 'æ¡£æ¡ˆè®°å½•' : 'æ¡£æ¡ˆè¯»å–'}
                            <span class="text-sm md:text-lg text-slate-500 font-sans font-normal tracking-normal self-end mb-1">Select a Slot</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 pb-20 mobile-landscape-grid-2">
                             ${Array.from({ length: 12 }).map((_, i) => {
                const id = i + 1;
                const save = saves[id];
                return html`
                                    <div class="group relative aspect-[16/10] bg-slate-900 border-2 ${save ? 'border-slate-700 hover:border-cyan-500' : 'border-slate-800 hover:border-slate-600'} rounded-lg transition-all overflow-hidden flex flex-col cursor-pointer hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1"
                                         onClick=${() => isSave ? onSave(id) : (save && onLoad(id))}
                                    >
                                        <!-- Header: ID and Date -->
                                        <div class="absolute top-0 left-0 right-0 p-2 bg-gradient-to-b from-black/80 to-transparent z-10 flex justify-between items-start text-[10px] md:text-xs pointer-events-none">
                                            <span class="font-bold text-slate-400 font-mono">NO.${id.toString().padStart(2, '0')}</span>
                                            ${save && html`<span class="text-slate-300 bg-slate-900/50 px-1 rounded backdrop-blur-sm">${new Date(save.timestamp).toLocaleDateString()} ${new Date(save.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`}
                                        </div>

                                        <!-- Preview Image -->
                                        <div class="absolute inset-0 bg-slate-800 flex items-center justify-center overflow-hidden pointer-events-none">
                                            ${save ? html`
                                                ${(save.bg && (save.bg.startsWith('#') || save.bg.startsWith('rgb') || ['black', 'white'].includes(save.bg)))
                            ? html`<div class="w-full h-full opacity-80 group-hover:opacity-100 transition-opacity" style="background-color: ${save.bg}"></div>`
                            : html`<img src=${save.bg} class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />`
                        }
                                            ` : html`
                                                <div class="text-slate-700 font-serif-sc text-sm">ç©ºå­˜æ¡£</div>
                                            `}
                                        </div>

                                        <!-- Preview Text (Bottom Overlay) -->
                                        ${save && html`
                                            <div class="absolute bottom-0 left-0 right-0 p-2 md:p-3 bg-gradient-to-t from-black/95 via-black/70 to-transparent z-10 pointer-events-none">
                                                <div class="text-[10px] md:text-xs text-cyan-300 font-bold mb-0.5 truncate">${save.speaker || '???'}</div>
                                                <div class="text-[11px] md:text-sm text-slate-300 font-serif-sc line-clamp-2 h-8 md:h-10 leading-tight opacity-90">${save.previewText}</div>
                                            </div>
                                        `}

                                        <!-- Action Overlay (Delete) -->
                                        ${save && html`
                                            <div class="absolute top-2 right-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick=${(e) => { e.stopPropagation(); onDelete(id); }} class="p-1.5 bg-red-900/80 hover:bg-red-700 text-red-200 rounded-full backdrop-blur shadow-lg transition-colors" title="åˆ é™¤å­˜æ¡£">
                                                    <${Icons.Trash} size=${14} />
                                                </button>
                                            </div>
                                        `}
                                        
                                        <!-- Hover Effect for Empty Save Slot -->
                                        ${!save && html`
                                            <div class="absolute inset-0 flex items-center justify-center bg-cyan-900/10 border-2 border-dashed border-cyan-800/50 rounded-lg hover:bg-cyan-900/20 transition-all pointer-events-none">
                                                <span class="text-cyan-400/80 font-bold border border-cyan-500/50 px-3 py-1 rounded-full bg-slate-900/80 backdrop-blur shadow-lg">
                                                    ${mode === 'save' ? 'ç‚¹å‡»æ–°å»ºå­˜æ¡£' : 'ç©ºå­˜æ¡£'}
                                                </span>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // 6. èœå•ç»„ä»¶ (Modified for new Save/Load)
        const Menu = ({ onClose, onOpenSave, onOpenLoad, onOpenSettings, onBackTitle }) => html`
            <div class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick=${onClose}>
                <div class="bg-slate-900 border border-slate-700 p-4 md:p-8 rounded-xl shadow-2xl w-[260px] md:w-[320px] flex flex-col gap-2 md:gap-4 max-h-full overflow-y-auto custom-scroll" onClick=${e => e.stopPropagation()}>
                    <h3 class="text-cyan-400 text-lg md:text-xl font-bold mb-1 md:mb-2 text-center shrink-0">ç³»ç»Ÿèœå•</h3>
                    
                    <button onClick=${onOpenSave} class="btn-bloom w-full p-3 md:p-4 bg-slate-800 hover:bg-cyan-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-cyan-800 tracking-normal font-sans text-center font-bold shrink-0 relative overflow-hidden">
                        ä¿å­˜è®°å½•
                    </button>

                     <button onClick=${onOpenLoad} class="btn-bloom w-full p-3 md:p-4 bg-slate-800 hover:bg-indigo-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-indigo-800 tracking-normal font-sans text-center font-bold shrink-0 relative overflow-hidden">
                        è¯»å–è®°å½•
                    </button>

                    <button onClick=${onOpenSettings} class="btn-bloom w-full p-3 md:p-4 bg-slate-800 hover:bg-emerald-900/30 text-slate-200 text-sm md:text-base rounded transition-colors border border-transparent hover:border-emerald-800 tracking-normal font-sans text-center font-bold shrink-0 relative overflow-hidden">
                        è®¾ç½®
                    </button>

                    <div class="h-px bg-slate-800 my-0 md:my-1 shrink-0"></div>
                    
                    <button onClick=${onBackTitle} class="btn-bloom w-full p-3 md:p-4 bg-red-900/20 hover:bg-red-900/40 text-red-300 text-sm md:text-base rounded transition-colors tracking-normal font-sans text-center font-bold shrink-0 relative overflow-hidden">
                        è¿”å›æ ‡é¢˜
                    </button>
                    
                    <button onClick=${onClose} class="mt-2 text-slate-500 hover:text-slate-300 text-sm text-center">
                        å…³é—­èœå•
                    </button>
                </div>
            </div>
        `;

        // è®¾ç½®ç•Œé¢
        const SettingsScreen = ({ textSpeed, onTextSpeedChange, onClose }) => {
            // Speed ranges: 10 (fast) - 80 (slow). Default is 30.
            const speedLabels = [
                { value: 10, label: 'æå¿«' },
                { value: 20, label: 'å¿«' },
                { value: 30, label: 'æ­£å¸¸' },
                { value: 50, label: 'æ…¢' },
                { value: 80, label: 'ææ…¢' },
            ];
            const currentLabel = speedLabels.reduce((prev, curr) =>
                Math.abs(curr.value - textSpeed) < Math.abs(prev.value - textSpeed) ? curr : prev
            ).label;

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col items-center justify-center p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="bg-slate-900 border border-slate-700 p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-md flex flex-col gap-6">
                        <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                            <h2 class="text-2xl md:text-3xl text-slate-100 font-serif-sc font-bold">è®¾ç½®</h2>
                            <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                                <${Icons.X} size=${24} />
                            </button>
                        </div>

                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col gap-2">
                                <label class="text-slate-300 font-bold flex justify-between items-center">
                                    <span>æ–‡å­—é€Ÿåº¦</span>
                                    <span class="text-cyan-400 text-sm font-normal bg-slate-800 px-2 py-0.5 rounded">${currentLabel}</span>
                                </label>
                                <input 
                                    type="range" 
                                    min="10" 
                                    max="80" 
                                    step="5"
                                    value=${textSpeed}
                                    onInput=${(e) => onTextSpeedChange(parseInt(e.target.value))}
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                />
                                <div class="flex justify-between text-xs text-slate-500">
                                    <span>å¿«</span>
                                    <span>æ…¢</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ç»“å±€å›æ”¶ç•Œé¢
        const EndingsScreen = ({ unlockedEndings, onClose, onSelectEnding }) => {
            const unlockedCount = unlockedEndings.size;

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ç»“å±€å›æ”¶
                            <span class="text-sm md:text-lg text-cyan-400 font-sans font-normal tracking-normal self-end mb-1 bg-slate-800 px-2 py-0.5 rounded">${unlockedCount} / ${TOTAL_ENDINGS}</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 pb-10">
                            ${Object.values(ENDINGS_META).map(ending => {
                const isUnlocked = unlockedEndings.has(ending.id);
                return html`
                                    <div class="group relative bg-slate-900 border-2 ${isUnlocked ? 'border-slate-700 hover:border-amber-500 cursor-pointer' : 'border-slate-800 cursor-not-allowed'} rounded-lg p-4 md:p-6 transition-all ${isUnlocked ? 'hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1' : 'opacity-50'}"
                                         onClick=${() => isUnlocked && onSelectEnding(ending.id)}>
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs md:text-sm ${isUnlocked ? ending.color : 'text-slate-600'} font-bold uppercase tracking-wider">${isUnlocked ? ending.subtitle : '???'}</span>
                                            ${isUnlocked ? html`
                                                <span class="text-xs text-green-400 bg-green-900/30 px-2 py-0.5 rounded-full">ç‚¹å‡»æŸ¥çœ‹</span>
                                            ` : html`
                                                <span class="text-xs text-slate-600 bg-slate-800 px-2 py-0.5 rounded-full">æœªè§£é”</span>
                                            `}
                                        </div>
                                        <h3 class="text-lg md:text-2xl font-serif-sc font-bold ${isUnlocked ? 'text-slate-100 group-hover:text-amber-200' : 'text-slate-600'} mb-2 transition-colors">
                                            ${isUnlocked ? ending.title : '???'}
                                        </h3>
                                        <p class="text-sm md:text-base ${isUnlocked ? 'text-slate-400' : 'text-slate-700'} font-serif-sc leading-relaxed">
                                            ${isUnlocked ? ending.description : 'è¾¾æˆæ­¤ç»“å±€åè§£é”'}
                                        </p>
                                        ${isUnlocked && html`
                                            <div class="absolute bottom-4 right-4 text-amber-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="9 18 15 12 9 6" />
                                                </svg>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // ç« èŠ‚é€‰æ‹©ç•Œé¢
        const ChaptersScreen = ({ unlockedChapters, onClose, onSelectChapter }) => {
            const unlockedCount = unlockedChapters.size;
            const sortedChapters = Object.values(CHAPTERS_META).sort((a, b) => a.order - b.order);

            return html`
                <div class="absolute inset-0 z-[60] bg-slate-950/95 backdrop-blur flex flex-col p-4 md:p-8 animate-in fade-in duration-300" onClick=${e => e.stopPropagation()}>
                    <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-800 pb-4">
                        <h2 class="text-2xl md:text-4xl text-slate-100 font-serif-sc font-bold tracking-widest flex items-center gap-4">
                            ç« èŠ‚é€‰æ‹©
                            <span class="text-sm md:text-lg text-indigo-400 font-sans font-normal tracking-normal self-end mb-1 bg-slate-800 px-2 py-0.5 rounded">${unlockedCount} / ${TOTAL_CHAPTERS}</span>
                        </h2>
                        <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                            <${Icons.X} size=${28} />
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 pb-10">
                            ${sortedChapters.map(chapter => {
                const isUnlocked = unlockedChapters.has(chapter.id);
                return html`
                                    <div class="group relative bg-slate-900 border-2 ${isUnlocked ? 'border-slate-700 hover:border-indigo-500 cursor-pointer' : 'border-slate-800 cursor-not-allowed'} rounded-lg p-4 md:p-6 transition-all ${isUnlocked ? 'hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] transform hover:-translate-y-1' : 'opacity-50'}"
                                         onClick=${() => isUnlocked && onSelectChapter(chapter.id)}>
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs md:text-sm text-indigo-400 font-bold uppercase tracking-wider">Chapter ${chapter.order}</span>
                                            ${isUnlocked ? html`
                                                <span class="text-xs text-green-400 bg-green-900/30 px-2 py-0.5 rounded-full">å·²è§£é”</span>
                                            ` : html`
                                                <span class="text-xs text-slate-600 bg-slate-800 px-2 py-0.5 rounded-full">æœªè§£é”</span>
                                            `}
                                        </div>
                                        <h3 class="text-lg md:text-2xl font-serif-sc font-bold ${isUnlocked ? 'text-slate-100 group-hover:text-indigo-200' : 'text-slate-600'} mb-2 transition-colors">
                                            ${isUnlocked ? chapter.title : '???'}
                                        </h3>
                                        <p class="text-sm md:text-base ${isUnlocked ? 'text-slate-400' : 'text-slate-700'} font-serif-sc leading-relaxed">
                                            ${isUnlocked ? chapter.description : 'é˜…è¯»æ­¤ç« èŠ‚åè§£é”'}
                                        </p>
                                        ${isUnlocked && html`
                                            <div class="absolute bottom-4 right-4 text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="9 18 15 12 9 6" />
                                                </svg>
                                            </div>
                                        `}
                                    </div>
                                `;
            })}
                        </div>
                    </div>
                </div>
            `;
        };

        // 7. å†å²è®°å½•æ¨¡æ€æ¡†
        const HistoryModal = ({ history, onClose }) => {
            const endRef = useRef(null);

            useEffect(() => {
                if (endRef.current) {
                    endRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, []);

            // é¢œè‰²æ˜ å°„ï¼ˆä¸å¯¹è¯æ¡†ä¿æŒä¸€è‡´ï¼‰
            const getSpeakerColor = (name) => {
                if (name === 'æ²ˆæ¸…ç§‹') return 'text-emerald-300';
                if (name === 'å²³æ¸…æº') return 'text-indigo-300';
                if (name === 'å¿ƒé­”å²³æ¸…æº') return 'text-purple-400';
                if (name === 'ä¹¦ç š') return 'text-cyan-300';
                if (name === 'æœ¨æ¸…èŠ³') return 'text-amber-500';
                if (name === 'é½æ¸…è‹') return 'text-rose-300';
                if (name === 'æŸ³æ¸…æ­Œ') return 'text-blue-300';
                if (name === 'å¥‡æ€ªçš„å£°éŸ³') return 'text-red-400';
                if (name === 'æ—ç™½') return 'text-amber-200/80';
                return 'text-slate-300';
            };

            return html`
            <div class="absolute inset-0 z-[100] bg-black/90 backdrop-blur flex flex-col p-4 md:p-10 animate-in fade-in duration-300">
                <div class="flex justify-between items-center mb-4 md:mb-6 border-b border-slate-700 pb-2 md:pb-4 shrink-0">
                    <h2 class="text-xl md:text-3xl text-slate-100 font-serif-sc font-bold">å‰§æƒ…å›æ”¾</h2>
                    <button onClick=${onClose} class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                        <${Icons.X} size=${24} class="md:w-8 md:h-8" />
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll pr-2 md:pr-4 space-y-4 md:space-y-6">
                    ${history.length === 0 ? html`<div class="text-slate-500 text-center mt-20 italic font-serif-sc">æš‚æ— è®°å½•</div>` : null}
                    ${history.map((item, index) => html`
                        <div class="flex flex-col gap-1 items-start group">
                            <span class="text-xs md:text-sm font-bold ${getSpeakerColor(item.speaker)} px-2 py-0.5 rounded bg-slate-800/50 border border-slate-700/50">
                                ${item.speaker || '???'}
                            </span>
                            <p class="text-sm md:text-lg text-slate-300 font-serif-sc leading-relaxed bg-slate-900/30 p-2 md:p-3 rounded-lg w-full hover:bg-slate-800/50 transition-colors border-l-2 border-transparent hover:border-cyan-500/50">
                                ${item.text}
                            </p>
                        </div>
                    `)}
                    <div ref=${endRef}></div>
                </div>
            </div>
        `};

        // 8. å¿«æ·èœå•
        const QuickMenu = ({ onLog, onAuto, onSkip, isAuto, isSkip }) => html`
            <div class="absolute bottom-24 md:bottom-36 lg:bottom-56 right-2 md:right-8 z-40 flex gap-2 md:gap-4 mobile-landscape-bottom-adjust">
                <button onClick=${onLog} class="btn-bloom flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 hover:bg-cyan-900/60 backdrop-blur rounded-full text-xs md:text-sm text-cyan-200 border border-cyan-500/20 hover:border-cyan-400 shadow-lg group">
                    <${Icons.FileText} size=${14} class="group-hover:text-cyan-100" />
                    <span class="font-bold hidden md:inline">å›æ”¾</span>
                    <span class="font-bold md:hidden">Log</span>
                </button>
                <button onClick=${onAuto} class="btn-bloom flex items-center gap-1.5 px-3 py-1.5 ${isAuto ? 'bg-cyan-600/80 text-white shadow-[0_0_10px_rgba(8,145,178,0.5)]' : 'bg-slate-900/80 text-cyan-200'} hover:bg-cyan-700/80 backdrop-blur rounded-full text-xs md:text-sm border border-cyan-500/20 hover:border-cyan-400 shadow-lg group">
                    <${isAuto ? Icons.Pause : Icons.Play} size=${14} class="group-hover:text-white" />
                    <span class="font-bold hidden md:inline">${isAuto ? 'è‡ªåŠ¨ä¸­' : 'è‡ªåŠ¨'}</span>
                    <span class="font-bold md:hidden">Auto</span>
                </button>
                <button onClick=${onSkip} class="btn-bloom flex items-center gap-1.5 px-3 py-1.5 ${isSkip ? 'bg-amber-600/80 text-white shadow-[0_0_10px_rgba(217,119,6,0.5)]' : 'bg-slate-900/80 text-cyan-200'} hover:bg-amber-700/80 backdrop-blur rounded-full text-xs md:text-sm border border-cyan-500/20 hover:border-amber-400 shadow-lg group">
                    <${Icons.FastForward} size=${14} class="group-hover:text-white" />
                    <span class="font-bold hidden md:inline">${isSkip ? 'å¿«è¿›ä¸­' : 'å¿«è¿›'}</span>
                    <span class="font-bold md:hidden">Skip</span>
                </button>
            </div>
        `;

        // èƒŒæ™¯åˆ‡æ¢ç»„ä»¶ (Cross-fade)
        const BackgroundLayer = ({ src }) => {
            const [currentSrc, setCurrentSrc] = useState(src);
            const [nextSrc, setNextSrc] = useState(null);
            const [isTransitioning, setIsTransitioning] = useState(false);

            useEffect(() => {
                if (src !== currentSrc) {
                    // 1. ç«‹å³è®¾å®šæ–°ç›®æ ‡
                    setNextSrc(src);
                    setIsTransitioning(false); // å…ˆé‡ç½®åŠ¨ç”»çŠ¶æ€

                    // 2. ä¸‹ä¸€å¸§å¯åŠ¨æ–°åŠ¨ç”»
                    const raf = requestAnimationFrame(() => setIsTransitioning(true));

                    // 3. è®¾ç½®å®Œæˆå›è°ƒ
                    const timer = setTimeout(() => {
                        setCurrentSrc(src);
                        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨ setNextSrc(null)ï¼Œç•™ç»™ä¸‹ä¸€æ¬¡ render çš„ else åˆ†æ”¯å¤„ç†æ›´å®‰å…¨
                    }, 1000); // 1ç§’æ·¡å…¥æ·¡å‡ºï¼Œä¸ CSS duration åŒ¹é…

                    // 4. âœ… å…³é”®ï¼šæ¸…ç†å‡½æ•°
                    return () => {
                        cancelAnimationFrame(raf);
                        clearTimeout(timer);
                    };
                } else {
                    // 5. ç¨³å®šçŠ¶æ€ï¼šæ¸…ç†è¿‡æ¸¡ç—•è¿¹
                    setNextSrc(null);
                    setIsTransitioning(false);
                }
            }, [src, currentSrc]);

            const isColor = (str) => str && (str.startsWith('#') || str.startsWith('rgb') || ['black', 'white'].includes(str));

            const renderMedia = (source, extraClass = '') => {
                if (!source) return null;
                if (isColor(source)) {
                    // Don't apply brightness filter to pure black
                    const filterClass = (source === '#000000' || source === 'black') ? '' : 'filter brightness-[0.6]';
                    return html`<div class="absolute inset-0 w-full h-full ${filterClass} ${extraClass}" style="background-color: ${source}"></div>`;
                }
                return html`<img src=${source} class="absolute inset-0 w-full h-full object-cover filter brightness-[0.6] ${extraClass}" />`;
            };

            return html`
                <div class="absolute inset-0 z-0 bg-black pointer-events-none select-none">
                    <!-- åº•å±‚ï¼šå½“å‰æ˜¾ç¤ºçš„èƒŒæ™¯ -->
                    ${renderMedia(currentSrc)}
                    
                    <!-- é¡¶å±‚ï¼šæ·¡å…¥çš„æ–°èƒŒæ™¯ -->
                    ${renderMedia(nextSrc, `transition-opacity duration-1000 ease-in-out ${isTransitioning ? 'opacity-100' : 'opacity-0'}`)}
                </div>
            `;
        };

        // Visual Effects Component
        const VisualEffects = ({ isEnergy, isClimax }) => {
            const particles = useMemo(() => Array.from({ length: 20 }).map((_, i) => ({
                left: Math.random() * 100,
                duration: 1 + Math.random() * 1.5,
                height: 40 + Math.random() * 40,
                delay: Math.random() * 2 // stagger start
            })), []);

            return html`
                <div class="absolute inset-0 pointer-events-none overflow-hidden z-10">
                    ${isEnergy && particles.map(p => html`
                        <div class="energy-stream" style="left: ${p.left}%; height: ${p.height}vh; animation: energy-flow ${p.duration}s ease-in infinite; animation-delay: -${p.delay}s;"></div>
                    `)}
                    <div class="heavenly-beam" style="opacity: ${isClimax ? '1' : '0'};"></div>
                </div>
            `;
        };

        // --- ä¸»é€»è¾‘ ---
        const App = () => {
            // --- çŠ¶æ€ä¸åˆå§‹åŒ– ---

            // æ•°æ®è¿ç§»ä¸å‰ç¼€ç»Ÿä¸€


            const [isLoading, setIsLoading] = useState(true);
            const [gameState, setGameState] = useState({
                sceneId: 'start',
                lineIndex: 0,
                bg: ASSETS.bg.start,
                history: [] // å†å²è®°å½•
            });
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [isSaveLoadOpen, setIsSaveLoadOpen] = useState(false);
            const [saveLoadMode, setSaveLoadMode] = useState('load');
            const [refreshSaves, setRefreshSaves] = useState(0);

            const [typingText, setTypingText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [audioEnabled, setAudioEnabled] = useState(false);
            const [isAuto, setIsAuto] = useState(false);
            const [isSkip, setIsSkip] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isShaking, setIsShaking] = useState(false);
            const [isRhythm, setIsRhythm] = useState(false);
            const [isEndingsOpen, setIsEndingsOpen] = useState(false);
            const [isEnergy, setIsEnergy] = useState(false); // Silver energy lines
            const [isClimax, setIsClimax] = useState(false); // Golden beam

            // æ²ˆæ¸…ç§‹ç«‹ç»˜ç¼“å­˜ï¼ˆé˜²æ­¢æ·¡å‡ºæ—¶è¡¨æƒ…é—ªå›neutralï¼‰
            const sqqç«‹ç»˜ç¼“å­˜ = useRef(ASSETS.char.sqq.v1);

            // è·å–æ–‡æœ¬å”¯ä¸€æ ‡è¯† (å¢åŠ ç¨³å®šæ€§ï¼ŒæŠ—è„šæœ¬åç§»)
            const getTextId = (sceneId, lineIndex, text) => {
                if (!text) return `${sceneId}_${lineIndex}`;
                // ç®€å•çš„å­—ç¬¦å“ˆå¸Œ
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) - hash) + text.charCodeAt(i);
                    hash |= 0;
                }
                return `${sceneId}_h${hash}`;
            };

            const [readTextIds, setReadTextIds] = useState(() => {
                try {
                    const saved = Storage.get(CONSTANTS.STORAGE_KEYS.READ_TEXT);
                    return saved ? new Set(saved) : new Set();
                } catch {
                    return new Set();
                }
            });

            // æ ‡è®°æ–‡æœ¬ä¸ºå·²è¯»
            const markTextAsRead = (textId) => {
                if (!textId || readTextIds.has(textId)) return;

                setReadTextIds(prev => {
                    if (prev.has(textId)) return prev;
                    const next = new Set(prev);
                    next.add(textId);

                    // å¼‚æ­¥ä¿å­˜åˆ°æœ¬åœ°
                    setTimeout(() => {
                        Storage.set(CONSTANTS.STORAGE_KEYS.READ_TEXT, [...next]);
                    }, 0);

                    return next;
                });
            };

            // å·²è§£é”ç»“å±€è®°å½•
            const [unlockedEndings, setUnlockedEndings] = useState(() => {
                try {
                    const saved = Storage.get(CONSTANTS.STORAGE_KEYS.UNLOCKED_ENDINGS);
                    if (saved) {
                        const validEndings = saved.filter(id => ENDINGS_META[id]);
                        return new Set(validEndings);
                    }
                    return new Set();
                } catch {
                    return new Set();
                }
            });

            // å·²è§£é”ç« èŠ‚è®°å½•
            const [unlockedChapters, setUnlockedChapters] = useState(() => {
                try {
                    const saved = Storage.get(CONSTANTS.STORAGE_KEYS.UNLOCKED_CHAPTERS);
                    if (saved) {
                        const validChapters = saved.filter(id => CHAPTERS_META[id]);
                        return new Set(validChapters.length > 0 ? validChapters : ['chapter1_start']);
                    }
                    return new Set(['chapter1_start']);
                } catch {
                    return new Set(['chapter1_start']);
                }
            });
            const [isChaptersOpen, setIsChaptersOpen] = useState(false); // ç« èŠ‚é€‰æ‹©ç•Œé¢

            // å¯¹è¯æ¡†çŠ¶æ€ (ç”¨äºæ›¿æ¢åŸç”Ÿ alert/confirm)
            const [dialogState, setDialogState] = useState(null);

            // æ˜¾ç¤º Alert å¯¹è¯æ¡†
            const showAlert = (message) => {
                return new Promise((resolve) => {
                    setDialogState({
                        type: 'alert',
                        message,
                        onClose: () => {
                            setDialogState(null);
                            resolve();
                        }
                    });
                });
            };

            // æ˜¾ç¤º Confirm å¯¹è¯æ¡†
            const showConfirm = (message) => {
                return new Promise((resolve) => {
                    setDialogState({
                        type: 'confirm',
                        message,
                        onConfirm: () => {
                            setDialogState(null);
                            resolve(true);
                        },
                        onCancel: () => {
                            setDialogState(null);
                            resolve(false);
                        }
                    });
                });
            };

            // Settings
            const loadSettings = () => {
                try {
                    const saved = Storage.get(CONSTANTS.STORAGE_KEYS.SETTINGS);
                    return saved || { textSpeed: 30 };
                } catch { return { textSpeed: 30 }; }
            };
            const [textSpeed, setTextSpeed] = useState(() => loadSettings().textSpeed);

            const handleTextSpeedChange = (newSpeed) => {
                setTextSpeed(newSpeed);
                const result = Storage.set(CONSTANTS.STORAGE_KEYS.SETTINGS, { textSpeed: newSpeed });
                if (!result.success) {
                    console.warn('ä¿å­˜è®¾ç½®å¤±è´¥:', result.error);
                }
            };

            const audioRef = useRef(new Audio(ASSETS.audio.bgm));
            const timerRef = useRef(null);
            const autoTimerRef = useRef(null);

            // çŠ¶æ€å†å²æ ˆ (ç”¨äºå›é€€åŠŸèƒ½)
            const [stateHistory, setStateHistory] = useState([]);

            // æ’­æ”¾ BGM
            useEffect(() => {
                const audio = audioRef.current;
                audio.loop = true;
                audio.volume = 0.4;
                // Init: ensure pause
                audio.pause();
                return () => { audio.pause(); };
            }, []);

            const toggleAudio = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const nextState = !audioEnabled;
                setAudioEnabled(nextState);

                const audio = audioRef.current;
                if (nextState) {
                    // Mobile: Play directly in user event
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("Audio play failed / blocked:", error);
                            setAudioEnabled(false); // Revert state if blocked
                        });
                    }
                } else {
                    audio.pause();
                }
            };

            // Remove previous side-effect for BGM to avoid loop/freeze
            // useEffect(() => { ... }, [audioEnabled]); 

            // åœºæ™¯æ•°æ®è·å–
            const currentScene = SCENES[gameState.sceneId];
            const currentLine = currentScene?.lines ? currentScene.lines[gameState.lineIndex] : null;

            // æ‰“å­—æœºä¸Auto/Skipé€»è¾‘
            useEffect(() => {
                if (!currentLine) return;

                // è‡ªåŠ¨è§£é”å½“å‰ç« èŠ‚
                if (CHAPTERS_META[gameState.sceneId] && !unlockedChapters.has(gameState.sceneId)) {
                    const newUnlocked = new Set(unlockedChapters);
                    newUnlocked.add(gameState.sceneId);
                    setUnlockedChapters(newUnlocked);
                    Storage.set(CONSTANTS.STORAGE_KEYS.UNLOCKED_CHAPTERS, [...newUnlocked]);
                }


                const text = currentLine.text;
                const textIdHash = getTextId(gameState.sceneId, gameState.lineIndex, text);
                const textIdLegacy = `${gameState.sceneId}_${gameState.lineIndex}`;

                // åªè¦æœ‰ä¸€ç§åŒ¹é…å°±ç®—å·²è¯»
                const isCurrentTextRead = readTextIds.has(textIdHash) || readTextIds.has(textIdLegacy);

                if (isSkip && !isCurrentTextRead) {
                    setIsSkip(false);
                }

                // èƒŒæ™¯åˆ‡æ¢ (å·²ç§»è‡³ handleNext é¢„å¤„ç†)
                // if (currentLine.bg) {
                //     setGameState(prev => ({ ...prev, bg: currentLine.bg }));
                // }

                // éŸ³æ•ˆ
                if (currentLine.sound && audioEnabled && !isSkip) { // Skipæ—¶ä¸æ’­æ”¾éŸ³æ•ˆæˆ–ç”±æµè§ˆå™¨è‡ªåŠ¨å¤„ç†ï¼ˆå¯èƒ½ä¼šå †å ï¼Œè¿™é‡Œç®€å•å¤„ç†ä¸ºä¸æ’­æ”¾ï¼‰
                    const sfx = new Audio(currentLine.sound);
                    sfx.volume = 0.6;
                    sfx.play().catch(() => { });
                }

                // å±å¹•éœ‡åŠ¨
                if (currentLine.shake && !isSkip) {
                    setIsShaking(true);
                    setTimeout(() => setIsShaking(false), 600);
                }

                // æœ‰èŠ‚å¥çš„éœ‡åŠ¨ï¼ˆæŒç»­æ•´è¡Œæ–‡å­—ï¼‰
                if (currentLine.rhythm && !isSkip) {
                    setIsRhythm(true);
                } else {
                    setIsRhythm(false);
                }

                // Visual Effects Triggers
                if (currentLine.energy && !isSkip) {
                    setIsEnergy(true);
                } else {
                    setIsEnergy(false);
                }

                if (currentLine.climax && !isSkip) {
                    setIsClimax(true);
                } else {
                    setIsClimax(false);
                }



                // å¦‚æœæ˜¯Skipæ¨¡å¼ä¸”æ–‡æœ¬å·²è¯»ï¼Œç›´æ¥æ˜¾ç¤ºå…¨éƒ¨
                if (isSkip && isCurrentTextRead) {
                    setTypingText(text);
                    setIsTyping(false);

                    // æçŸ­å»¶è¿Ÿåè·³è½¬
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                    autoTimerRef.current = setTimeout(() => {
                        handleNext(true); // true è¡¨ç¤ºè‡ªåŠ¨è§¦å‘
                    }, 100);
                    return;
                }

                setTypingText('');
                setIsTyping(true);
                let idx = 0;

                if (timerRef.current) clearInterval(timerRef.current);

                // æ­£å¸¸æ‰“å­— - ä½¿ç”¨ textSpeed å˜é‡
                timerRef.current = setInterval(() => {
                    if (idx < text.length) {
                        setTypingText(text.substring(0, idx + 1));
                        idx++;
                    } else {
                        setIsTyping(false);
                        clearInterval(timerRef.current);
                        // æ‰“å­—å®Œæˆï¼Œç«‹å³æ ‡è®°ä¸ºå·²è¯»
                        markTextAsRead(textIdHash);
                    }
                }, textSpeed);

                return () => {
                    clearInterval(timerRef.current);
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                };
            }, [gameState.lineIndex, gameState.sceneId, isSkip]); // ç§»é™¤ readTextIds å’Œ audioEnabled ä»¥é˜²æ­¢æ‰“å­—ä¸­é€”é‡ç½®

            // Auto Mode ç›‘å¬
            useEffect(() => {
                if (isAuto && !isTyping && !isSkip && currentScene?.lines) {
                    // è®¡ç®—é˜…è¯»æ—¶é—´ï¼šåŸºç¡€0.5ç§’ + æ¯å­—80ms (å¤§å¹…åŠ å¿«)
                    const delay = 500 + (currentLine?.text?.length || 0) * 80;
                    if (autoTimerRef.current) clearTimeout(autoTimerRef.current);
                    autoTimerRef.current = setTimeout(() => {
                        handleNext(true);
                    }, delay);
                }
                return () => {
                    if (autoTimerRef.current && !isSkip) clearTimeout(autoTimerRef.current);
                };
            }, [isAuto, isTyping, gameState.lineIndex]); // ä¾èµ– lineIndex ç¡®ä¿æ¢è¡Œåé‡ç½®å®šæ—¶å™¨

            const prevGameState = useRef({ sceneId: 'start' });

            useEffect(() => {
                const currentSceneId = gameState.sceneId;
                if (currentSceneId === 'start') {
                    prevGameState.current = gameState;
                    return;
                }
                const prevState = prevGameState.current;
                const prevScene = SCENES[prevState.sceneId];
                const prevIsChoice = prevScene?.type === 'choice';
                const prevIsStart = prevState.sceneId === 'start';

                if (!prevIsStart && !prevIsChoice) {
                    Storage.set(CONSTANTS.STORAGE_KEYS.AUTO_SAVE, {
                        ...prevState,
                        timestamp: Date.now()
                    });
                }
                prevGameState.current = gameState;
            }, [gameState]);


            // --- New Save/Load Logic ---
            const getAllSaves = () => {
                const saves = {};
                const prefix = CONSTANTS.STORAGE_KEYS.SAVE_SLOT_PREFIX;
                for (let i = 1; i <= 12; i++) {
                    const data = Storage.get(`${prefix}${i}`);
                    if (data) saves[i] = data;
                }
                return saves;
            };

            const handleSaveSlot = async (slotId) => {
                try {
                    const prefix = CONSTANTS.STORAGE_KEYS.SAVE_SLOT_PREFIX;
                    const existingData = Storage.get(`${prefix}${slotId}`);
                    // Improve prompt logic
                    const promptMsg = existingData
                        ? `æ˜¯å¦è¦†ç›– å­˜æ¡£ ${slotId} ?`
                        : `æ˜¯å¦åœ¨ å­˜æ¡£ ${slotId} åˆ›å»ºæ–°å­˜æ¡£?`;

                    if (await showConfirm(promptMsg)) {
                        const saveData = {
                            ...gameState,
                            timestamp: Date.now(),
                            previewText: currentLine?.text || 'å‰§æƒ…ç‰‡æ®µ',
                            speaker: currentLine?.speaker || 'æ—ç™½'
                        };
                        const result = Storage.set(`${prefix}${slotId}`, saveData);
                        if (result.success) {
                            setRefreshSaves(prev => prev + 1);
                            await showAlert(`å­˜æ¡£ ${slotId} ä¿å­˜æˆåŠŸ`);
                        } else {
                            await showAlert(`å­˜æ¡£ ${slotId} ä¿å­˜å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                    }
                } catch (err) {
                    console.error('Save Error:', err);
                    await showAlert(`ä¿å­˜è¿‡ç¨‹å‘ç”Ÿé”™è¯¯: ${err.message}`);
                }
            };

            const handleLoadSlot = async (slotId) => {
                const prefix = CONSTANTS.STORAGE_KEYS.SAVE_SLOT_PREFIX;
                const data = Storage.get(`${prefix}${slotId}`);
                if (data) {
                    if (await showConfirm(`è¯»å–å­˜æ¡£ ${slotId} ?\nå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚`)) {
                        setGameState(data);
                        setIsSaveLoadOpen(false);
                        setIsMenuOpen(false);
                        setIsHistoryOpen(false);
                        setIsAuto(false);
                        setIsSkip(false);
                    }
                }
            };

            const handleDeleteSlot = async (slotId) => {
                if (await showConfirm(`ç¡®è®¤åˆ é™¤å­˜æ¡£ ${slotId} ?`)) {
                    const prefix = CONSTANTS.STORAGE_KEYS.SAVE_SLOT_PREFIX;
                    const success = Storage.remove(`${prefix}${slotId}`);
                    if (success) {
                        setRefreshSaves(prev => prev + 1);
                    }
                }
            };

            const loadAutoSave = async () => {
                const data = Storage.get(CONSTANTS.STORAGE_KEYS.AUTO_SAVE);
                if (data) {
                    setGameState(data);
                } else {
                    await showAlert('æ²¡æœ‰æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£');
                }
            };

            // --- Navigation Logic ---
            const handleNext = (isAutoTrigger = false) => {
                // æ ‡è®°å½“å‰æ–‡æœ¬ä¸ºå·²è¯»
                const text = currentLine?.text;
                const textId = getTextId(gameState.sceneId, gameState.lineIndex, text);
                markTextAsRead(textId);

                // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»
                if (!isAutoTrigger) {
                    // å¦‚æœæ­£åœ¨Skipï¼Œåœæ­¢Skip
                    if (isSkip) setIsSkip(false);
                    // å¦‚æœæ­£åœ¨Autoï¼Œåœæ­¢Auto
                    if (isAuto) setIsAuto(false);

                    if (isTyping) {
                        clearInterval(timerRef.current);
                        setTypingText(currentLine.text);
                        setIsTyping(false);
                        return;
                    }
                }

                if (currentScene.lines) {
                    // å¦‚æœå½“å‰è¡Œæœ‰å†…è”é€‰æ‹©ï¼Œä¸ç»§ç»­å‰è¿›ï¼ˆç”± ChoiceScreen å¤„ç†ï¼‰
                    if (currentLine?.choice && Array.isArray(currentLine.choice)) {
                        return;
                    }

                    // è®°å½•å†å²
                    const newHistoryItem = { speaker: currentLine.speaker, text: currentLine.text };

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²æ ˆ (ç”¨äºå›é€€)
                    setStateHistory(prev => [...prev.slice(-50), { ...gameState }]); // æœ€å¤šä¿å­˜50æ¡

                    if (gameState.lineIndex < currentScene.lines.length - 1) {
                        setGameState(prev => {
                            const nextLine = currentScene.lines[prev.lineIndex + 1];
                            return {
                                ...prev,
                                lineIndex: prev.lineIndex + 1,
                                bg: nextLine.bg || prev.bg, // ç«‹å³æ›´æ–°èƒŒæ™¯
                                history: [...prev.history, newHistoryItem]
                            };
                        });
                    } else {
                        // ç« èŠ‚ç»“æŸ
                        if (currentScene.next) {
                            // æ£€æŸ¥ä¸‹ä¸€ç« æ˜¯å¦æ˜¯Endingæˆ–Choice
                            const nextScene = SCENES[currentScene.next];
                            // ä¿å­˜æœ¬ç« æœ€åä¸€å¥åˆ°å†å²
                            setGameState(prev => {
                                const nextBg = nextScene.type === 'choice' ? prev.bg : (nextScene.lines?.[0]?.bg || prev.bg);
                                const nextHistory = [...prev.history, newHistoryItem];
                                return {
                                    sceneId: currentScene.next,
                                    lineIndex: 0,
                                    bg: nextBg,
                                    history: nextHistory
                                };
                            });
                        }
                    }
                }
            };

            // å›é€€åˆ°ä¸Šä¸€å¥
            const handleBack = () => {
                if (stateHistory.length === 0) return;

                // åœæ­¢è‡ªåŠ¨/å¿«è¿›æ¨¡å¼
                setIsAuto(false);
                setIsSkip(false);

                // å–å‡ºä¸Šä¸€ä¸ªçŠ¶æ€
                const prevState = stateHistory[stateHistory.length - 1];
                setStateHistory(prev => prev.slice(0, -1));
                setGameState(prevState);
            };

            const handleChoice = (option) => {
                // é€‰é¡¹è¢«ç‚¹å‡»æ—¶ï¼Œåœæ­¢ Auto/Skip
                setIsAuto(false);
                setIsSkip(false);

                // æ”¯æŒä¸¤ç§æ ¼å¼: {text, next} å’Œ {label, target}
                const nextId = option.next || option.target;
                const nextScene = SCENES[nextId];
                setGameState(prev => ({
                    sceneId: nextId,
                    lineIndex: 0,
                    bg: nextScene?.lines?.[0]?.bg || prev.bg,
                    history: prev.history // å†å²è®°å½•ä¿ç•™
                }));
            };

            const renderContent = () => {
                if (gameState.sceneId === 'start') {
                    return html`<${StartScreen} 
                        onStart=${() => {
                            setGameState({ sceneId: 'chapter1', lineIndex: 0, bg: ASSETS.bg.bamboo_night, history: [] });
                            setStateHistory([]); // æ¸…ç©ºå›é€€å†å²
                        }} 
                        onLoad=${(type) => {
                            if (type === 'manual') {
                                setSaveLoadMode('load');
                                setIsSaveLoadOpen(true);
                            } else {
                                loadAutoSave();
                            }
                        }}
                        hasAutoSave=${!!Storage.get(CONSTANTS.STORAGE_KEYS.AUTO_SAVE)}
                        onEndings=${() => setIsEndingsOpen(true)}
                        onChapters=${() => setIsChaptersOpen(true)}
                        unlockedEndingsCount=${unlockedEndings.size}
                        unlockedChaptersCount=${unlockedChapters.size}
                        totalChapters=${TOTAL_CHAPTERS}
                    />`;
                }

                if (currentScene?.type === 'choice') {
                    // Choiceæ—¶ åœæ­¢ Auto/Skip (åŒé‡ä¿é™©)
                    if (isAuto) setIsAuto(false);
                    if (isSkip) setIsSkip(false);
                    return html`<${ChoiceScreen} question=${currentScene.question} options=${currentScene.options} onChoice=${handleChoice} />`;
                }

                // æ”¯æŒå†…è” choice æ•°ç»„æ ¼å¼ (æ¥è‡ªä¼ªä»£ç : choice: [{label, target}])
                if (currentLine?.choice && Array.isArray(currentLine.choice)) {
                    // åœæ­¢ Auto/Skip
                    if (isAuto) setIsAuto(false);
                    if (isSkip) setIsSkip(false);
                    // å°† {label, target} æ ¼å¼è½¬æ¢ä¸º {text, next} æ ¼å¼
                    const convertedOptions = currentLine.choice.map(opt => ({
                        text: opt.label || opt.text,
                        next: opt.target || opt.next
                    }));
                    return html`<${ChoiceScreen} question=${currentLine.text || "è¯·é€‰æ‹©"} options=${convertedOptions} onChoice=${handleChoice} />`;
                }

                if (currentScene?.type === 'ending') {
                    // åªæœ‰æ²¡æœ‰ next çš„æ‰ç®—çœŸæ­£ç»“å±€ï¼Œéœ€è¦è§£é”
                    if (!currentScene.next && !unlockedEndings.has(gameState.sceneId)) {
                        const newUnlocked = new Set(unlockedEndings);
                        newUnlocked.add(gameState.sceneId);
                        setUnlockedEndings(newUnlocked);
                        Storage.set(CONSTANTS.STORAGE_KEYS.UNLOCKED_ENDINGS, [...newUnlocked]);
                    }

                    // æ¸²æŸ“è¿‡åœº/ç»“å±€ç”»é¢
                    return html`
                        <div class="absolute inset-0 flex items-center justify-center bg-black/80 z-40 p-2 md:p-8 text-center animate-in fade-in duration-1000">
                             <div class="ending-container-mobile-landscape max-w-3xl w-full h-full flex flex-col items-center justify-center relative">
                                <h1 class="ending-title-mobile-landscape text-3xl md:text-5xl font-calligraphy text-amber-500 mb-2 md:mb-6 tracking-widest drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] shrink-0">${currentScene.title}</h1>
                                ${currentScene.subtitle && html`<h2 class="text-xl md:text-3xl font-serif-sc text-slate-300 mb-4 md:mb-8 tracking-wider">${currentScene.subtitle}</h2>`}
                                ${currentScene.text && html`<p class="ending-text-mobile-landscape text-slate-300 text-sm md:text-xl leading-relaxed text-left mx-auto mb-4 md:mb-10 font-serif-sc p-4 md:p-6 bg-slate-900/50 rounded-lg border border-slate-700/50 overflow-y-auto">${currentScene.text}</p>`}
                                ${currentScene.next ? html`
                                    <button onClick=${() => {
                                const nextScene = SCENES[currentScene.next];
                                setGameState(prev => ({
                                    sceneId: currentScene.next,
                                    lineIndex: 0,
                                    bg: nextScene?.lines?.[0]?.bg || nextScene?.bg || prev.bg,
                                    history: prev.history
                                }));
                            }} class="ending-btn-mobile-landscape px-6 py-2 md:px-10 md:py-3 bg-gradient-to-r from-cyan-800 to-cyan-700 hover:from-cyan-700 hover:to-cyan-600 border border-cyan-500 text-slate-100 rounded text-base md:text-xl font-serif-sc tracking-widest shadow-lg transition-transform hover:scale-105 shrink-0">
                                        ç»§ç»­
                                    </button>
                                ` : html`
                                    <button onClick=${() => {
                                setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.start, history: [] });
                                setIsAuto(false);
                                setIsSkip(false);
                                setStateHistory([]);
                            }} class="ending-btn-mobile-landscape px-6 py-2 md:px-10 md:py-3 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 border border-slate-500 text-slate-100 rounded text-base md:text-xl font-serif-sc tracking-widest shadow-lg transition-transform hover:scale-105 shrink-0">
                                        è¿”å›æ ‡é¢˜
                                    </button>
                                `}
                             </div>
                        </div>
                     `;
                }

                const speaker = currentLine?.speaker;
                const isSQQ = speaker === 'æ²ˆæ¸…ç§‹';
                const isYQY = speaker === 'å²³æ¸…æº' || speaker === 'å¿ƒé­”å²³æ¸…æº';
                const isSystem = speaker === 'ç³»ç»Ÿ';
                const isNarrative = !speaker || speaker === 'æ—ç™½';

                return html`
                    <div class="absolute inset-0 z-10 flex items-end justify-center pointer-events-none">
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-[800ms] cubic-bezier(0.34, 1.56, 0.64, 1) ${isYQY ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            <img src=${ASSETS.char.yqy} class="char-sprite absolute bottom-0 left-1/2 md:left-[40%] -translate-x-1/2 h-[85%] object-contain object-bottom" />
                        </div>
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-[800ms] cubic-bezier(0.34, 1.56, 0.64, 1) ${isSystem ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            <img src=${ASSETS.char.system} class="char-sprite absolute bottom-0 left-1/2 -translate-x-1/2 h-[85%] object-contain object-bottom" />
                        </div>
                        <div class="w-1/2 h-full max-w-[500px] relative transition-all duration-[800ms] cubic-bezier(0.34, 1.56, 0.64, 1) ${isSQQ ? 'translate-y-0 opacity-100 scale-105 z-20' : 'translate-y-4 opacity-0 scale-95 z-10'}">
                            ${(() => {
                        // æ²ˆæ¸…ç§‹ç«‹ç»˜æ˜ å°„é€»è¾‘ (5å¼ å›¾ç‰ˆæœ¬)
                        // è¯´è¯æ—¶æ˜¾ç¤ºmoodå¯¹åº”ç«‹ç»˜ï¼Œåˆ‡æ¢æ—¶å…ˆæ˜¾ç¤ºneutralå†æ·¡å‡º
                        if (isSQQ) {
                            const mood = currentLine?.mood || 'neutral';
                            let spriteSrc = ASSETS.char.sqq.v1; // é»˜è®¤ï¼šæ­£å¸¸

                            if (['neutral', 'angry', 'shocked'].includes(mood)) {
                                spriteSrc = ASSETS.char.sqq.v1; // 1. æ™®é€š
                            } else if (['sorrow'].includes(mood)) {
                                spriteSrc = ASSETS.char.sqq.v2; // 2. é—­çœ¼
                            } else if (['flush'].includes(mood)) {
                                spriteSrc = ASSETS.char.sqq.v5; // 5. ä¾§è§†è„¸çº¢
                            } else if (['worried', 'curious', 'perplexed', 'disdain'].includes(mood)) {
                                spriteSrc = ASSETS.char.sqq.v4; // 4. çœ‹å‘æ—è¾¹
                            }
                            // v3 (é—­çœ¼è„¸çº¢) ç›®å‰æš‚æœªä½¿ç”¨
                            sqqç«‹ç»˜ç¼“å­˜.current = spriteSrc;
                        } else {
                            // åˆ‡æ¢åˆ°å…¶ä»–è¯´è¯äººæ—¶ï¼Œå°†ç«‹ç»˜æ”¹ä¸ºneutralè¡¨æƒ…å†æ·¡å‡º
                            sqqç«‹ç»˜ç¼“å­˜.current = ASSETS.char.sqq.v1;
                        }

                        return html`<img src=${sqqç«‹ç»˜ç¼“å­˜.current} class="char-sprite absolute bottom-0 left-1/2 md:left-[60%] -translate-x-1/2 h-[85%] object-contain object-bottom" />`;
                    })()}
                        </div>
                    </div>

                    <div class="absolute bottom-0 w-full z-30 pb-0">
                        <${DialogueBox} 
                            speaker=${speaker} 
                            text=${currentLine?.text} 
                            typingText=${typingText}
                            isTyping=${isTyping}
                            onNext=${() => handleNext(false)} 
                            isNarrative=${isNarrative}
                            onLog=${() => setIsHistoryOpen(true)}
                            onAuto=${() => { setIsAuto(!isAuto); setIsSkip(false); }}
                            onSkip=${async () => {
                        // åªè¦æœ‰ä¸€ç§åŒ¹é…å°±ç®—å·²è¯»
                        const text = currentLine?.text;
                        const textIdHash = getTextId(gameState.sceneId, gameState.lineIndex, text);
                        const textIdLegacy = `${gameState.sceneId}_${gameState.lineIndex}`;
                        const canSkip = readTextIds.has(textIdHash) || readTextIds.has(textIdLegacy);

                        if (!isSkip && !canSkip) {
                            await showAlert('åªèƒ½å¿«è¿›å·²è¯»è¿‡çš„å‰§æƒ…å“¦ï¼');
                            return;
                        }
                        setIsSkip(!isSkip);
                        setIsAuto(false);
                    }}
                            onBack=${handleBack}
                            canGoBack=${stateHistory.length > 0}
                            isAuto=${isAuto}
                            isSkip=${isSkip}
                        />
                    </div>

                    <!-- é¡¶éƒ¨èœå•æŒ‰é’® (æ‰‹æœºç«¯ä»…å›¾æ ‡) -->
                    <button onClick=${() => setIsMenuOpen(true)} class="absolute top-2 left-2 md:top-4 md:left-4 z-40 p-2 md:px-4 md:py-2 bg-slate-900/80 rounded-full hover:bg-slate-800 text-cyan-500 backdrop-blur border border-cyan-500/30 flex items-center gap-2 shadow-lg transition-all group highlight-none">
                        <${Icons.Menu} size=${18} />
                        <span class="menu-label font-bold text-sm group-hover:text-cyan-300 hidden md:inline">èœå•</span>
                    </button>
                `;
            };

            return html`
                <div class="w-full h-full bg-black flex items-center justify-center overflow-hidden relative">
                    ${isLoading ? html`<${Preloader} onLoadComplete=${() => setIsLoading(false)} />` : null}
                    
                    <div class="${`relative shadow-2xl bg-slate-900 overflow-hidden m-auto group/game flex-shrink-0 ${isShaking ? 'screen-shake' : ''} ${isRhythm ? 'screen-rhythm' : ''}`}" 
                         style="width: min(100%, 177.78dvh); aspect-ratio: 16/9;">
                        
                        <${BackgroundLayer} src=${gameState.bg} />
                        <${VisualEffects} isEnergy=${isEnergy} isClimax=${isClimax} />

                        ${renderContent()}

                        <button onClick=${toggleAudio} class="volume-btn-mobile absolute top-2 right-2 md:top-4 md:right-4 z-[60] p-2 md:p-3 text-cyan-500 hover:text-cyan-300 transition-all drop-shadow-lg hover:scale-110 active:scale-95" title="éŸ³ä¹å¼€å…³">
                             ${audioEnabled ? html`<${Icons.Volume2} size=${24} class="md:w-8 md:h-8 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />` : html`<${Icons.VolumeX} size=${24} class="md:w-8 md:h-8 text-slate-500 filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" />`}
                        </button>

                        ${isMenuOpen && html`<${Menu}  
                            onClose=${() => setIsMenuOpen(false)} 
                            onOpenSave=${() => { setSaveLoadMode('save'); setIsSaveLoadOpen(true); }}
                            onOpenLoad=${() => { setSaveLoadMode('load'); setIsSaveLoadOpen(true); }}
                            onOpenSettings=${() => { setIsSettingsOpen(true); setIsMenuOpen(false); }}
                            onBackTitle=${() => {
                        setTypingText('');
                        setIsTyping(false);
                        setIsAuto(false);
                        setIsSkip(false);
                        setIsMenuOpen(false);
                        setStateHistory([]);
                        // Slight delay to allow UI to clear before finding scene 'start'
                        setTimeout(() => {
                            setGameState({ sceneId: 'start', lineIndex: 0, bg: ASSETS.bg.start, history: [] });
                        }, 0);
                    }}
                        />`}

                        ${isHistoryOpen && html`<${HistoryModal}
                            history=${gameState.history}
                            onClose=${() => setIsHistoryOpen(false)}
                        />`}

                        ${isSaveLoadOpen && html`<${SaveLoadScreen} 
                            mode=${saveLoadMode}
                            saves=${getAllSaves()}
                            onClose=${() => setIsSaveLoadOpen(false)}
                            onSave=${handleSaveSlot}
                            onLoad=${handleLoadSlot}
                            onDelete=${handleDeleteSlot}
                        />`}

                        ${isSettingsOpen && html`<${SettingsScreen}
                            textSpeed=${textSpeed}
                            onTextSpeedChange=${handleTextSpeedChange}
                            onClose=${() => setIsSettingsOpen(false)}
                        />`}

                        ${isEndingsOpen && html`<${EndingsScreen}
                            unlockedEndings=${unlockedEndings}
                            onClose=${() => setIsEndingsOpen(false)}
                            onSelectEnding=${(endingId) => {
                        const ending = SCENES[endingId];
                        if (ending) {
                            setGameState({
                                sceneId: endingId,
                                lineIndex: 0,
                                bg: ending.bg || ASSETS.bg.bamboo,
                                history: []
                            });
                            setStateHistory([]);
                            setIsEndingsOpen(false);
                        }
                    }}
                        />`}

                        ${isChaptersOpen && html`<${ChaptersScreen}
                            unlockedChapters=${unlockedChapters}
                            onClose=${() => setIsChaptersOpen(false)}
                            onSelectChapter=${(chapterId) => {
                        const chapter = SCENES[chapterId];
                        if (chapter) {
                            setGameState({
                                sceneId: chapterId,
                                lineIndex: 0,
                                bg: chapter.lines?.[0]?.bg || ASSETS.bg.qiancao,
                                history: []
                            });
                            setStateHistory([]);
                            setIsChaptersOpen(false);
                        }
                    }}
                        />`}

                        ${dialogState && dialogState.type === 'alert' && html`
                            <${AlertDialog} 
                                message=${dialogState.message} 
                                onClose=${dialogState.onClose} 
                            />
                        `}

                        ${dialogState && dialogState.type === 'confirm' && html`
                            <${ConfirmDialog} 
                                message=${dialogState.message} 
                                onConfirm=${dialogState.onConfirm}
                                onCancel=${dialogState.onCancel}
                            />
                        `}
                    </div>
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app-root'));
    </script>
</body>

</html>